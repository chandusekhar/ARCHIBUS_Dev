function zoomCluster(){var h,g,b,e,d;function a(q,u){var s=[],l=0;nextPosition:for(var p=0,k=q.length;p<k;++p){var r=q[p];for(var o=0;o<l;++o){var t=s[o];if(h(r,t)<u){t.children.push(r);continue nextPosition}}s.push(new f(r));++l}return s}function f(i){this.children=[i];this.x=i.x;this.y=i.y}function c(k){var j=[];k.each(function(){var n=this.transform.baseVal.getItem(0).matrix;j.push({x:n.e,y:n.f,node:this})});var l=k.node(),i=d3.select(l?l.ownerSVGElement:null);return m;function m(r){var q=a(j,g(r));k.style("display","none");i.selectAll(".cluster").remove();for(var o=0,t=q.length;o<t;++o){var s=q[o];if(s.children.length===1){d3.select(s.children[0].node).style("display",null)}else{var p=i.append("g").datum(s).attr("class","cluster "+d).attr("transform","translate("+s.x+","+s.y+")scale("+1/r+")");p.append("circle").classed({"cluster-circle":true}).attr("r",b(s.children.length));p.append("text").classed({"cluster-text":true}).style("font-size",e(s.children.length)).attr("text-anchor","middle").attr("dy",".3em").text(s.children.length)}}}}c.distance=function(i){return arguments.length?(h=i,c):h};c.minDistance=function(i){return arguments.length?(g=i,c):g};c.radius=function(i){return arguments.length?(b=d3.functor(i),c):b};c.fontSize=function(i){return arguments.length?(e=d3.functor(i),c):e};c.layerName=function(i){return arguments.length?(d=i,c):d};return c.radius(50.5)}var ClusterControl=Base.extend({layerName:"",svg:[],zoom:null,enabled:true,radius:[10.5,20.5],fontSize:[12,20],minClampScale:0.25,maxClampScale:0.75,constructor:function(a){this.config=a;Ext.apply(this,a);this.setSvg(d3.select("#"+this.divId+"-svg"))},distance:function(e,c){var f=e.x-c.x,d=e.y-c.y;return f*f+d*d},minDistance:function(a){return 25*25/(a*a)},clampScale:function(b,a,c){return c<b?b/c:c>a?a/c:1},clickHandler:function(a){},build:function(e,d){var c=this;var f=d3.scale.log().domain([1,10]).range(c.fontSize).clamp(true);var a=zoomCluster().distance(this.distance).minDistance(this.minDistance).radius(d3.scale.log().domain([1,10]).range(this.radius).clamp(true)).fontSize(function(g){return f(g)+"px"}).layerName(this.layerName);this.zoom=viewBoxZoom().on("zoomstart.cluster",function(){if(c.enabled){c.zoom.on("zoom.cluster",a(d3.select(this).selectAll("#"+e).selectAll("g")))}}).on("zoom.scale",function(g){}).on("zoomend.cluster",function(g){d3.select(this).selectAll("#"+e).selectAll("g").each(function(){var j=this.transform.baseVal,k=j.getItem(j.numberOfItems-1),i=c.clampScale(c.minClampScale,c.maxClampScale,g);if(k.type===SVGTransform.SVG_TRANSFORM_SCALE){k.setScale(i,i)}else{var h=this.ownerSVGElement.createSVGTransform();h.setScale(i,i);j.appendItem(h)}});d3.select(this).selectAll(".cluster").on("click",c.clickHandler);c.zoom.on("zoom.cluster",null)});var b=this.getSvg().style("cursor","move").call(c.zoom)},cluster:function(){this.build(this.layerName,this.config)},recluster:function(){this.getSvg().call(this.zoom)},getSvg:function(){return this.svg},setSvg:function(a){this.svg=a;this.cluster()},setEnabled:function(b){this.enabled=b;var a=this.getSvg();if(this.enabled===false){a.selectAll("#"+this.layerName).selectAll("g").style("display",null);a.selectAll(".cluster."+this.layerName).remove()}a.call(this.zoom)},getEnabled:function(){return this.enabled}});