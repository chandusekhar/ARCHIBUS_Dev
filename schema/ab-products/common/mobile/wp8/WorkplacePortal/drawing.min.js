function Base(){}Base.version="1.0.1";Base.prototype={extend:function(b,h){var g=Base.prototype.extend;if(arguments.length==2){var f=this[b];if((f instanceof Function)&&(h instanceof Function)&&f.valueOf()!=h.valueOf()&&/\binherit\b/.test(h)){var a=h;h=function(){var k=this.inherit;this.inherit=f;var i=a.apply(this,arguments);this.inherit=k;return i};h.valueOf=function(){return a};h.toString=function(){return String(a)}}return this[b]=h}else{if(b){var j={toSource:null};var d=["toString","valueOf"];if(Base._prototyping){d[2]="constructor"}for(var e=0;(c=d[e]);e++){if(b[c]!=j[c]){g.call(this,c,b[c])}}for(var c in b){if(!j[c]){g.call(this,c,b[c])}}}}return this},inherit:function(){}};Base.extend=function(b,f){var g=Base.prototype.extend;if(!b){b={}}if(b.constructor==Object){b.constructor=new Function}Base._prototyping=true;var e=new this;g.call(e,b);var d=e.constructor;e.constructor=this;delete Base._prototyping;var a=function(){if(!Base._prototyping){d.apply(this,arguments)}this.constructor=a};a.prototype=e;a.extend=this.extend;a.toString=function(){return String(d)};g.call(a,f);var c=d?a:e;if(c.init instanceof Function){c.init()}return c};var DrawingSvg=Base.extend({addOnsController:null,constructor:function(a,b){this.inherit(a,"html",b);this.divId=a;this.config=b},initAddOn:function(){if(this.config.addOnsConfig){this.addOnsController.setAddOns(this.config.addOnsConfig)}},getAddOn:function(a){return(this.addOnsController)?this.addOnsController.getAddOn(a):null},getDiv:function(a){return d3.select("#"+a)},getSvg:function(a){return d3.select("#"+a+"-svg")},getViewBox:function(a){var c=d3.select("#"+a+"-svg").attr("viewBox").split(" ");if(c.length===1){c=d3.select("#"+a+"-svg").attr("viewBox").split(",")}for(var b=0;b<c.length;b++){c[b]=Number(c[b])}return c},getAssetById:function(b){var a=this.getSvg(this.divId).node().getElementById(b);return d3.select(a)},addEventHandlers:function(a,d){for(var c=0;c<d.length;c++){var b=d[c];var e=true;if(b&&b.highlightOnly==false){e=b.highlightOnly}this.addEvent2Assets(a,b,e);this.addEvent2Labels(a,b,e)}},addEvent2Assets:function(b,c,e){var a=this.getClickEventName();var d=c.assetType+"-assets";if(b.isNativeAndroid()){d3.selectAll("#"+d).selectAll("*").filter(function(){return this.parentNode.id===d}).each(function(){b.addEvent2AssetAndroid(this,c,a,e)})}else{d3.selectAll("#"+d).selectAll("*").filter(function(){return this.parentNode.id===d}).each(function(){b.addEvent2Asset(this,c,a,e);b.addMouseEvents2Asset(this,e)})}},addMouseEvents2Asset:function(b,e){var c=d3.select(b);var a=c.node();var d=true;if(e){d=(c.attr("highlighted")==="true")}if(d){a.addEventListener("mouseover",function(f){f.stopPropagation();this.style.cursor="pointer"});a.addEventListener("mouseout",function(f){f.stopPropagation();this.style.cursor="all-scroll"})}},addEvent2HighlightedAssets:function(a,b){this.addEvent2Assets(a,b,true)},addEvent2Asset:function(h,b,e,f){var d=this;var c=d3.select(h);var i=h.id;var a=c.node();var g=true;if(f){g=(c.attr("highlighted")==="true")}if(g){a.addEventListener(e,function(j){j.stopPropagation();if(b.handler){d.addFeedback(i,c,b)}})}},addEvent2HighlightedAsset:function(c,d,b){var g=this;var e=d3.select(c);var f=c.id;var a=e.node();if(e.attr("highlighted")==="true"){a.addEventListener(b,function(h){h.stopPropagation();if(d.handler){g.addFeedback(f,e,d)}})}},addEvent2AssetAndroid:function(i,b,e,f){var d=this;var c=d3.select(i);var j=i.id;var a=c.node();var g=null;var h=true;if(f){h=(c.attr("highlighted")==="true")}if(h){a.addEventListener("touchstart",function(){g=null});a.addEventListener("touchmove",function(k){g=k.target});a.addEventListener("touchend",function(k){k.stopPropagation();if(k.touches&&k.touches.length>2){return}if(g&&k.target===g){return}if(b.handler){d.addFeedback(j,c,b)}})}},addEvent2HighlightedAssetAndroid:function(b,c,a){this.addEvent2AssetAndroid(b,c,a,true)},addFeedback:function(e,c,a){var d=this;var f=d3.select(c.node().cloneNode(true));var b=d.getCentroid(c);f.style("fill","#CCDEF1").style("stroke","steelblue").style("stroke-width","0.5%").style("opacity","1").transition().duration(100).ease("linear").style("fill","#CCDEF1").style("stroke","#005CB8").each("end",function(){d3.select(this).remove();a.handler(d.retrieveValidAssetId(e),d)});c.node().parentNode.appendChild(f.node())},retrieveValidAssetId:function(a){return a.replace(/___/g,"'").replace(/__/g," ")},retrieveValidSvgAssetId:function(a){return a.replace(/'/g,"___").replace(/ /g,"__")},addEvent2Labels:function(b,c,f){var a=this.getClickEventName();var d="l-"+c.assetType+"-";var e=d3.select("#"+c.assetType+"-labels");if(b.isNativeAndroid()){e.selectAll("g").each(function(){b.addEvent2LabelAndroid(this,d,c,a,f)})}else{e.selectAll("g").each(function(){b.addEvent2Label(this,d,c,a,f)})}},addEvent2HighlightedLabels:function(a,b){this.addEvent2Labels(a,b,true)},addEvent2Label:function(j,c,a,d,g){var b=this;var f=j.id;var h=d3.select(j);var e=h.node();var i=true;if(g){i=(h.attr("highlighted")==="true")}if(i){e.addEventListener(d,function(l){l.stopPropagation();if(a.handler){var m=f.substring(f.indexOf(c)+c.length);var k=b.getAssetById(m);if(k){b.addFeedback(m,k,a)}else{a.handler(b.retrieveValidAssetId(m))}}})}},addEvent2HighlightedLabel:function(b,d,c,a){this.addEvent2Label(b,d,c,a,true)},addEvent2LabelAndroid:function(k,c,a,d,g){var b=this;var f=k.id;var i=d3.select(k);var e=i.node();var h=null;var j=true;if(g){j=(i.attr("highlighted")==="true")}if(j){e.addEventListener("touchstart",function(){h=null});e.addEventListener("touchmove",function(l){h=l.target});e.addEventListener("touchend",function(m){m.stopPropagation();if(m.touches&&m.touches.length>2){return}if(h&&m.target===h){return}if(a.handler){var n=f.substring(f.indexOf(c)+c.length);var l=b.getAssetById(n);if(l){b.addFeedback(n,l,a)}else{a.handler(b.retrieveValidAssetId(n))}}})}},addEvent2HighlightedLabelAndroid:function(b,d,c,a){this.addEvent2LabelAndroid(b,d,c,a,true)},setDefaultViewIfNotExists:function(c){var a=c.getSvg(),b=d3.select("#"+c.divId+"-svg view[id=defaultView]");if(b[0][0]===null){a.append("view").attr("id","defaultView").attr("viewBox",a.attr("viewBox"))}},getClickEventName:function(){return"click"},stopPropagation:function(){d3.event.stopPropagation();d3.event.preventDefault()},disableLabelSelection:function(a){a.select("#asset-labels").classed({"no-selection":true});a.select("#text").classed({"no-selection":true})},zoomExtents:function(a){var b=this.getSvg(a),d=d3.select("#"+a+"-svg view[id=defaultView]");if(d[0][0]!==null){b.attr("viewBox",d.attr("viewBox"));var c=this.getAddOn("Cluster");if(c){b.call(c.zoom)}}},isZoomed:function(){var a=d3.select("#"+this.divId+" svg view[id=defaultView]");var b="";if(a[0][0]!==null){b=a.attr("viewBox")}var c=this.getViewBox(this.divId).join(" ");return(c!==b)},getImageBytes:function(d){var a="";var b=new ImageCapture();var c=this.divId;b.captureImage(c,false,function(e){a=e.substring(22);if(d){d(a);return}});return a},avg:function(b,a){return(Number(b)+Number(a))/2},difference:function(b,a){return(Number(b)-Number(a))},getCentroid:function(b){var a=this.getBBox(b);return(b.attr("x")&&b.attr("y"))?[b.attr("x"),b.attr("y")]:[a.x+a.width/2,a.y+a.height/2]},getBBox:function(a){var b=a.node();return b.getBBox()},createInfoBar:function(a,f,b,h){var e=document.createElement("div");e.id=a;e.className="info-bar";var c=document.createElement("div");c.id="close-button";c.className="close-button";e.appendChild(c);var g=("ontouchstart" in document.documentElement)?"touchstart":"click";c.addEventListener(g,function(){e.style.display="none"},false);var d=document.createElement("div");d.innerHTML=h;d.id=e.id+"_infoText";e.appendChild(d);var i=b.node();if(!f.empty()){i.insertBefore(e,f.node())}else{i.insertBefore(e,i.firstChild)}e.style.display="none";return e},findAssets:function(t,o,a){var r=this,s=r.getSvg(a.divId);if(s.empty()){return{bFound:false,message:"",ids:t}}var j=(o&&o.cssClass)?o.cssClass:"zoomed-asset-default",p=s.selectAll("#mirror").node().transform.baseVal.getItem(0).matrix.d,c=(o&&o.hasOwnProperty("zoomFactor"))?Number(o.zoomFactor):5,e="",u=true,n,i=[],z=[],A,l=null,k=null;var m=this.getViewBox(a.divId);Ext.each(t,function(E){A=r.retrieveValidSvgAssetId(E);n=r.getAssetById(A);if((n==="")||n.empty()){u=false;e+=" "+E}else{if(!n.select(".splotch").empty()){n.style("display","")}var y=r.getCentroid(n);if(!n.select(".marker").empty()){var x=d3.transform(n.attr("transform"));y=x.translate}l=Number(y[0]);k=Number(y[1]);if(l&&k){i.push(l);z.push(k);a.lastFoundElements.push(n);a.lastFoundClasses.push(n.attr("class"));a.lastFoundStyles.push(n.attr("style"));n.attr("class",n.attr("class")+" "+j);if(o&&o.removeStyle===true){n.attr("style","")}n.node().parentNode.appendChild(n.node())}}});var w,c;var C=r.getAddOn("Cluster");if(t.length===0){u=false;this.zoomExtents(a.divId)}else{if(t.length===1){if(!n.empty()){if(c==0){this.zoomExtents(a.divId)}else{var f=(!n.select(".splotch").empty())?n.select(".splotch").node().getBBox():r.getBBox(n);w=[c*f.width,c*f.height];m[0]=Math.round(l-(w[0]/2));m[1]=Math.round(p*k-(w[1]/2));m[2]=Math.round(w[0]);m[3]=Math.round(w[1]);s.transition().duration(600).attr("viewBox",m).each("end",function(){if(C){s.call(C.zoom)}})}}}else{if(a.lastFoundElements.length>0){if(c==0){this.zoomExtents(a.divId)}else{var b=Math.min.apply(Math,i);var B=Math.max.apply(Math,i);var q=Math.max.apply(Math,z);var g=Math.min.apply(Math,z);var v=r.getBBox(a.lastFoundElements[i.indexOf(b)]).width+r.getBBox(a.lastFoundElements[i.indexOf(B)]).width;var h=r.getBBox(a.lastFoundElements[z.indexOf(q)]).height+r.getBBox(a.lastFoundElements[z.indexOf(g)]).height;var d=Math.abs(Math.round(r.difference(b,B)));var D=Math.abs(Math.round(r.difference(q,g)));w=[(d+c*(v)),D+(c*h)];m[0]=Math.round(Math.round(r.avg(b,B))-(w[0]/2));m[1]=Math.round(p*Math.round(r.avg(q,g))-(w[1]/2));m[2]=Math.round(w[0]);m[3]=Math.round(w[1]);s.transition().duration(600).attr("viewBox",m).each("end",function(){if(C){s.call(C.zoom)}})}}}}return{bFound:u,message:e,ids:t}},clearFoundAssets:function(a){for(var b=a.lastFoundElements.length-1;b>=0;b--){var c=a.lastFoundElements.pop();c.attr("class",a.lastFoundClasses.pop());c.attr("style",a.lastFoundStyles.pop())}},createSvg:function(f,c,a){if(!f.select("#"+this.divId+"-svg").empty()){f.select("#"+this.divId+"-svg").remove()}var b=f.append("svg").attr("version","1.1").attr("xmlns","http://www.w3.org/2000/svg").attr("xmlns:xmlns:xlink","http://www.w3.org/1999/xlink").attr("width",c).attr("height",a).attr("id",this.divId+"-svg").attr("viewBox","0 0 "+c+" "+a);b.append("style");b.append("defs");var e=b.append("g").attr("id","viewer");var d=e.append("g").attr("id","mirror").attr("stroke-width","0.9%").attr("transform","scale(1, 1)");d.append("g").attr("id","background").attr("fill","none");d.append("g").attr("id","assets").attr("fill","none");return b},loadImage:function(d,b){var c=this;if(!d.select("#"+d.attr("id")+"-svg").empty()){d.select("#"+d.attr("id")+"-svg").remove()}var a=new Image();a.onload=function(){var e=c.createSvg(d,this.width,this.height);var f=e.select("#background").append("g");f.append("image").attr("id",d.node().id+"_image").attr("x",0).attr("y",0).attr("width","100%").attr("height","100%").attr("xlink:xlink:href",b).html(".")};a.src=b},isIE:function(){var a=navigator.userAgent.toLowerCase();return(a.indexOf("msie")!==-1)?parseInt(a.split("msie")[1]):false},isModernBrowser:function(){return(this.isIE()>9||!this.isIE())},isNativeAndroid:function(){var a=navigator.userAgent;var b=((a.indexOf("Mozilla/5.0")>-1&&a.indexOf("Android ")>-1&&a.indexOf("AppleWebKit")>-1)&&!(a.indexOf("Chrome")>-1));return b}});(function(){var g=(function(k){var h=-1,l=k.length,j=document.documentElement.style;while(++h<l){if(k[h]+"Transform" in j){return k[h].toLowerCase()}}})(["webkit","ms","Moz","O"]);var e=g?"-"+g.toLowerCase()+"-":"",f=g&&g+"Perspective" in document.documentElement.style;var b=c();this.viewBoxZoom=a;function a(){var j=d3.dispatch("zoomstart","zoom","zoomend");function h(k){k.each(i);if(b){k.style(e+"transform-origin","0 0").style(e+"backface-visibility","hidden")}}return d3.rebind(h,j,"on");function i(){var o=this,n=d3.select(o),r=d3.select(window),m=false,s=0,p=0,q=this.getScreenCTM().a,t=d3.behavior.zoom().on("zoomstart",function(){j.zoomstart.call(o)}).on("zoom",function(){if(m){if(b){n.style(e+"transform","translate3d("+Math.floor(d3.event.translate[0]-s*d3.event.scale)+"px,"+Math.floor(d3.event.translate[1]-p*d3.event.scale)+"px,0)scale3d("+d3.event.scale+","+d3.event.scale+",1)")}j.zoom.call(o,d3.event.scale*q)}else{n.call(u);j.zoom.call(o,q)}}).on("zoomend",function(){j.zoomend.call(o,q)});n.call(u);d3.select(this.parentNode).on("touchstart.viewboxzoom",l).on("mousedown.viewboxzoom",k).call(t).call(t.event);function l(){m=true;r.on("touchend.viewboxzoom",function(){var v={},x=d3.event.touches,y=d3.event.changedTouches;for(var w=0,z=y.length;w<z;++w){v[y[w].identifier]=w}for(var w=0,z=x.length;w<z;++w){if(!v[x[w].identifier]){return}}r.on("touchend.viewboxzoom",null);n.call(u)})}function k(){m=true;r.on("mouseup.viewboxzoom",function(){m=false;r.on("mouseup.viewboxzoom",null);n.call(u)})}function u(B){var D=t.translate(),E=t.scale(),z=B.attr("viewBox").split(/[\s,]/g).map(Number),C=B.node().clientWidth||+B.style("width").replace(/px$/,""),A=B.node().clientHeight||+B.style("height").replace(/px$/,""),y=z[2]/C,x=z[3]/A,v=Math.max(y,x);z[0]=z[0]-(D[0]-s)*v/E;z[1]=z[1]-(D[1]-p)*v/E;z[2]/=E;z[3]/=E;B.attr("viewBox",z);if(b){B.style(e+"transform","translate3d(0, 0, 0)")}s=x>y&&0.5*(C-E*z[2]/x);p=y>x&&0.5*(A-E*z[3]/y);t.translate([s,p]).scale(1);q*=E}}}function d(){var h=navigator.userAgent.toLowerCase();return(h.indexOf("msie")!=-1)?parseInt(h.split("msie")[1]):false}function c(){return(d()>9||!d())}})();var LayersPopup=Base.extend({_svg:null,_div:"",_containerId:"",_opts:{},_cols:-1,_rows:-1,create:function(b,f,a,d,e,c){this.setParameters(b,f,a,d,e,c);this.container=this.createPopup();return this.container},setParameters:function(b,f,a,d,e,c){this._svg=b;this._div=f.node();this._containerId=a;this._rows=d;this._cols=e;this._opts=c},createLayerPopup:function(b,e,a,d){d3.select("#"+a).remove();this.setParameters(b,e,a,-1,-1,d);var c=this.getLayerIds();this.create(b,e,a,c.length,2,d);this.insertTableContent(document.getElementById(this._containerId+"_table"));return this},show:function(a){document.getElementById(this._containerId).style.display=(a)?"":"none"},setText:function(b){var a=document.getElementById(this.container.id+"_infobartext");a.innerHTML=b},createPopup:function(){var a=document.createElement("div");a.id=this._containerId;a.className="layer-list";a.appendChild(this.createMinimizeButton());a.addEventListener("dblclick",function(c){c.stopPropagation()});var b=this.createTable(this._cols,this._rows);a.appendChild(b);this._div.insertBefore(a,this._svg.node());return a},createMinimizeButton:function(){var a=document.createElement("div");a.className="minimize-button";a.addEventListener("click",function(b){if(this.parentNode.style.height!=="13px"){this.parentNode.style.height=13+"px";this.parentNode.style.width=16+"px";this.parentNode.style.overflow="hidden";a.className="open-button"}else{this.parentNode.style.height="auto";this.parentNode.style.width="auto";this.parentNode.style.overflow="auto";a.className="minimize-button"}},false);return a},createTable:function(d,c){var b=document.createElement("table");b.id=this._containerId+"_table";this.tableId=b.id;var a=document.createElement("tbody");b.appendChild(a);this.createRows(a,d,c);return b},createRows:function(b,f,e){for(var c=0;c<e;c++){var d=document.createElement("tr");for(var a=0;a<f;a++){var g=document.createElement("td");g.className="column"+a;d.appendChild(g)}b.appendChild(d)}return b},insertTableContent:function(d){var c=this.getLayerIds();var f=d.tBodies[0].rows;var g=this;for(var a=0;a<c.length;a++){var h=f[a];var b=h.childNodes;var e=this.createCheckbox(c[a],this.checkboxEvent);b[0].appendChild(e);b[1].innerHTML=c[a]}},createCheckbox:function(d,a){var b=document.createElement("input");b.type="checkbox";b.checked=true;b.id="checkbox_"+d;var c=this;if(a.createDelegate){b.addEventListener("change",a.createDelegate(b,[b,c]),false)}else{b.addEventListener("change",Ext.bind(a,b,[b,c]),false)}return b},checkboxEvent:function(a,c){var b=(this.checked)?"":"none";c._svg.selectAll("#"+this.id.replace("checkbox_","")).style("display",b);c._svg.selectAll(".cluster."+this.id.replace("checkbox_","")).style("display",b)},getLayerIds:function(){var c=this._svg.selectAll("#background").node().id,e=this._svg.selectAll("#assets > g")[0],f=this._svg.selectAll("#asset-labels").node().childNodes,g=this._svg.selectAll("#redline");var d=[c];for(var b=0;b<f.length;b++){if(f[b].nodeName==="g"){d.push(f[b].id)}}for(var a=0;a<e.length;a++){d.push(e[a].id)}if(!g.empty()){d.push(g.node().id)}return d.sort()}},{});(function(e){e.z_DELETE_MESSAGE="Are you sure you want to delete this item?";e.z_EDIT_MESSAGE="Edit";e.edit=function(j){var i="click.placement-edit",k=("ontouchstart" in document.documentElement)?14:6.5;return function(m){m.on(i,l);m.on("touchend.placement-edit",l);function l(){if(d3.event.defaultPrevented){return}a();var H=this,p=H.getBBox(),G,n,F,O,E=H.ownerSVGElement||H;K();var B=d3.transform(d3.select(H).attr("transform")),y=B.translate,I=B.rotate,N=B.scale;var z=E.getScreenCTM().inverse().multiply(H.getScreenCTM());var q=E.createSVGPoint(),o=E.createSVGPoint(),B;F=o.x=(G=q.x=p.x)+p.width;O=o.y=(n=q.y=p.y)+p.height;q=q.matrixTransform(z);o=o.matrixTransform(z);if(q.x>o.x){B=q.x,q.x=o.x,o.x=B}if(q.y>o.y){B=q.y,q.y=o.y,o.y=B}var x=o.x-q.x,s=o.y-q.y;var C=p.width/2,M=p.height/2;halfSplotchX=-20,halfSplotchY=-20;splotchWidth=p.width;splotchHeight=p.height;var r=d3.select(H).select(".splotch");if(!r.empty()){halfSplotchX=r.attr("x"),halfSplotchY=r.attr("y");splotchWidth=r.attr("width");splotchHeight=r.attr("height")}gripImageScale=0.7;screenRatio=1/E.getScreenCTM().a,gripRadiusAuto=14*screenRatio;k=gripRadiusAuto;iconRatio=screenRatio*2;lineLength=5*k+C;d3.select(H).on(i,null);var L=d3.select(E).append("g").on("mousedown",a).on("touchstart",a).attr("class","edit").style("stroke-width","0.09%").attr("id",d3.select(H).attr("id")+"_grips").attr("transform","translate("+Math.round(y[0])+","+Math.round(y[1])+")rotate("+I+")");var J=L.insert("g","*").attr("class","delete").attr("transform","translate("+(p.width*N[0]+k)+", "+-k/2*N[1]+")").on("mousedown",a).on("touchstart",D).on(i,D);J.append("circle").style("stroke-width","0.09%").attr("r",k).attr("transform","translate("+[halfSplotchX*N[0],halfSplotchY*N[1]]+")");J.append("path").attr("d",f).attr("transform","translate("+[halfSplotchX*N[0],halfSplotchY*N[1]]+")translate("+(-6*iconRatio)+","+(-6*iconRatio)+")scale("+(0.4*iconRatio)+")");J=L.insert("g","*").attr("class","rotate").attr("transform","translate("+[halfSplotchX*N[0],halfSplotchY*N[1]]+")translate("+[p.width/2*N[0],p.height/2*N[1]]+")").on("mousedown",a).on("touchstart",function(){a();var w=L.append("g").attr("class","rotate-angle").attr("transform","translate("+[halfSplotchX*N[0],halfSplotchY*N[1]]+")translate("+C*N[0]+","+M*N[1]+")");w.append("line").attr("x1",k).attr("x2",lineLength);w.append("circle").attr("cx",lineLength).attr("r",k-1).style("stroke-width","0.09%").on("mousedown",t).on("touchstart",t);function t(){a();var S=this,T=d3.mouse(E),U=rotate.angle,R=100;if(d3.event.touches&&d3.event.touches.length){d3.select(window).on("touchmove.placement-rotate",Q).on("touchend.placement-rotate",P)}else{d3.select(window).on("mousemove.placement-rotate",Q).on("mouseup.placement-rotate",P)}function Q(){c();var W=d3.mouse(E),X=Math.atan2(R*(W[1]-T[1]),R*(R+W[0]-T[0]))*180/Math.PI,V=0.5*(G+F),Y=0.5*(n+O);L.attr("transform","translate("+Math.round(y[0])+","+Math.round(y[1])+")rotate("+Math.round(I+X)+")");d3.select(H).attr("transform","translate("+y[0]+","+y[1]+")rotate("+Math.round(X+I)+")scale("+N+")")}function P(){d3.select(window).on(".placement-rotate",null);v();if(j.moveEndHandler){j.moveEndHandler(j)}}}}).on(i,function(){a();var w=L.append("g").attr("class","rotate-angle").attr("transform","translate("+[halfSplotchX*N[0],halfSplotchY*N[1]]+")translate("+C*N[0]+","+M*N[1]+")");w.append("line").attr("x1",k).attr("x2",lineLength);w.append("circle").attr("cx",lineLength).attr("r",k).style("stroke-width","0.09%").on("mousedown",t).on("touchstart",t);function t(){a();var S=this,T=d3.mouse(E),U=I,R=100;if(d3.event.touches&&d3.event.touches.length){d3.select(window).on("touchmove.placement-rotate",Q).on("touchend.placement-rotate",P)}else{d3.select(window).on("mousemove.placement-rotate",Q).on("mouseup.placement-rotate",P)}function Q(){c();var W=d3.mouse(E),X=Math.atan2(R*(W[1]-T[1]),R*(R+W[0]-T[0]))*180/Math.PI,V=0.5*(G+F),Y=0.5*(n+O);L.attr("transform","translate("+Math.round(y[0])+","+Math.round(y[1])+")rotate("+Math.round(I+X)+")");d3.select(H).attr("transform","translate("+y[0]+","+y[1]+")rotate("+Math.round(X+I)+")scale("+N+")")}function P(){d3.select(window).on(".placement-rotate",null);v();if(j.moveEndHandler){j.moveEndHandler(j)}}}});J.append("circle").style("stroke-width","0.09%").attr("r",k);J.append("path").attr("d","M24.083,15.5c-0.009,4.739-3.844,8.574-8.583,8.583c-4.741-0.009-8.577-3.844-8.585-8.583c0.008-4.741,3.844-8.577,8.585-8.585c1.913,0,3.665,0.629,5.09,1.686l-1.782,1.783l8.429,2.256l-2.26-8.427l-1.89,1.89c-2.072-1.677-4.717-2.688-7.587-2.688C8.826,3.418,3.418,8.826,3.416,15.5C3.418,22.175,8.826,27.583,15.5,27.583S27.583,22.175,27.583,15.5H24.083z").attr("transform","translate("+(-6*iconRatio)+","+(-6*iconRatio)+")scale("+(0.4*iconRatio)+")");J=L.insert("g","*").attr("class","edit").attr("transform","translate("+[halfSplotchX*N[0],halfSplotchY*N[1]]+")translate("+(p.width*N[0]+k)+","+(p.height*N[1]+k/2)+")").on("mousedown",a).on("touchstart",A).on(i,A);J.append("circle").style("stroke-width","0.09%").attr("r",k);J.append("path").attr("d","M25.31,2.872l-3.384-2.127c-0.854-0.536-1.979-0.278-2.517,0.576l-1.334,2.123l6.474,4.066l1.335-2.122C26.42,4.533,26.164,3.407,25.31,2.872zM6.555,21.786l6.474,4.066L23.581,9.054l-6.477-4.067L6.555,21.786zM5.566,26.952l-0.143,3.819l3.379-1.787l3.14-1.658l-6.246-3.925L5.566,26.952z").attr("transform","translate("+(-4.5*iconRatio)+","+(-4.5*iconRatio)+")scale("+(0.3*iconRatio)+")");L.insert("rect","*").attr("x",halfSplotchX).attr("y",halfSplotchY).attr("width",p.width).attr("height",p.height).attr("transform","scale("+N+")");var u=d3.select(window).on("touchstart",v).on(i,v);function D(){a();var w=(j.beforeDeleteHandler)?j.beforeDeleteHandler():true;if(w==false){return}if(confirm(e.z_DELETE_MESSAGE)){if(j.deleteHandler){var P=d3.select(H).select("use");if(P.empty()){P=d3.select(H).select("image")}var R=j.deleteHandler();if(R){d3.select(H).remove();var Q=H.id.split("-assets_");var t=d3.select("#l-"+Q[0]+"-"+Q[1]);if(!t.empty()){t.remove()}v()}}else{d3.select(H).remove();v()}}}function A(){a();if(j.editHandler){var t=d3.select(H).select("use");if(t.empty()){t=d3.select(H).select("image")}j.editHandler()}else{alert(e.z_EDIT_MESSAGE)}v()}function v(){L.remove();d3.select(H).on(i,l);u.on(i,null)}function K(){d3.select(E).selectAll(".edit").each(function(){var t=this.id.replace("_grips","");if((H.id!==this.id)&&t!=""){d3.select("#"+t).on(i,l);d3.select(this).remove()}})}}}};function d(){var j=d3.event,i;while(i=j.sourceEvent){j=i}return j}function a(){d().stopPropagation()}function c(){d().preventDefault()}function h(j,i){return j[0]*i[1]-j[1]*i[0]}function b(j,i){return j[0]*i[0]+j[1]*i[1]}var f="M20.826,5.75l0.396,1.188c1.54,0.575,2.589,1.44,2.589,2.626c0,2.405-4.308,3.498-8.312,3.498c-4.003,0-8.311-1.093-8.311-3.498c0-1.272,1.21-2.174,2.938-2.746l0.388-1.165c-2.443,0.648-4.327,1.876-4.327,3.91v2.264c0,1.224,0.685,2.155,1.759,2.845l0.396,9.265c0,1.381,3.274,2.5,7.312,2.5c4.038,0,7.313-1.119,7.313-2.5l0.405-9.493c0.885-0.664,1.438-1.521,1.438-2.617V9.562C24.812,7.625,23.101,6.42,20.826,5.75zM11.093,24.127c-0.476-0.286-1.022-0.846-1.166-1.237c-1.007-2.76-0.73-4.921-0.529-7.509c0.747,0.28,1.58,0.491,2.45,0.642c-0.216,2.658-0.43,4.923,0.003,7.828C11.916,24.278,11.567,24.411,11.093,24.127zM17.219,24.329c-0.019,0.445-0.691,0.856-1.517,0.856c-0.828,0-1.498-0.413-1.517-0.858c-0.126-2.996-0.032-5.322,0.068-8.039c0.418,0.022,0.835,0.037,1.246,0.037c0.543,0,1.097-0.02,1.651-0.059C17.251,18.994,17.346,21.325,17.219,24.329zM21.476,22.892c-0.143,0.392-0.69,0.95-1.165,1.235c-0.474,0.284-0.817,0.151-0.754-0.276c0.437-2.93,0.214-5.209-0.005-7.897c0.881-0.174,1.708-0.417,2.44-0.731C22.194,17.883,22.503,20.076,21.476,22.892zM11.338,9.512c0.525,0.173,1.092-0.109,1.268-0.633h-0.002l0.771-2.316h4.56l0.771,2.316c0.14,0.419,0.53,0.685,0.949,0.685c0.104,0,0.211-0.017,0.316-0.052c0.524-0.175,0.808-0.742,0.633-1.265l-1.002-3.001c-0.136-0.407-0.518-0.683-0.945-0.683h-6.002c-0.428,0-0.812,0.275-0.948,0.683l-1,2.999C10.532,8.77,10.815,9.337,11.338,9.512z";var g="M-5,0H5 M0,-5V5 M-5,0l1,1 M-4,-1l-1,1l1,1 M4,-1l1,1l-1,1 M-1,-4l1,-1l1,1 M-1,4l1,1l1,-1"})(markerPlacement={});var MarkerControl=Base.extend({labelOffset:5,svg:[],z_DELETE_MESSAGE:"Are you sure you want to delete this item?",z_EDIT_MESSAGE:"Edit",constructor:function(a){this.config=a},addMarker:function(h){var c=this,b=c.getSvg();if(b.select("#"+h.layer).empty()){b.select("#assets").append("g").attr("id",h.layer)}var d=(h.rotate)?h.rotate:0;var f=b.select("#"+h.layer).append("g").classed("editable",true).attr("transform","translate("+h.x+","+h.y+")rotate("+d+")");if(h.id){f.attr("id",h.layer+"_"+h.id)}var a=this.consolidateSymbol(h.icon,h.width,h.height);var i=f.append("use").classed({marker:true}).attr("xlink:xlink:href","#"+a).attr("x",-h.width/2).attr("y",-h.height/2).attr("width",h.width).attr("height",h.height).text(".");h.image=i.node();var e=f.append("rect").classed({splotch:true}).attr("id","splotch_"+h.id).attr("width",Number(h.width)+2*this.labelOffset).attr("height",Number(h.height)+2*this.labelOffset).attr("x",-Number(h.width)/2-5).attr("y",-Number(h.height)/2-5);if(h.id){i.attr("id",h.id);if(h.label){c.setLabel(h)}}this.addMarkerEvents(h,f,i);return i.node()},addMarkerEvents:function(d,c,h){if(d.moveEndHandler){c.call(this.move(d))}var f={};if(d.moveEndHandler){var a=function(){d.image=h.node();var g=d3.transform(d3.select(h.node().parentNode).attr("transform"));rotate=(g.rotate)?g.rotate:0;d.rotate=rotate;return d.moveEndHandler(d)};f.moveEndHandler=a}if(d.clickHandler){var i=function(){d.clickHandler(h.node(),d)};f.editHandler=i;if(d.deleteHandler){var e=function(){return d.deleteHandler(h.node().id,d)};f.deleteHandler=e}if(d.beforeDeleteHandler){var b=function(){return d.beforeDeleteHandler(h.node().id,d)};f.beforeDeleteHandler=b}c.call(markerPlacement.edit(f))}},consolidateSymbol:function(g,f,b){var d=this;var c=d.getSvg();var e=c.select("defs").selectAll(".markersymbol image");var a=d.searchForExistingDef(e,g,f,b);if(a===null){a=c.attr("id")+"-MARKER"+e.size();c.select("defs").append("symbol").classed({markersymbol:true}).attr("id",a).attr("overflow","visible").append("image").attr("width",f).attr("height",b).attr("xlink:xlink:href",g)}return a},searchForExistingDef:function(c,e,d,a){var f=null;var b=this.getSvg();if(c.empty()){return null}c.each(function(){var h=d3.select(this);var g=h.attr("xlink:href");if(g===e&&Number(h.attr("width"))===Number(d)&&Number(h.attr("height"))===Number(a)){f=d3.select(h.node().parentNode).attr("id");return f}});return f},move:function(c){var b=this,a=b.getSvg();return d3.behavior.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation();c.originalX=c.x;c.originalY=c.y;c.originalRotate=c.rotate}).on("drag",function(){position=(d3.touch(a.node()))?d3.touch(a.node()):d3.mouse(a.node());var f=d3.transform(d3.select(this).attr("transform")),e=(f.rotate)?f.rotate:0,i=(f.scale)?f.scale:0;d3.select(this).attr("transform","translate("+Math.round(position[0])+","+Math.round(position[1])+")rotate("+e+")scale("+i+")");var g=c.layer.replace("-assets","");var k=a.select("#"+g+"-labels");var h=k.select("#l-"+g+"-"+c.id);if(!h.empty()){var j=Math.round(position[1]);var d=h.selectAll("text").size();if(d>1){j=Math.round(position[1])-(d*11)/d/2}h.attr("transform","translate("+(Math.round(position[0])+Number(c.width)/2+2*b.labelOffset)+","+j+")rotate(0)")}}).on("dragend",function(){if((typeof position!="undefined")&&c.moveEndHandler){var f=d3.transform(d3.select(this).attr("transform")),d=f.translate[0],g=f.translate[1],e=(f.rotate)?f.rotate:0;if(d!=c.x||g!=c.y||e!=c.rotate){c.x=d;c.y=g;c.rotate=e;c.image=d3.select(this).select("use").node();c.moveEndHandler(c)}}})},removeMarker:function(c){d3.select("#"+c).remove();var b=c.split("-assets_");var a=d3.select("#l-"+b[0]+"-"+b[1]);if(!a.empty()){a.remove()}},removeMarkers:function(b){var a=this.getSvg();a.select("#"+b).selectAll(".marker").each(function(){d3.select(this.parentNode.parentNode).remove()});a.selectAll(".cluster ."+b).each(function(){d3.select(this).remove()})},setLabel:function(k){var c=this.getSvg();var d=d3.select(k.image.parentNode);var l=k.layer.replace("-assets","");var f=k.label;var m=11;var a=f.text;var e=k.y;if(a.length>1){e=Number(k.y)-(a.length*m)/a.length/2}var h=d;for(var b=0;b<a.length;b++){var j=h.append("text").classed({"marker-label":true}).on("mouseover",function(){c.style("cursor","none");d3.select(this).style("font-size","2em")}).on("mouseout",function(){c.style("cursor","move");d3.select(this).style("font-size",null)}).attr("font-size",m+"px").attr("x",(Number(k.width/2)+2*this.labelOffset)).attr("y",0).text(a[b]);if(b>0){j.attr("y",m*b)}}return h},patchAssets:function(a){var b=this.getSvg().select("#"+a).selectAll("use");b.each(function(){var d=d3.select(this);var c=d.attr("x");var h=d.attr("y");if(d3.select(this.parentNode).attr("id")===a){var f=d3.select(this.parentNode).append("g").attr("id",a+"_"+d.attr("id")).attr("class","editable").append("g").attr("transform","translate("+c+","+h+")rotate(0)");f.node().appendChild(this);d.attr("x",null).attr("y",null);var e=f.node().getBBox();f.append("rect").attr("id",d.attr("id")+"_splotch").classed({splotch:true}).attr("x",e.x-5).attr("y",e.y-5).attr("width",e.width+2*this.labelOffset).attr("height",e.height+2*this.labelOffset)}})},returnToOriginalPosition:function(b,d,c,a){d3.select(b).transition().duration(200).ease("linear").each("end",function(){var g=d3.transform(d3.select(this).attr("transform")),f=(g.rotate)?g.rotate:0;var e="translate("+d+","+c+")rotate("+a+")";if(g.scale){e+=" scale("+g.scale+")"}d3.select(this).transition().attr("transform",e);var h=d3.select("#"+d3.select(b).attr("id")+"_grips");if(!h.empty()){h.transition().attr("transform","translate("+Math.round(d)+","+Math.round(c)+")rotate("+a+")")}})},placeMarker:function(c){var b=this,a=b.getSvg();d3.select(a.node().parentNode).on("touchstart.insertable",function(){b.placeMarkerHandler(a,c)},true).on("mousedown.insertable",function(){b.placeMarkerHandler(a,c)},true);a.style("cursor","crosshair")},placeMarkerHandler:function(e,f){var d=this;var b=e.node().createSVGPoint();var a=(d3.touch(e.node()))?d3.touch(e.node()):d3.mouse(e.node());f.x=Math.round(a[0]);f.y=Math.round(a[1]);var g=d.addMarker(f);var c=d3.select(window).on("touchstart.insertable",null).on("mousedown.insertable",null);d3.select(e.node().parentNode).on("touchstart.insertable",null).on("mousedown.insertable",null);e.style("cursor","default");if(f.handler){f.image=g;f.event=d3.event;f.handler(f)}},getSvg:function(){return this.svg},setSvg:function(a){this.svg=a},setTranslatableStrings:function(){markerPlacement.z_DELETE_MESSAGE=this.z_DELETE_MESSAGE;markerPlacement.z_EDIT_MESSAGE=this.z_EDIT_MESSAGE}});