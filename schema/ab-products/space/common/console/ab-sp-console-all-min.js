Ab.namespace("space.express.console");Ab.space.express.console.Assignment=Backbone.Model.extend({defaults:{type:"department"},getType:function(){return this.get("type");},equals:function(assignment){var result=false;switch(this.getType()){case"division":case"department":case"category":case"type":case"standard":result=(this.get("bl_id")===assignment.get("bl_id")&&this.get("fl_id")===assignment.get("fl_id")&&this.get("rm_id")===assignment.get("rm_id"));break;case"employee":result=(this.get("em_id")===assignment.get("em_id"));break;}return result;},equalsTarget:function(assignmentTarget){var result=false;switch(this.getType()){case"division":result=(this.get("to_dv_id")===assignmentTarget.dv_id);break;case"department":result=(this.get("to_dv_id")===assignmentTarget.dv_id&&this.get("to_dp_id")===assignmentTarget.dp_id);break;case"category":result=(this.get("to_rm_cat")===assignmentTarget.rm_cat);break;case"type":result=(this.get("to_rm_cat")===assignmentTarget.rm_cat&&this.get("to_rm_type")===assignmentTarget.rm_type);break;case"standard":result=(this.get("rm_std")===assignmentTarget.rm_std);break;}return result;}});Ab.space.express.console.Assignments=Backbone.Collection.extend({model:Ab.space.express.console.Assignment,getType:function(){return this.isEmpty()?"":this.at(0).getType();},findAssignment:function(assignment){assignment=this._prepareModel(assignment);return this.find(function(thisAssignment){return thisAssignment.equals(assignment);});},addAssignment:function(assignment){this.removeAssignment(assignment);this.add(assignment);},removeAssignment:function(assignment){this.remove(this.findAssignment(assignment));},getAssignmentByEmployee:function(assignment){assignment=this._prepareModel(assignment);return this.find(function(thisAssignment){if(thisAssignment.equals(assignment)){return thisAssignment;}});},createRestriction:function(){var restriction=new Ab.view.Restriction();switch(this.getType()){case"division":case"department":case"category":case"type":case"standard":this.each(function(assignment,index){var relOp="AND";if(index>0){relOp=")OR(";}restriction.addClause("rm.bl_id",assignment.get("bl_id"),"=",relOp);restriction.addClause("rm.fl_id",assignment.get("fl_id"),"=");restriction.addClause("rm.rm_id",assignment.get("rm_id"),"=");});break;case"employee":var em_ids=this.pluck("em_id");if(em_ids.length>0){restriction.addClause("em.em_id",em_ids,"IN");}else{restriction.addClause("em.em_id","","=");}break;}return restriction;}});Ab.space.express.console.Room=Backbone.Model.extend({equals:function(room){return(this.get("bl_id")===room.get("bl_id")&&this.get("fl_id")===room.get("fl_id")&&this.get("rm_id")===room.get("rm_id"));}});Ab.space.express.console.Rooms=Backbone.Collection.extend({model:Ab.space.express.console.Room,findRoom:function(room){room=this._prepareModel(room);return this.find(function(thisRoom){return thisRoom.equals(room);});},targetToArray:function(targetBlId,targetFlId){var rooms=[];this.each(function(room,index){if(targetBlId===room.get("bl_id")&&targetFlId===room.get("fl_id")){var roomArray=[];roomArray[0]=room.get("bl_id");roomArray[1]=room.get("fl_id");roomArray[2]=room.get("rm_id");rooms.push(roomArray);}});return rooms;},addRoom:function(room){this.add(room);},removeRoom:function(room){this.remove(this.findRoom(room));},createRestriction:function(){var restriction=new Ab.view.Restriction();this.each(function(room,index){var relOp="AND";if(index>0){relOp=")OR(";}restriction.addClause("rm.bl_id",room.get("bl_id"),"=",relOp);restriction.addClause("rm.fl_id",room.get("fl_id"),"=");restriction.addClause("rm.rm_id",room.get("rm_id"),"=");});return restriction;}});var spaceExpressConsoleAssignment=View.createController("spaceExpressConsoleAssignment",{mode:"",assignmentTarget:null,pendingAssignments:null,selectedRooms:null,roomCountArray:[],afterCreate:function(){this.clearAssignment();this.on("app:space:express:console:selectLocation",this.updateStatus);this.on("app:space:express:console:beginAssignment",this.beginAssignment);this.on("app:space:express:console:commitAssignment",this.commitAssignment);this.on("app:space:express:console:cancelAssignment",this.cancelAssignment);this.on("app:space:express:console:removeAssignment",this.removeAssignment);this.on("app:space:express:console:viewAssignment",this.viewAssignment);this.on("app:space:express:console:selectRoom",this.selectRoom);this.on("app:space:express:console:moveEmployee",this.moveEmployee);this.on("app:space:express:console:addEmployeeWaiting",this.addEmployeeWaiting);this.on("app:space:express:console:removeEmployeeWaiting",this.removeEmployeeWaiting);this.on("app:space:express:console:unassignEmployees",this.unassignEmployees);this.on("app:space:express:console:viewSelectedRooms",this.viewSelectedRooms);this.on("app:space:express:console:changeMode",this.afterChangeMode);this.on("app:space:express:console:cancelSelectedRooms",this.cancelSelectedRooms);this.on("app:space:express:console:changeAttributeTab",this.changeAssignTarget);this.on("app:space:express:console:updateEmployeeAssignment",this.updateEmployeeAssignment);},afterInitialDataFetch:function(){this.drawingPanel.getSidecar().load();var assignmentTarget=this.drawingPanel.getSidecar().get("assignmentTarget");if(assignmentTarget&&assignmentTarget!=null){this.beginAssignment(assignmentTarget);}var pendingAssignmentsValue=this.drawingPanel.getSidecar().get("pendingAssignments");if(pendingAssignmentsValue){this.setPendingAssignments(new Ab.space.express.console.Assignments(pendingAssignmentsValue));this.clearAssignment();this.updateStatus();}},afterChangeMode:function(mode){if(valueExists(mode)){this.mode=mode;}},setPendingAssignments:function(pendingAssignments){if(pendingAssignments){this.pendingAssignments=pendingAssignments;}else{this.pendingAssignments=new Ab.space.express.console.Assignments();}this.pendingAssignments.on("add",this.onPendingAssignmentsChanged,this);},onPendingAssignmentsChanged:function(){this.drawingPanel.getSidecar().set("assignmentTarget",this.assignmentTarget);this.drawingPanel.getSidecar().set("pendingAssignments",this.pendingAssignments);this.drawingPanel.getSidecar().save();},clearAssignment:function(){this.assignmentTarget=null;this.pendingAssignments=new Ab.space.express.console.Assignments();this.selectedRooms=new Ab.space.express.console.Rooms();this.setPendingAssignments();View.closePanelWindows();},beginAssignment:function(assignmentTarget){if(!this.assignmentTarget||this.assignmentTarget.type!=assignmentTarget.type){if(this.pendingAssignments.length>0){var warnMessage=getMessage("changeAssignTarget");var innerThis=this;View.confirm(warnMessage,function(button){if(button=="yes"){innerThis.clearAssignment();innerThis.trigger("app:space:express:console:filterDrawing");innerThis.trigger("app:space:express:console:afterBeginAssignment",assignmentTarget,this.pendingAssignments);innerThis.assignmentTarget=assignmentTarget;innerThis.updateStatus();}});}else{this.trigger("app:space:express:console:afterBeginAssignment",assignmentTarget,this.pendingAssignments);this.assignmentTarget=assignmentTarget;this.updateStatus();}}else{if(assignmentTarget!=null){if(assignmentTarget.type=="employee"){var employees=assignmentTarget.employees;if(employees.length==0&&this.pendingAssignments.length==0){this.assignmentTarget=null;this.trigger("app:space:express:console:afterClearAssignment");this.updateStatus();}else{this.assignmentTarget=assignmentTarget;this.trigger("app:space:express:console:afterBeginAssignment",assignmentTarget,this.pendingAssignments);this.updateStatus();}}else{this.trigger("app:space:express:console:afterBeginAssignment",assignmentTarget,this.pendingAssignments);this.assignmentTarget=assignmentTarget;this.updateStatus();}}else{this.trigger("app:space:express:console:afterBeginAssignment",assignmentTarget,this.pendingAssignments);this.assignmentTarget=assignmentTarget;this.updateStatus();}}},cancelAssignment:function(){this.clearAssignment();this.roomCountArray=[];this.refreshGrid();this.drawingPanel.getSidecar().set("pendingAssignments",this.pendingAssignments);this.drawingPanel.getSidecar().save();this.updateStatus();this.trigger("app:space:express:console:afterClearAssignment");},cancelSelectedRooms:function(){this.selectedRooms=new Ab.space.express.console.Rooms();this.updateStatus();},refreshGrid:function(){var tabName=this.attributeTabs.getSelectedTabName();if(tabName=="employeesTab"){this.employeeGrid.refresh();}else{var unselectedNode=null;if(tabName=="departmentsTab"){unselectedNode=this.departmentTree.lastNodeClicked;}else{if(tabName=="categoriesTab"){unselectedNode=this.categoriesTree.lastNodeClicked;}}if(unselectedNode){unselectedNode.highlightNode(false);}}},changeAssignTarget:function(){this.assignmentTarget=null;this.pendingAssignments=new Ab.space.express.console.Assignments();this.drawingPanel.getSidecar().set("pendingAssignments",this.pendingAssignments);this.drawingPanel.getSidecar().save();this.trigger("app:space:express:console:filterDrawing");this.updateStatus();},commitAssignment:function(){var assignments=this.getAssignmentsForWFR();try{if("spaceMode"==this.mode){Workflow.callMethod("AbSpaceRoomInventoryBAR-SpaceExpressService-commitSpaceAssignments",assignments);}else{Workflow.callMethod("AbSpaceRoomInventoryBAR-SpaceExpressService-commitEmployeeAssignments",assignments);}}catch(e){Workflow.handleError(e);}this.clearAssignment();this.updateStatus();this.drawingPanel.getSidecar().set("pendingAssignments",this.pendingAssignments);this.drawingPanel.getSidecar().save();this.refreshGrid();this.trigger("app:space:express:console:afterClearAssignment");},getAssignmentsForWFR:function(){var assignments=[];for(var i=0;i<this.pendingAssignments.models.length;i++){var assignment=this.pendingAssignments.models[i];var record={};record.bl_id=assignment.attributes.bl_id;record.fl_id=assignment.attributes.fl_id;record.rm_id=assignment.attributes.rm_id;record.em_id=assignment.attributes.em_id==undefined?"":assignment.attributes.em_id;record.to_bl_id=assignment.attributes.to_bl_id==undefined?"":assignment.attributes.to_bl_id;record.to_fl_id=assignment.attributes.to_fl_id==undefined?"":assignment.attributes.to_fl_id;record.to_rm_id=assignment.attributes.to_rm_id==undefined?"":assignment.attributes.to_rm_id;record.dv_id=assignment.attributes.to_dv_id==undefined?"":assignment.attributes.to_dv_id;record.dp_id=assignment.attributes.to_dp_id==undefined?"":assignment.attributes.to_dp_id;record.rm_cat=assignment.attributes.to_rm_cat==undefined?"":assignment.attributes.to_rm_cat;record.rm_type=assignment.attributes.to_rm_type==undefined?"":assignment.attributes.to_rm_type;record.rm_std=assignment.attributes.rm_std==undefined?"":assignment.attributes.rm_std;record.spaceAssignmentType=this.assignmentTarget.type;assignments.push(record);}return assignments;},removeAssignment:function(assignment){this.pendingAssignments.removeAssignment(assignment);if(this.pendingAssignments.length==0){this.cancelAssignment();}else{if(this.mode=="employeeMode"&&this.inAssignmentMode()){this.decreaseRoomCount(assignment);}this.viewAssignment();}this.updateStatus();},decreaseRoomCount:function(assignment){var currentLocation=assignment.location;var pattern=new RegExp("-","g");currentLocation=currentLocation.replace(pattern,"");for(var i=0;i<this.roomCountArray.length;i++){var location=this.roomCountArray[i].room;if(currentLocation==location){this.roomCountArray[i].count--;break;}}},moveEmployee:function(assignment){this.assignmentTarget=assignment;var sameAssignment=this.pendingAssignments.getAssignmentByEmployee(assignment);if(sameAssignment){assignment.bl_id=sameAssignment.get("bl_id");assignment.fl_id=sameAssignment.get("fl_id");assignment.rm_id=sameAssignment.get("rm_id");}this.pendingAssignments.addAssignment(assignment);this.updateStatus();},addEmployeeWaiting:function(assignments){for(var i=0;i<assignments.length;i++){this.pendingAssignments.addAssignment(assignments[i]);}this.updateStatus();},removeEmployeeWaiting:function(assignment){this.pendingAssignments.removeAssignment(assignment);this.updateStatus();},unassignEmployees:function(assignments){try{this.decreaseRmAssignedCountByAssignment(assignments);Workflow.callMethod("AbSpaceRoomInventoryBAR-SpaceExpressService-commitEmployeeAssignments",assignments);for(var i=0;i<assignments.length;i++){this.pendingAssignments.removeAssignment(assignments[i]);}this.updateStatus();this.employeeGrid.refresh();this.drawingPanel.refresh();}catch(e){Workflow.handleError(e);}},decreaseRmAssignedCountByAssignment:function(assignments){for(var i=0;i<assignments.length;i++){var room=assignments[i].bl_id+assignments[i].fl_id+assignments[i].rm_id;for(var j=0;j<this.roomCountArray.length;j++){var keyRoom=this.roomCountArray[j].room;if(room==keyRoom){this.roomCountArray[j].count=this.roomCountArray[j].count-1;}}}},updateStatus:function(){var status=this.getAssignmentStatus();this.drawingPanel.actionbar.setTitle(status);var showAssignActions=(status!="0 selected");var action=this.drawingPanel.actionbar.actions.get("cancelPendingAssignments");action.show(this.inAssignmentMode()&&showAssignActions);action.enableButton(true);action=this.drawingPanel.actionbar.actions.get("viewPendingAssignments");action.setTitle(getMessage("viewPendingAssignments")+"&nbsp;("+this.pendingAssignments.length+")");action.show(this.inAssignmentMode()&&showAssignActions);action.enableButton(true);action=this.drawingPanel.actionbar.actions.get("commitPendingAssignments");action.show(this.inAssignmentMode()&&showAssignActions);action.enableButton(View.user.isMemberOfGroup("SPACE-CONSOLE-ALL-ACCESS"));action=this.drawingPanel.actionbar.actions.get("viewDetails");action.show(!this.inAssignmentMode()&&this.selectedRooms.length>0);action.enableButton(true);action=this.drawingPanel.actionbar.actions.get("cancelSelectedRooms");action.show(!this.inAssignmentMode()&&this.selectedRooms.length>0);action.enableButton(true);},inAssignmentMode:function(){return this.assignmentTarget!==null;},getAssignmentStatus:function(){var status="";if(this.inAssignmentMode()){status=this.getMessageInAssignmentMode();}else{status=this.selectedRooms.length+"&nbsp;"+getMessage("selectedRoomCount");if(this.selectedRooms.length>0){var selectedRoomData=this.getSelectedRoomsTotals();status+=",&nbsp;"+selectedRoomData.area+"&nbsp;"+View.user.areaUnits.title;}}return status;},getMessageInAssignmentMode:function(){var status="";switch(this.assignmentTarget.type){case"division":status=getMessage("divisionAssignmentMode")+"&nbsp;"+this.assignmentTarget.dv_id;break;case"department":status=getMessage("departmentAssignmentMode")+"&nbsp;"+this.assignmentTarget.dp_id;break;case"category":status=getMessage("categoryAssignmentMode")+"&nbsp;"+this.assignmentTarget.rm_cat;break;case"type":status=getMessage("categoryTypeAssignmentMode")+"&nbsp;"+this.assignmentTarget.rm_type;break;case"standard":status=getMessage("roomStdAssignmentMode")+"&nbsp;"+this.assignmentTarget.rm_std;break;case"employee":if(valueExists(this.assignmentTarget.employees)&&this.assignmentTarget.employees.length>0){status=getMessage("employeeAssignmentMode")+"&nbsp;";if(this.assignmentTarget.employees.length==1){status+=this.assignmentTarget.employees[0].em_id;}else{status+=this.assignmentTarget.employees.length;status+="&nbsp;"+getMessage("employees");}}else{if(this.pendingAssignments.length>0){status=getMessage("employeeAssingmentTip");}else{status="0 selected";}}break;}return status;},selectRoom:function(room,selected){if(this.inAssignmentMode()){this.selectRoomInAssignmentMode(room,selected);}else{if(selected){if(!this.selectedRooms.findRoom(room)){this.selectedRooms.addRoom(room);}}else{this.selectedRooms.removeRoom(room);}}this.updateStatus();},selectRoomInAssignmentMode:function(room,selected){var innerThis=this;var handleAssignment=function(assignment){if(selected){innerThis.pendingAssignments.addAssignment(assignment);}else{innerThis.pendingAssignments.removeAssignment(assignment);}};switch(this.assignmentTarget.type){case"division":handleAssignment(this.getAssignmentForDp(room));break;case"department":handleAssignment(this.getAssignmentForDp(room));break;case"category":handleAssignment(this.getAssignmentForRoomCat(room));break;case"type":handleAssignment(this.getAssignmentForRoomCat(room));break;case"employee":this.updateEmployeeAssignment(room,selected);break;case"standard":handleAssignment(this.getAssignmentForRoomStandard(room));break;}},updateEmployeeAssignment:function(room,selected){for(var i=0;i<this.assignmentTarget.employees.length;i++){var assignment=_.clone(this.assignmentTarget.employees[i]);assignment.to_bl_id=room.bl_id;assignment.to_fl_id=room.fl_id;assignment.to_rm_id=room.rm_id;if(selected){this.pendingAssignments.addAssignment(assignment);this.updateStatus();}else{this.pendingAssignments.removeAssignment(assignment);this.updateStatus();}}this.employeeGrid.unselectAll();},getAssignmentForDp:function(room){return{bl_id:room.bl_id,fl_id:room.fl_id,rm_id:room.rm_id,to_dv_id:this.assignmentTarget.dv_id,to_dv_name:this.assignmentTarget.dv_name,to_dp_id:this.assignmentTarget.dp_id,to_dp_name:this.assignmentTarget.dp_name};},getAssignmentForRoomCat:function(room){return{bl_id:room.bl_id,fl_id:room.fl_id,rm_id:room.rm_id,to_rm_cat:this.assignmentTarget.rm_cat,to_rm_type:this.assignmentTarget.rm_type};},getAssignmentForRoomStandard:function(room){return{bl_id:room.bl_id,fl_id:room.fl_id,rm_id:room.rm_id,rm_std:this.assignmentTarget.rm_std};},viewSelectedRooms:function(anchor){this.singleRoomForm.show(false);this.singleEmployeeForm.show(false);this.multipleRoomForm.show(false);this.multipleEmployeeForm.show(false);this.readOnlyRmEmTabs.showInWindow({anchor:anchor,width:900,height:600,title:getMessage("selectedRoomsTitle"),restriction:this.selectedRooms.createRestriction()});this.readOnlyRmEmTabs.updateHeight();},getSelectedRoomsTotals:function(){var selectedRoomData={count:0,area:0,headcount:0};try{var restriction=this.selectedRooms.createRestriction();var record=this.selectedRoomsDS.getRecord(restriction);selectedRoomData.count=this.selectedRoomsDS.formatValue("rm.total_rooms",record.getValue("rm.total_rooms"),true);selectedRoomData.area=this.selectedRoomsDS.formatValue("rm.total_area",record.getValue("rm.total_area"),true);selectedRoomData.headcount=this.selectedRoomsDS.formatValue("rm.total_headcount",record.getValue("rm.total_headcount"),true);}catch(e){Workflow.handleError(e);}return selectedRoomData;},viewAssignment:function(anchor){if(this.inAssignmentMode()){switch(this.assignmentTarget.type){case"division":this.viewDepartmentPendingAssignments(anchor,"division");break;case"department":this.viewDepartmentPendingAssignments(anchor);break;case"category":this.viewTypePendingAssignments(anchor,"category");break;case"type":this.viewTypePendingAssignments(anchor);break;case"standard":this.viewRoomStdPendingAssignments(anchor);break;case"employee":this.viewEmployeePendingAssignments(anchor);break;}}},getNullDefaultRestriction:function(){var restriction=new Ab.view.Restriction();if(this.assignmentTarget.type=="em"){restriction.addClause("em.em_id","None","=");}else{restriction.addClause("rm.bl_id","None","=");restriction.addClause("rm.fl_id","None","=");restriction.addClause("rm.rm_id","None","=");}if(this.pendingAssignments.length>0){restriction=this.pendingAssignments.createRestriction();}return restriction;},viewDepartmentPendingAssignments:function(anchor,type){var restriction1=this.getNullDefaultRestriction();this.departmentPendingAssignments.showInWindow({anchor:anchor,width:800,title:getMessage("pendingDepartmentAssignmentsTitle"),restriction:restriction1});var fromTemplate=_.template("{{dv_id}}-{{dp_id}}");var toTemplate=_.template("{{to_dv_id}}-{{to_dp_id}}");var controller=this;this.departmentPendingAssignments.gridRows.each(function(row){var assignment=controller.pendingAssignments.findAssignment({bl_id:row.getFieldValue("rm.bl_id"),fl_id:row.getFieldValue("rm.fl_id"),rm_id:row.getFieldValue("rm.rm_id")});var from=row.getFieldValue("dp.dp_id")?fromTemplate({dv_id:row.getFieldValue("dv.dv_id"),dp_id:row.getFieldValue("dp.dp_id")}):"";var to=assignment.get("to_dp_id")?toTemplate(assignment.toJSON()):"";if(type=="division"){from=row.getFieldValue("dv.dv_id");to=assignment.get("to_dv_id");}row.setFieldValue("rm.from",from);row.setFieldValue("rm.to",to);});this.departmentPendingAssignments.resizeColumnWidths();},viewTypePendingAssignments:function(anchor,type){var restriction=this.getNullDefaultRestriction();this.categoryPendingAssignments.showInWindow({anchor:anchor,width:800,title:getMessage("pendingTypeAssignmentsTitle"),restriction:restriction});var fromTemplate=_.template("{{rm_cat}}-{{rm_type}}");var toTemplate=_.template("{{to_rm_cat}}-{{to_rm_type}}");var controller=this;this.categoryPendingAssignments.gridRows.each(function(row){var assignment=controller.pendingAssignments.findAssignment({bl_id:row.getFieldValue("rm.bl_id"),fl_id:row.getFieldValue("rm.fl_id"),rm_id:row.getFieldValue("rm.rm_id")});var from=row.getFieldValue("rm.rm_type")?fromTemplate({rm_cat:row.getFieldValue("rm.rm_cat"),rm_type:row.getFieldValue("rm.rm_type")}):"";var to=assignment.get("to_rm_type")?toTemplate(assignment.toJSON()):"";if(type=="category"){from=row.getFieldValue("rm.rm_cat");to=assignment.get("to_rm_cat");}row.setFieldValue("rm.from",from);row.setFieldValue("rm.to",to);});this.categoryPendingAssignments.resizeColumnWidths();},viewRoomStdPendingAssignments:function(anchor){var restriction=this.getNullDefaultRestriction();this.roomstdPendingAssignmentPanel.showInWindow({anchor:anchor,width:800,title:getMessage("pendingRoomStdAssignmentsTitle"),restriction:restriction});var controller=this;this.roomstdPendingAssignmentPanel.gridRows.each(function(row){var assignment=controller.pendingAssignments.findAssignment({bl_id:row.getFieldValue("rm.bl_id"),fl_id:row.getFieldValue("rm.fl_id"),rm_id:row.getFieldValue("rm.rm_id")});row.setFieldValue("rm.assigned_rm_std",assignment.get("rm_std"));});this.roomstdPendingAssignmentPanel.resizeColumnWidths();},viewEmployeePendingAssignments:function(anchor){var restriction=this.getNullDefaultRestriction();this.employeePendingAssignments.showInWindow({anchor:anchor,width:800,title:getMessage("pendingEmployeeAssignmentsTitle"),restriction:restriction});var fromTemplate=_.template("{{bl_id}}-{{fl_id}}-{{rm_id}}");var toTemplate=_.template("{{to_bl_id}}-{{to_fl_id}}-{{to_rm_id}}");var controller=this;this.employeePendingAssignments.gridRows.each(function(row){var assignment=controller.pendingAssignments.findAssignment({em_id:row.getFieldValue("em.em_id")});var from=assignment.get("bl_id")?fromTemplate(assignment.toJSON()):"";var to=assignment.get("to_bl_id")?toTemplate(assignment.toJSON()):"";row.setFieldValue("em.from",from);row.setFieldValue("em.to",to);});this.employeePendingAssignments.resizeColumnWidths();}});function checkIfOverCapacity(blId,flId,rmId,isDrag){var controlor=spaceExpressConsoleAssignment;var availableCount=getRoomCountVal(blId,flId,rmId,"rm.cap_em")-getRoomCountVal(blId,flId,rmId,"rm.caculated_count_em");var newAssignedCount=0;var countEm=0;if(arguments.length==4&&isDrag){countEm=1;}else{var grid=View.panels.get("employeeGrid");var rows=grid.getSelectedRows();countEm=rows.length;}var found=false;for(var i=0;i<controlor.roomCountArray.length;i++){if(controlor.roomCountArray[i].room==blId+flId+rmId){controlor.roomCountArray[i].count=controlor.roomCountArray[i].count+countEm;found=true;}}if(!found){var assignedEmCount={room:"",count:0};assignedEmCount.room=blId+flId+rmId;assignedEmCount.count=countEm;controlor.roomCountArray.push(assignedEmCount);}var assignedEmCount=0;for(var j=0;j<controlor.roomCountArray.length;j++){if(controlor.roomCountArray[j].room==blId+flId+rmId){assignedEmCount=controlor.roomCountArray[j].count;}}if((availableCount-assignedEmCount)<0){return true;}return false;}function getRoomCountVal(buildingId,floorId,roomId,fieldName){var cnt=0;try{var restriction=new Ab.view.Restriction();restriction.addClause("rm.bl_id",buildingId,"=",true);restriction.addClause("rm.fl_id",floorId,"=",true);restriction.addClause("rm.rm_id",roomId,"=",true);var drawingDataSource=View.dataSources.get("roomOccupancyDS");var recs=drawingDataSource.getRecords(restriction);if(recs!=null&&recs.length>0){cnt=recs[0].getValue(fieldName);}}catch(e){View.showException(e);}return parseInt(cnt,10);}var spaceExpressConsoleCategories=View.createController("spaceExpressConsoleCategories",{rmFilter:null,lastCategoryId:null,lastTypeId:null,lastClicked:null,events:{"click #categoriesRestrictToLocation":function(){this.onCheckEvent();}},afterCreate:function(){this.on("app:space:express:console:filter",this.refresh);},afterViewLoad:function(){this.insertFilterMessageCheckBox();this.initializeCategoriesTree();},insertFilterMessageCheckBox:function(){var template=_.template('<td class="checkbox-container" id="catRestriction"><input type="checkbox" id="categoriesRestrictToLocation" checked="false"/><span id="catResMessageSpan">{{restrictToLocation}}</span></td>');Ext.DomHelper.insertHtml("afterBegin",this.categoriesTree.toolbar.tr,template(View.messages));Ext.fly("catRestriction").setDisplayed(false);},initializeCategoriesTree:function(){var innerThis=this;this.categoriesTree.createRestrictionForLevel=function(parentNode,level){var restriction=null;if(level==1){restriction=new Ab.view.Restriction();var rmcat=parentNode.data["rm.rm_cat"];restriction.addClause("rm.rm_cat",rmcat,"=");innerThis.categoriesTree.addParameter("rmcatClause",rmcat?"rmcat.rm_cat ='"+rmcat+"'":" 1=1 ");innerThis.categoriesTree.addParameter("rmcatClauseTbRm",rmcat?"rm.rm_cat ='"+rmcat+"'":" 1=1 ");}return restriction;};this.categoriesTree.setNullValueTitle("rm.rm_cat",getMessage("titleUnassigned"));this.categoriesTree.setNullValueTitle("rm.rm_type",getMessage("titleUnassigned"));},afterInitialDataFetch:function(){this.edit_cate_detail.enableField("rmcat.hpattern_acad",false);this.edit_cate_detail.enableFieldActions("rmcat.hpattern_acad",true);this.edit_type_detail.enableField("rmtype.hpattern_acad",false);this.edit_type_detail.enableFieldActions("rmtype.hpattern_acad",true);},refresh:function(filter){if(filter){this.rmFilter=jQuery.extend(true,{},filter);var rmExists=" AND rm.bl_id ${sql.concat} rm.fl_id ${sql.concat} rm.rm_id is not null ";if(filter.parameters.typeUnassigned.indexOf("IS NULL")!=-1||filter.parameters.organizationUnassigned.indexOf("IS NULL")!=-1){this.rmFilter.parameters.typeUnassigned=filter.parameters.typeUnassigned+rmExists;}if(filter.parameters.totalArea.indexOf("total_area")!=-1||filter.parameters.totalArea.indexOf("total_count")!=-1){this.rmFilter.parameters.totalArea=getTotalAreaAndCountQueryParameter();}}abSpConsole_refreshDataFromFilter(this.categoriesTree,this.rmFilter,null);abSpConsole_toggleFromFilter("categoriesRestrictToLocation",["catRestriction"],"catResMessageSpan",this.rmFilter.searchValuesString+this.rmFilter.otherSearchValuesString);},onCheckEvent:function(){abSpConsole_toggleFromCheckEvent("categoriesRestrictToLocation",["catRestriction"],"catResMessageSpan",this.rmFilter.searchValuesString+this.rmFilter.otherSearchValuesString);abSpConsole_refreshDataFromCheckEvent("categoriesRestrictToLocation",this.categoriesTree,this.rmFilter,null);},categoriesTree_onAssignCategory:function(){var node=this.categoriesTree.lastNodeClicked;node.highlightNode(false);this.trigger("app:space:express:console:beginAssignment",{type:"category",rm_cat:node.data["rm.rm_cat"]});},typesTree_onAssignType:function(){var node=this.categoriesTree.lastNodeClicked;this.trigger("app:space:express:console:beginAssignment",{type:"type",rm_cat:node.parent.data["rm.rm_cat"],rm_type:node.data["rm.rm_type"]});},categoryPendingAssignments_onRemovePendingAssignment:function(row){this.trigger("app:space:express:console:removeAssignment",{bl_id:row.getFieldValue("rm.bl_id"),fl_id:row.getFieldValue("rm.fl_id"),rm_id:row.getFieldValue("rm.rm_id")});},categoryPendingAssignments_onCancelCategoryPendingAssignments:function(){this.trigger("app:space:express:console:cancelAssignment");},categoryPendingAssignments_onCommitCategoryPendingAssignments:function(){this.trigger("app:space:express:console:commitAssignment");},categoriesTree_onEditCategory:function(button,panel,node){node.highlightNode(false);abSpConsole_onCommonEditForTabsRow("editCategory",this.edit_cate_detail,button,panel,node);},typesTree_onEditType:function(button,panel,node){node.highlightNode(false);abSpConsole_onCommonEditForTabsRow("editType",this.edit_type_detail,button,panel,node);}});function filterDrawingByCat(){var currentNode=View.panels.get("categoriesTree").lastNodeClicked;var rm_cat=currentNode.data["rm.rm_cat"];with(spaceExpressConsoleCategories){if(rmFilter.parameters.rm_cat.indexOf("rm.rm_cat")!=-1){if(lastCategoryId==rm_cat){if(lastClicked=="category"){rmFilter.parameters.rm_cat=" 1=1 ";rmFilter.parameters.rm_type=" 1=1 ";currentNode.highlightNode(false);}else{rmFilter.parameters.rm_cat=" rm.rm_cat = '"+rm_cat+"'";rmFilter.parameters.rm_type=" 1=1 ";}}else{rmFilter.parameters.rm_cat=" rm.rm_cat = '"+rm_cat+"'";rmFilter.parameters.rm_type=" 1=1 ";lastCategoryId=rm_cat;}}else{rmFilter.parameters.rm_cat=" rm.rm_cat = '"+rm_cat+"'";rmFilter.parameters.rm_type=" 1=1 ";lastCategoryId=rm_cat;}lastClicked="category";trigger("app:space:express:console:filterDrawing",rmFilter);}}function filterDrawingByType(){var currentNode=View.panels.get("categoriesTree").lastNodeClicked;var rm_cat=currentNode.parent.data["rm.rm_cat"];var rm_type=currentNode.data["rm.rm_type"];var drawingFilter=spaceExpressConsoleCategories.rmFilter;with(spaceExpressConsoleCategories){if(lastTypeId==rm_type){if(lastCategoryId==rm_cat){if(lastClicked=="type"){if(rmFilter.parameters.rm_cat.indexOf("1=1")!=-1){rmFilter.parameters.rm_cat=" rm.rm_cat = '"+rm_cat+"'";rmFilter.parameters.rm_type=" rm.rm_type = '"+rm_type+"'";}else{rmFilter.parameters.rm_cat=" 1=1 ";rmFilter.parameters.rm_type=" 1=1 ";currentNode.highlightNode(false);}}else{rmFilter.parameters.rm_cat=" rm.rm_cat = '"+rm_cat+"'";rmFilter.parameters.rm_type=" rm.rm_type = '"+rm_type+"'";}}else{rmFilter.parameters.rm_cat=" rm.rm_cat = '"+rm_cat+"'";rmFilter.parameters.rm_type=" 1=1 ";lastCategoryId=rm_cat;}}else{rmFilter.parameters.rm_cat=" rm.rm_cat = '"+rm_cat+"'";rmFilter.parameters.rm_type=" rm.rm_type = '"+rm_type+"'";lastCategoryId=rm_cat;lastTypeId=rm_type;}lastClicked="type";trigger("app:space:express:console:filterDrawing",rmFilter);}}function addCategory(){var panel=View.panels.get("edit_cate_detail");panel.showInWindow({newRecord:true,width:880,height:500,restriction:new Ab.view.Restriction(),title:getMessage("addCategory")});}function addType(){var panel=View.panels.get("edit_type_detail");panel.showInWindow({newRecord:true,width:880,height:500,restriction:new Ab.view.Restriction(),title:getMessage("addType")});}function exportCategoriesTreeToXLS(){doCategoriesTreeCustomExport(Ab.grid.ReportGrid.WORKFLOW_RULE_XLS_REPORT,"xls");}function exportCategoriesTreeToDOCX(){doCategoriesTreeCustomExport(Ab.grid.ReportGrid.WORKFLOW_RULE_DOCX_REPORT,"docx");}function doCategoriesTreeCustomExport(workflowRuleName,outputType){var firstLevelDataSourceId="categoriesDS";var secondLevelDataSourceId="typesDS";var categoriesTree=View.panels.get("categoriesTree");var hasRes=Ext.getDom("categoriesRestrictToLocation").checked?true:false;var parameters=hasRes?spaceExpressConsoleDepartments.rmFilter.parameters:{};var restriction=spaceExpressConsoleCategories.rmFilter.restriction;var printableRestrictions=getPrintableRestrictions(restriction,hasRes);parameters.printRestriction=hasRes;parameters.printableRestriction=printableRestrictions;parameters.categoryDataSourceId=firstLevelDataSourceId;parameters.categoryFields=getCategoryFieldsArrayForTreePanel(categoriesTree,firstLevelDataSourceId,0);parameters.categoryFieldDrillDownParametersPattern=[{name:"rmcatClause",pattern:"rmcat.rm_cat='%s'"},{name:"rmcatClauseTbRm",pattern:"rm.rm_cat='%s'"}];parameters.categoryFieldDrillDownRestrictionPattern="rm.rm_cat='%s'";var fieldDefs=spaceExpressConsoleCategories.categoriesDS.fieldDefs;if(outputType!="xls"){parameters.outputType=outputType;fieldDefs.items[0].title=getMessage("roomCatTitle");}else{fieldDefs.items[0].title=getMessage("catTypeTitle");}var roomCatReport=getMessage("roomCatReport");var jobId=Workflow.startJob(workflowRuleName,categoriesTree._viewFile,secondLevelDataSourceId,roomCatReport,getCategoryFieldsArrayForTreePanel(categoriesTree,secondLevelDataSourceId,1),"",parameters);if(jobId!=null){var command=new Ab.command.exportPanel({});command.displayReport(jobId,outputType);}}function abSpConsole_refreshDataContainer(dataContainer,filter,searchString,restriction){dataContainer.clearParameters();var filterResult=searchString;var refreshRestriction=restriction;if(filterResult!=""){dataContainer.addParameters(filter.parameters);}else{if(filter.unassignedRes){refreshRestriction=filter.unassignedRes;}else{refreshRestriction=new Ab.view.Restriction();}}dataContainer.refresh(refreshRestriction);}function abSpConsole_toggleRestrictionText(showElement,messageDom,searchString){var filterResult=searchString;if(filterResult!=""){if(filterResult.length>10){filterResult=filterResult.substring(0,10)+"...";}var message=getMessage("textRestrictTo")+" ";filterResult=message+filterResult;Ext.getDom(messageDom).innerHTML=filterResult;for(var i=0;i<showElement.length;i++){Ext.fly(showElement[i]).setDisplayed(true);}var tooltipText=message+searchString;Ext.QuickTips.unregister(messageDom);if(tooltipText!=""){Ext.QuickTips.register({target:messageDom,text:tooltipText});}}}function abSpConsole_toggleFromFilter(checkBoxName,showElements,messageDom,searchString){if(searchString==""){Ext.getDom(checkBoxName).checked=false;}else{Ext.getDom(checkBoxName).checked=true;}abSpConsole_toggleRestrictionText(showElements,messageDom,searchString);}function abSpConsole_toggleFromCheckEvent(checkBoxName,showElements,messageDom,searchString){var checked=Ext.getDom(checkBoxName).checked;var searchStr=searchString;if(!checked){searchStr="";}abSpConsole_toggleRestrictionText(showElements,messageDom,searchStr);}function abSpConsole_refreshDataFromFilter(dataContainer,filter,restriction){abSpConsole_refreshDataContainer(dataContainer,filter,filter.searchValuesString+filter.otherSearchValuesString,restriction);}function abSpConsole_refreshDataFromCheckEvent(checkBoxName,dataContainer,filter,restriction){var checked=Ext.getDom(checkBoxName).checked;var searchStr=filter.searchValuesString+filter.otherSearchValuesString;if(!checked){searchStr="";}abSpConsole_refreshDataContainer(dataContainer,filter,searchStr,restriction);}function abSpConsole_onCommonEditForTabsRow(target,showForm,button,panel,dataElem){var restrictionForTarget=new Ab.view.Restriction();if(target=="editDv"){restrictionForTarget.addClause("dv.dv_id",dataElem.data["rm.dv_id"]);}else{if(target=="editDp"){restrictionForTarget.addClause("dp.dp_id",dataElem.data["rm.dp_id"]);}else{if(target=="editCategory"){restrictionForTarget.addClause("rmcat.rm_cat",dataElem.data["rm.rm_cat"]);}else{if(target=="editType"){restrictionForTarget.addClause("rmtype.rm_cat",dataElem.data["rm.rm_cat"]);restrictionForTarget.addClause("rmtype.rm_type",dataElem.data["rm.rm_type"]);}}}}showForm.showInWindow({newRecord:false,anchor:button,restriction:restrictionForTarget,title:getMessage(target)});showForm.actions.get("delete").enableButton(true);}function abSpConsole_onAssignSelectedRoom(assignmentTarget,assignments,pendingAssignments,room,selected){var assignmentTargetType=assignmentTarget.type;switch(assignmentTargetType){case"division":case"department":assignments.push(abSpConsole_genAssignmentForDvDp(assignmentTarget,room));break;case"category":case"type":assignments.push(abSpConsole_genAssignmentForRoomCat(assignmentTarget,room));break;case"employee":break;}abSpConsole_assignTarget(pendingAssignments,assignments,selected);}function abSpConsole_assignTarget(pendingAssignments,assignments,selected){if(selected){for(var i=0;i<assignments.length;i++){pendingAssignments.addAssignment(assignments[i]);}}else{for(var j=0;j<assignments.length;j++){pendingAssignments.removeAssignment(assignments[j]);}}}function abSpConsole_genAssignmentForDvDp(assignmentTarget,room){return{bl_id:room.bl_id,fl_id:room.fl_id,rm_id:room.rm_id,to_dv_id:assignmentTarget.dv_id,to_dv_name:assignmentTarget.dv_name,to_dp_id:assignmentTarget.dp_id,to_dp_name:assignmentTarget.dp_name};}function abSpConsole_genAssignmentForRoomCat(assignmentTarget,room){return{bl_id:room.bl_id,fl_id:room.fl_id,rm_id:room.rm_id,to_rm_cat:assignmentTarget.rm_cat,to_rm_type:assignmentTarget.rm_type};}function abSpConsole_onSelectedRoom(selectedRooms,room,selected){if(selected){if(!selectedRooms.findRoom(room)){selectedRooms.addRoom(room);}}else{selectedRooms.removeRoom(room);}}function abSpConsole_openHpatternDialog(panelId,field){View.hpatternPanel=View.panels.get(panelId);View.hpatternField=field;View.patternString=View.hpatternPanel.getFieldValue(field);View.openDialog("ab-hpattern-dialog.axvw",null,true,{width:700,height:530,closeButton:false});}function abSpConsole_getFieldDef(dataSourceId,fieldId){var fieldDefs=abSpConsole_getFieldDefs(dataSourceId);for(var i=0,field;field=fieldDefs[i];i++){if(field.id===fieldId){return field;}}return{};}function abSpConsole_getFieldDefs(dataSourceId){var fieldDefs=[];var dataSource=View.dataSources.get(dataSourceId);dataSource.fieldDefs.each(function(fieldDef){fieldDefs.push(fieldDef);});return fieldDefs;}function getTotalAreaAndCountQueryParameter(){var areaAndCount=" 1=1 ";var vpaRes=arguments.length==1&&arguments[0]=="em"?"${sql.getVpaRestrictionForTable('rm')}":"${sql.vpaRestriction}";var parameters=" AND ( (${parameters['dp_id']} AND ${parameters['dv_id']} ) AND (${parameters['organizationUnassigned']})) AND ${parameters['bl_id']} AND ${parameters['fl_id']} AND ${parameters['rm_id']} AND ((${parameters['rm_cat']} AND ${parameters['rm_type']} ) AND (${parameters['typeUnassigned']})) AND ${parameters['occupancy']} AND "+vpaRes;var calcsRes=" WHERE rm.dwgname IS NOT NULL AND (rm.rm_cat IS NULL OR EXISTS (SELECT 1 FROM rmcat WHERE rm.rm_cat= rmcat.rm_cat AND rmcat.used_in_calcs !='no_totals')) ";var tempString="EXISTS(SELECT 1 FROM (  SELECT rm.bl_id, rm.fl_id FROM rm"+calcsRes+parameters+" GROUP BY rm.bl_id, rm.fl_id, rm.dwgname HAVING ";var endString="  ${sql.as}  wraped_rm WHERE wraped_rm.bl_id = rm.bl_id AND wraped_rm.fl_id = rm.fl_id) ";var checkTotalArea=Ext.get("occupancyWithTotalArea").dom.checked&&Ext.get("totalArea").dom.value!="";var checkTotalRooms=Ext.get("occupancyWithTotalRooms").dom.checked&&Ext.get("totalRooms").dom.value!="";var areaRestriction=tempString+" sum(rm.area) "+Ext.get("totalAreaOp").dom.value+" "+Ext.get("totalArea").dom.value+")"+endString;var roomsRestriction=tempString+" count(DISTINCT rm.bl_id ${sql.concat} rm.fl_id ${sql.concat} rm.rm_id) "+Ext.get("totalRoomsOp").dom.value+" "+Ext.get("totalRooms").dom.value+")"+endString;if(checkTotalArea&&checkTotalRooms){areaAndCount=areaRestriction+" AND "+roomsRestriction;}else{if(checkTotalArea&&!checkTotalRooms){areaAndCount=areaRestriction;}else{if(!checkTotalArea&&checkTotalRooms){areaAndCount=roomsRestriction;}}}return areaAndCount;}function containElement(dataArray,element){var found=false;for(var i=0;i<dataArray.length;i++){if(element==dataArray[i]){found=true;break;}}return found;}function getPrintableRestrictions(restriction,hasRes){var printableRestrictions=[];if(hasRes){var bl_id_clause=restriction.findClause("rm.bl_id");if(bl_id_clause!=null){var bl_id=bl_id_clause.value;printableRestrictions.push({title:"Building Code",value:bl_id});}var fl_id_clause=restriction.findClause("rm.fl_id");if(fl_id_clause!=null){var fl_id=fl_id_clause.value;printableRestrictions.push({title:"Floor Code",value:fl_id});}var rm_id_clause=restriction.findClause("rm.rm_id");if(rm_id_clause!=null){var rm_id=rm_id_clause.value;printableRestrictions.push({title:"Room Code",value:rm_id});}var dv_id_clause=restriction.findClause("rm.dv_id");if(dv_id_clause!=null){var dv_id=dv_id_clause.value;printableRestrictions.push({title:"Division Code",value:dv_id});}var dp_id_clause=restriction.findClause("rm.dp_id");if(dp_id_clause!=null){var dp_id=dp_id_clause.value;printableRestrictions.push({title:"Department Code",value:dp_id});}var rmcat_clause=restriction.findClause("rm.rm_cat");if(rmcat_clause!=null){var rmCat=rmcat_clause.value;printableRestrictions.push({title:"Room Category",value:rmCat});}var rmtype_clause=restriction.findClause("rm.rm_type");if(rmtype_clause!=null){var rmType=rmtype_clause.value;printableRestrictions.push({title:"Room Type",value:rmType});}if($("organizationUnassigned").checked){printableRestrictions.push({title:"Unassigned Organizations",value:"[Yes]"});}if($("typeUnassigned").checked){printableRestrictions.push({title:"Unassigned Room Categories",value:"[Yes]"});}var occupancy="";if($("occupancyVacantOnly").checked){occupancy+=" Vacant only, ";}if($("occupancyVacant").checked){occupancy+=" Vacant, ";}if($("occupancyAvailable").checked){occupancy+=" Available, ";}if($("occupancyAtCapacity").checked){occupancy+=" At capacity, ";}if($("occupancyExceedsCapacity").checked){occupancy+=" Exceeds capacity, ";}if(jQuery("#div_checkbox_control input:checked").length>0){printableRestrictions.push({title:"Occupancy options:",value:"["+occupancy.substring(0,occupancy.length-2)+"]"});}if($("occupancyWithTotalArea").checked){printableRestrictions.push({title:"With total area"+Ext.get("totalAreaOp").dom.value,value:Ext.get("totalArea").dom.value});}if($("occupancyWithTotalRooms").checked){printableRestrictions.push({title:"With total room count"+Ext.get("totalRoomsOp").dom.value,value:Ext.get("totalRooms").dom.value});}}return printableRestrictions;}function getCategoryFieldsArray(grid,ds){var categoryFieldsArray=[];var columns=grid.getColumns();for(var i=0;i<columns.length;i++){var column=columns[i];if(!column.hidden&&column.id.indexOf("edit")==-1&&column.id.indexOf("assign")==-1){if(column.id=="rm.rm_std"){var key_fieldDef=abSpConsole_getFieldDef(ds,name);key_fieldDef.defaultValue=getMessage("titleUnassigned");categoryFieldsArray.push(key_fieldDef);}else{categoryFieldsArray.push(abSpConsole_getFieldDef(ds,column.id));}}}return categoryFieldsArray;}function getCategoryFieldsArrayForTreePanel(tree,ds,level){var categoryFieldsArray=[];var sidecar=tree.getSidecar();var sidecarLevels=sidecar.get("levels");if(sidecarLevels.length==0){var items=View.dataSources.get(ds).fieldDefs.items;for(var i=0;i<items.length;i++){var item=items[i];if(item.hidden=="false"&&item.id!="rm.pec_of_total_area"){var name=item.id;if(level==1&&(name=="rm.rm_cat"||name=="rm.dv_id")){continue;}setCategoryFieldsArray(ds,level,name,categoryFieldsArray);}}}else{var visibleFields=sidecarLevels[level].visibleFields;for(var i=0;i<visibleFields.length;i++){var visibleField=visibleFields[i];var name=visibleField.name;setCategoryFieldsArray(ds,level,name,categoryFieldsArray);}}return categoryFieldsArray;}function setCategoryFieldsArray(ds,level,name,categoryFieldsArray){if(name.indexOf("edit")==-1&&name.indexOf("assign")==-1){if(name=="rm.dv_id"||name=="rm.rm_cat"||name=="rm.description"||name=="rm.dp_id"||name=="rm.rm_type"||name=="rm.dv_name"||name=="rm.dp_name"){var key_fieldDef=abSpConsole_getFieldDef(ds,name);if(name=="rm.dv_name"||name=="rm.dp_name"||name=="rm.description"){key_fieldDef.defaultValue=" ";}else{key_fieldDef.defaultValue=getMessage("titleUnassigned");}categoryFieldsArray.push(abSpConsole_getFieldDef(ds,name));if(level==0&&name=="rm.dv_id"||name=="rm.rm_cat"){categoryFieldsArray.push({});}}else{categoryFieldsArray.push(abSpConsole_getFieldDef(ds,name));}}}function confirmClearWaitingRoom(){var waitingList=spaceExpressConsoleDrawing.employeesWaiting;var clear=true;if(waitingList.length>0){var message=getMessage("confirmEmployeeAssignmentCommit");if(!confirm(message)){clear=false;}}return clear;}var spaceExpressConsoleDepartments=View.createController("spaceExpressConsoleDepartments",{rmFilter:null,lastDvId:null,lastDepartId:null,lastClicked:null,events:{"click #departmentRestrictToLocation":function(){this.onCheckEvent();}},afterCreate:function(){this.on("app:space:express:console:filter",this.refresh);},afterViewLoad:function(){this.insertDepartmentFilterMessage();this.initializeDepartmentTree();},insertDepartmentFilterMessage:function(){var template=_.template('<td class="checkbox-container" id="dpRestriction"><input type="checkbox" id="departmentRestrictToLocation" checked="false"/><span id="dpResMessageSpan">{{restrictToLocation}}</span></td>');Ext.DomHelper.insertHtml("afterBegin",this.departmentTree.toolbar.tr,template(View.messages));Ext.fly("dpRestriction").setDisplayed(false);},initializeDepartmentTree:function(){var innerThis=this;this.departmentTree.createRestrictionForLevel=function(parentNode,level){var restriction=null;if(level==1){restriction=new Ab.view.Restriction();var dv_id=parentNode.data["rm.dv_id"];restriction.addClause("rm.dv_id",dv_id,"=");innerThis.departmentTree.addParameter("dvIdClause",dv_id?"dv.dv_id ='"+dv_id+"'":" 1=1 ");innerThis.departmentTree.addParameter("dvIdClauseTbRm",dv_id?"rm.dv_id ='"+dv_id+"'":" 1=1 ");}return restriction;};this.departmentTree.setColorOpacity(this.drawingPanel.getFillOpacity());this.departmentTree.setNullValueTitle("rm.dv_id",getMessage("titleUnassigned"));this.departmentTree.setNullValueTitle("rm.dp_id",getMessage("titleUnassigned"));},afterInitialDataFetch:function(){this.edit_dv_detail.enableField("dv.hpattern_acad",false);this.edit_dv_detail.enableFieldActions("dv.hpattern_acad",true);this.edit_dp_detail.enableField("dp.hpattern_acad",false);this.edit_dp_detail.enableFieldActions("dp.hpattern_acad",true);},refresh:function(filter){if(filter){this.rmFilter=jQuery.extend(true,{},filter);var rmExists=" AND rm.bl_id ${sql.concat} rm.fl_id ${sql.concat} rm.rm_id is not null ";if(filter.parameters.organizationUnassigned.indexOf("IS NULL")!=-1||filter.parameters.typeUnassigned.indexOf("IS NULL")!=-1){this.rmFilter.parameters.organizationUnassigned=filter.parameters.organizationUnassigned+rmExists;}if(filter.parameters.totalArea.indexOf("total_area")!=-1||filter.parameters.totalArea.indexOf("total_count")!=-1){this.rmFilter.parameters.totalArea=getTotalAreaAndCountQueryParameter();}}abSpConsole_refreshDataFromFilter(this.departmentTree,this.rmFilter,null);abSpConsole_toggleFromFilter("departmentRestrictToLocation",["dpRestriction"],"dpResMessageSpan",this.rmFilter.searchValuesString+this.rmFilter.otherSearchValuesString);},onCheckEvent:function(){abSpConsole_toggleFromCheckEvent("departmentRestrictToLocation",["dpRestriction"],"dpResMessageSpan",this.rmFilter.searchValuesString+this.rmFilter.otherSearchValuesString);abSpConsole_refreshDataFromCheckEvent("departmentRestrictToLocation",this.departmentTree,this.rmFilter,null);},departmentTree_onAssignDivision:function(){var node=this.departmentTree.lastNodeClicked;node.highlightNode(false);this.trigger("app:space:express:console:beginAssignment",{type:"division",dv_id:node.data["rm.dv_id"],dv_name:node.data["rm.dv_name"]});},departmentTreeLevel_onAssignDepartment:function(){var node=this.departmentTree.lastNodeClicked;node.highlightNode(false);this.trigger("app:space:express:console:beginAssignment",{type:"department",dv_id:node.parent.data["rm.dv_id"],dv_name:node.parent.data["rm.dv_name"],dp_id:node.data["rm.dp_id"],dp_name:node.data["rm.dp_name"]});},departmentPendingAssignments_onCommitDepartmentPendingAssignments:function(){this.trigger("app:space:express:console:commitAssignment");},departmentPendingAssignments_onRemovePendingAssignment:function(row){this.trigger("app:space:express:console:removeAssignment",{bl_id:row.getFieldValue("rm.bl_id"),fl_id:row.getFieldValue("rm.fl_id"),rm_id:row.getFieldValue("rm.rm_id")});},departmentPendingAssignments_onCancelDepartmentPendingAssignments:function(){this.trigger("app:space:express:console:cancelAssignment");},departmentTree_onEditDivision:function(button,panel,node){node.highlightNode(false);abSpConsole_onCommonEditForTabsRow("editDv",this.edit_dv_detail,button,panel,node);},departmentTreeLevel_onEditDepartment:function(button,panel,node){node.highlightNode(false);abSpConsole_onCommonEditForTabsRow("editDp",this.edit_dp_detail,button,panel,node);}});function filterDrawingByDivision(){var currentNode=View.panels.get("departmentTree").lastNodeClicked;var dv_id=currentNode.data["rm.dv_id"];with(spaceExpressConsoleDepartments){if(rmFilter.parameters.dv_id.indexOf("rm.dv_id")!=-1){if(lastDvId==dv_id){if(lastClicked=="division"){rmFilter.parameters.dv_id=" 1=1 ";rmFilter.parameters.dp_id=" 1=1 ";currentNode.highlightNode(false);}else{rmFilter.parameters.dv_id=" rm.dv_id = '"+dv_id+"'";rmFilter.parameters.dp_id=" 1=1 ";}}else{rmFilter.parameters.dv_id=" rm.dv_id = '"+dv_id+"'";rmFilter.parameters.dp_id=" 1=1 ";lastDvId=dv_id;}}else{rmFilter.parameters.dv_id=" rm.dv_id = '"+dv_id+"'";rmFilter.parameters.dp_id=" 1=1 ";lastDvId=dv_id;}lastClicked="division";trigger("app:space:express:console:filterDrawing",rmFilter);}}function filterDrawingByDepartment(){var currentNode=View.panels.get("departmentTree").lastNodeClicked;var dv_id=currentNode.parent.data["rm.dv_id"];var dp_id=currentNode.data["rm.dp_id"];with(spaceExpressConsoleDepartments){if(lastDepartId==dp_id){if(lastDvId==dv_id){if(lastClicked=="department"){if(rmFilter.parameters.dv_id.indexOf("1=1")!=-1){rmFilter.parameters.dv_id=" rm.dv_id = '"+dv_id+"'";rmFilter.parameters.dp_id=" rm.dp_id = '"+dp_id+"'";}else{rmFilter.parameters.dv_id=" 1=1 ";rmFilter.parameters.dp_id=" 1=1 ";currentNode.highlightNode(false);}}else{rmFilter.parameters.dv_id=" rm.dv_id = '"+dv_id+"'";rmFilter.parameters.dp_id=" rm.dp_id = '"+dp_id+"'";}}else{rmFilter.parameters.dv_id=" rm.dv_id = '"+dv_id+"'";rmFilter.parameters.dp_id=" 1=1 ";lastDvId=dv_id;}}else{rmFilter.parameters.dv_id=" rm.dv_id = '"+dv_id+"'";rmFilter.parameters.dp_id=" rm.dp_id = '"+dp_id+"'";lastDvId=dv_id;lastDepartId=dp_id;}lastClicked="department";trigger("app:space:express:console:filterDrawing",rmFilter);}}function onAddDv(){var panel=View.panels.get("edit_dv_detail");panel.showInWindow({newRecord:true,width:800,height:250,restriction:new Ab.view.Restriction(),title:getMessage("addDv")});}function onAddDp(){var panel=View.panels.get("edit_dp_detail");panel.showInWindow({newRecord:true,width:800,height:250,restriction:new Ab.view.Restriction(),title:getMessage("addDp")});}function exportDepartmentTreeToXLS(){doDepartmentTreeCustomExport(Ab.grid.ReportGrid.WORKFLOW_RULE_XLS_REPORT,"xls");}function exportDepartmentTreeToDOCX(){doDepartmentTreeCustomExport(Ab.grid.ReportGrid.WORKFLOW_RULE_DOCX_REPORT,"docx");}function doDepartmentTreeCustomExport(workflowRuleName,outputType){var firstLevelDataSourceId="divisionDS";var secondLevelDataSourceId="departmentDS";var departmentTree=View.panels.get("departmentTree");var hasRes=Ext.getDom("departmentRestrictToLocation").checked?true:false;var parameters=hasRes?spaceExpressConsoleDepartments.rmFilter.parameters:{};var restriction=spaceExpressConsoleDepartments.rmFilter.restriction;var printableRestrictions=getPrintableRestrictions(restriction,hasRes);parameters.printRestriction=hasRes;parameters.printableRestriction=printableRestrictions;parameters.categoryDataSourceId=firstLevelDataSourceId;parameters.categoryFields=getCategoryFieldsArrayForTreePanel(departmentTree,firstLevelDataSourceId,0);parameters.categoryFieldDrillDownParametersPattern=[{name:"dvIdClause",pattern:"dv.dv_id='%s'"},{name:"dvIdClauseTbRm",pattern:"rm.dv_id='%s'"}];parameters.categoryFieldDrillDownRestrictionPattern="rm.dv_id='%s'";var fieldDefs=spaceExpressConsoleDepartments.divisionDS.fieldDefs;var fieldDefs2=spaceExpressConsoleDepartments.departmentDS.fieldDefs;if(outputType!="xls"){parameters.outputType=outputType;fieldDefs.items[0].title=getMessage("dvTitle");fieldDefs2.items[2].title=getMessage("dpName");}else{fieldDefs.items[0].title=getMessage("dvDpTitle");fieldDefs2.items[2].title=getMessage("name");}var orgReport=getMessage("orgReport");var jobId=Workflow.startJob(workflowRuleName,departmentTree._viewFile,secondLevelDataSourceId,orgReport,getCategoryFieldsArrayForTreePanel(departmentTree,secondLevelDataSourceId,1),"",parameters);if(jobId!=null){var command=new Ab.command.exportPanel({});command.displayReport(jobId,outputType);}}var spaceExpressConsoleDrawingPdfCtrl=View.createController("spaceExpressConsoleDrawingPdfCtrl",{currentHighlightDataSourceId:null,currentLabelDataSourceId:null,afterCreate:function(){this.on("app:space:express:console:printPDF",this.printPdf);},printPdf:function(filter,drawingPanel,selectedFloors){var viewName=this.getPdfReportView(drawingPanel);this.openPdfReportView(viewName,filter,selectedFloors);},getPdfReportView:function(drawingPanel){this.currentHighlightDataSourceId=drawingPanel.currentHighlightDS;this.currentLabelDataSourceId=drawingPanel.currentLabelsDS;return"ab-sp-console-drawing-pdf-"+this.getAbbreviation(this.currentHighlightDataSourceId)+"-"+this.getAbbreviation(this.currentLabelDataSourceId)+".axvw";},getAbbreviation:function(dataSourceId){if("None"==dataSourceId||"none"==dataSourceId){return"none";}else{if("highlightDivisionsDs"==dataSourceId||"labelDivisionsDs"==dataSourceId){return"dv";}else{if("highlightDepartmentsDs"==dataSourceId||"labelDepartmentDs"==dataSourceId){return"dp";}else{if("highlightCategoriesDs"==dataSourceId||"labelCategoriesDs"==dataSourceId){return"cat";}else{if("highlightTypesDs"==dataSourceId||"labelTypesDs"==dataSourceId){return"type";}else{if("highlightSuperCategoriesDs"==dataSourceId||"labelSuperCategoriesDs"==dataSourceId){return"scat";}else{if("highlightEmployeesDs"==dataSourceId||"labelEmployeesDs"==dataSourceId){return"em";}else{if("labelRoomNumberDs"==dataSourceId){return"rm";}}}}}}}}},openPdfReportView:function(viewName,filter,selectedFloors){var passedRestrictions={};passedRestrictions[this.currentHighlightDataSourceId]=filter.restriction;passedRestrictions[this.currentLabelDataSourceId]=filter.restriction;var parameters={};for(attrubute in filter.parameters){if("totalArea"==attrubute){var value=filter.parameters[attrubute];var indexOfTotalArea=value.indexOf("total_area");var indexOfTotalCount=value.indexOf("total_count");if(indexOfTotalArea>0&&indexOfTotalCount>0){parameters.totalArea=value.substring(11,indexOfTotalCount-5);parameters.totalCount=value.substring(indexOfTotalCount+12);}else{if(indexOfTotalCount>0){parameters.totalCount=value.substring(12);}else{if(indexOfTotalArea>0){parameters.totalArea=value.substring(11);}}}}else{parameters[attrubute+"ForTotalCal"]=filter.parameters[attrubute].replace(/rm\./g,"r.");parameters[attrubute]=filter.parameters[attrubute];}}View.openPaginatedReportDialog(viewName,passedRestrictions,parameters);}});var spaceExpressConsoleDrawing=View.createController("spaceExpressConsoleDrawing",{mode:"",assignmentTarget:null,pendingAssignments:null,selectedRooms:null,assignedRooms:null,movedEmployeesRooms:null,selectedFloors:null,employeesWaiting:null,assetPanelCreated:false,filter:null,lastFilter:null,selecteEmployeedRows:null,totalSelectedEmployeeRows:0,isLocateEvent:false,openRoomStandardAction:null,copyOfRoomStandardElement:null,afterCreate:function(){this.initializeVariables();this.initializeEventListener();},initializeVariables:function(){this.assignmentTarget=null;this.selectedFloors=[];this.employeesWaiting=[];this.resetRoomsData();this.lastFilter={restriction:null,parameters:{}};this.setFilter();},initializeEventListener:function(){this.on("app:space:express:console:filter",this.refresh);this.on("app:space:express:console:filterDrawing",this.refresh);this.on("app:space:express:console:selectLocation",this.addFloorPlan);this.on("app:space:express:console:changeMode",this.changeMode);this.on("app:space:express:console:addEmployeeWaiting",this.addEmployeeWaiting);this.on("app:space:express:console:unassignEmployees",this.unassignEmployees);this.on("app:space:express:console:removeAssignment",this.removeAssignment);this.on("app:space:express:console:afterBeginAssignment",this.afterBeginAssignment);this.on("app:space:express:console:afterClearAssignment",this.afterClearAssignment);this.on("app:space:express:console:afterChangeAssignmentTarget",this.afterChangeAssignmentTarget);this.on("app:space:express:console:loadAndHighLightSelectedEmployees",this.loadAndHighlightSelectedEmployees);this.on("app:space:express:console:loadAndHighLightSelectedRoom",this.loadAndHighlightSelectedRoom);this.on("app:space:express:console:highlightRooms",this.highlightRooms);this.on("app:space:express:console:cancelSelectedRooms",this.cancelSelectedRooms);this.on("app:space:express:console:cancelEmployeeAssignment",this.cancelEmployeeAssignment);this.on("app:space:express:console:commitRoomsAlteration",this.afterCommitRoomsAlteration);this.on("app:space:express:console:rollbackEmployeeAssignment",this.rollbackEmployeeAssignment);},afterViewLoad:function(){this.drawingPanel.enableLiteDisplay(false);this.drawingPanel.setDraggableAssets(["em"]);this.drawingPanel.setDiagonalSelectionPattern(true);this.drawingPanel.addEventListener("onclick",this.onClickRoom.createDelegate(this));this.drawingPanel.addEventListener("ondwgload",this.reHighlightSelectedAssets.createDelegate(this));this.drawingPanel.addEventListener("onMultipleSelectionChange",this.onDrawingPanelMultipleSelectionChange.createDelegate(this));this.drawingPanel.addEventListener("onselecteddatasourcechanged",this.handleSelectDataSource.createDelegate(this));this.doAppendRuleSet();this.legendGrid.afterCreateCellContent=setLegendLabel;this.borderLegendGrid.afterCreateCellContent=setLegendLabel;},doAppendRuleSet:function(){var ruleset=new DwgHighlightRuleSet();ruleset.appendRule("rm.count_em","0","DBDBDB","==");ruleset.appendRule("rm.count_em","1","4DFF4D","==");ruleset.appendRule("rm.count_em","2","4D4DFF","==");ruleset.appendRule("rm.count_em","3","FFFF4D","==");ruleset.appendRule("rm.count_em","4","FF4D4D","==");this.drawingPanel.appendRuleSet("highlightEmployeesDs",ruleset);},changeMode:function(mode){if(valueExists(mode)){this.mode=mode;}this.resetRoomsData();this.swithOptionForMode();this.handleModeAction();},setFilter:function(filter){if(filter){this.filter=filter;}else{if(this.filter==null){this.filter={restriction:null,parameters:{}};}}},handleModeAction:function(){if(this.mode=="employeeMode"){this.switchRoomStandardIconStatus(false);this.drawingPanel.setDraggableAssets(["em"]);this.refreshAssetPanel();}else{this.switchRoomStandardIconStatus(true);if(this.filter){this.filter.restriction=new Ab.view.Restriction();}this.drawingPanel.setDraggableAssets(null);this.hideAssetPanel();}this.trigger("app:space:express:console:reselectLocationsForDrawing");if(!this.isLocateEvent&&this.drawingPanel.dwgLoaded){this.reHighlightSelectedAssets();}},switchRoomStandardIconStatus:function(enabled){var innerThis=this;if(this.copyOfRoomStandardElement==null){this.drawingPanel.actions.each(function(action){if(action.id=="drawingMenu"){innerThis.copyOfRoomStandardElement=action;action.enable(enabled);}});}else{this.copyOfRoomStandardElement.enable(enabled);}},resetRoomsData:function(){this.selectedRooms=new Ab.space.express.console.Rooms();this.assignedRooms=new Ab.space.express.console.Rooms();this.movedEmployeesRooms=new Ab.space.express.console.Rooms();},swithOptionForMode:function(){if(this.mode=="employeeMode"){if(this.drawingPanel.dwgLoaded){this.drawingPanel.setDataSource("labels","labelEmployeesDs");}}else{var spaceHighlightDs=this.drawingPanel.currentHighlightDS;if(!spaceHighlightDs||spaceHighlightDs==""||spaceHighlightDs=="None"){this.drawingPanel.setDataSource("highlight","highlightDivisionsDs");}}},onDrawingPanelMultipleSelectionChange:function(){var drawingPanel=View.getControl("","drawingPanel");var selectedAssetsMap=drawingPanel.getMultipleSelectedAssets();if(selectedAssetsMap.length>0){for(var i=0;i<selectedAssetsMap.length;i++){this.onClickRoom(selectedAssetsMap[i].pks,selectedAssetsMap[i].selected);}}},addFloorPlan:function(row){this.fireBuildingCheckEvent(row);this.drawingPanel.addDrawing(row,null);if(this.drawingPanel.dwgLoaded&&this.mode=="employeeMode"){this.drawingPanel.showAssetPanel("em");}},refresh:function(filter){this.setFilter(filter);this.trigger("app:space:express:console:cancelSelectedRooms");this.refreshDrawing();},refreshDrawing:function(){for(var i=0;i<View.dataSources.length;i++){var ds=View.dataSources.get(i);if(ds.type==="DrawingControlHighlight"){ds.addParameters(this.filter.parameters);ds.setRestriction(this.filter.restriction);}}if(this.drawingPanel.dwgLoaded){this.drawingPanel.clearPersistFills();this.drawingPanel.refresh();}},fireBuildingCheckEvent:function(row){var buildingId=row.row.getFieldValue("rm.bl_id");var floorId=row.row.getFieldValue("rm.fl_id");var dwgname=row.row.getFieldValue("rm.dwgname");this.selectedFloors=_.reject(this.selectedFloors,function(selectedFloor){return selectedFloor.bl_id===buildingId&&selectedFloor.fl_id===floorId;});if(row.row.isSelected()){this.selectedFloors.push({bl_id:buildingId,fl_id:floorId,dwgname:dwgname});}},handleSelectDataSource:function(){if(this.drawingPanel.dwgLoaded){for(var i=0;i<View.dataSources.length;i++){var ds=View.dataSources.get(i);if(ds.type==="DrawingControlHighlight"){ds.addParameters(this.filter.parameters);ds.setRestriction(this.filter.restriction);}}var highlightDS=this.drawingPanel.currentHighlightDS;var labelsDS=this.drawingPanel.currentLabelsDS;if(highlightDS==""){highlightDS="highlightDivisionsDs";}if(labelsDS==""){labelsDS="labelDivisionsDs";}this.drawingPanel.setDataSource("highlight",highlightDS);this.drawingPanel.setDataSource("labels",labelsDS);this.drawingPanel.clearPersistFills();this.reHighlightSelectedAssets.defer(1,this);}},reHighlightSelectedAssets:function(){if(this.mode==="spaceMode"){if(this.assignedRooms.length>0){this.reHighlightPendingAssignments();}if(this.selectedRooms.length>0){this.reHighlightSelectedRooms();}}else{if(this.selectedRooms.length>0){this.reHighlightSelectedRooms();}if(this.movedEmployeesRooms.length>0){this.reHighlightEmployeesMovedRooms();}}},reHighlightSelectedRooms:function(){for(var i=0;i<this.selectedFloors.length;i++){var selectedFloor=this.selectedFloors[i];var targetBlId=selectedFloor.bl_id;var targetFlId=selectedFloor.fl_id;var roomsArray=this.selectedRooms.targetToArray(targetBlId,targetFlId);if(roomsArray.length>0){if(this.drawingPanel.dwgLoaded){this.drawingPanel.selectAssets(roomsArray);}}}},reHighlightPendingAssignments:function(){for(var i=0;i<this.selectedFloors.length;i++){var selectedFloor=this.selectedFloors[i];var targetBlId=selectedFloor.bl_id;var targetFlId=selectedFloor.fl_id;var roomsArray=this.assignedRooms.targetToArray(targetBlId,targetFlId);if(roomsArray.length>0){if(this.drawingPanel.dwgLoaded){this.drawingPanel.selectAssets(roomsArray);}}}},reHighlightEmployeesMovedRooms:function(){for(var i=0;i<this.selectedFloors.length;i++){var selectedFloor=this.selectedFloors[i];var targetBlId=selectedFloor.bl_id;var targetFlId=selectedFloor.fl_id;var roomsArray=this.movedEmployeesRooms.targetToArray(targetBlId,targetFlId);if(roomsArray.length>0){if(this.drawingPanel.dwgLoaded){for(var j=0;j<roomsArray.length;j++){var room=roomsArray[j];var dwgname=this.getDwgnameByBlIdAndFlId(room[0],room[1]);this.reHighlightRoom.defer(50,this,[room[0]+";"+room[1]+";"+room[2],dwgname]);}}}}},afterCommitRoomsAlteration:function(){this.selectedRooms=new Ab.space.express.console.Rooms();this.drawingPanel.clearPersistFills();this.drawingPanel.refresh();},cancelEmployeeAssignment:function(){this.clearAssignmentTarget();if(!this.drawingPanel.getDrawingControl()){return;}this.drawingPanel.clearPersistFills();this.drawingPanel.refresh();this.trigger("app:space:express:console:cancelAssignment");},getDwgnameByBlIdAndFlId:function(buildingId,floorId){for(var i=0;i<this.selectedFloors.length;i++){var floor=this.selectedFloors[i];if(floor.bl_id==buildingId&&floor.fl_id==floorId){return floor.dwgname;}}return null;},isFloorSelected:function(buildingId,floorId){return valueExists(_.find(this.selectedFloors,function(selectedFloor){return(selectedFloor.bl_id===buildingId&&selectedFloor.fl_id===floorId);}));},loadAndHighlightSelectedEmployees:function(employees){this.drawingPanel.setDataSource("highlight","None");this.isLocateEvent=true;this.selectedEmployeeRows=this.employeeGrid.getSelectedRows();var nextRow=this.selectedEmployeeRows.pop();this.fireBuildingCheckEvent(nextRow);this.drawingPanel.clear();this.drawingPanel.currentHighlightDS="";this.drawingPanel.setDataSource("labels","labelEmployeesDs");this.drawingPanel.highlightAssets(null,nextRow);this.zoomIn.defer(500,this,[nextRow["rm.bl_id"],nextRow["rm.fl_id"],nextRow["rm.rm_id"],nextRow["rm.dwgname"]]);this.setIsLocateEvent.defer(500,this,[false]);},loadAndHighlightSelectedRoom:function(room){this.drawingPanel.setDataSource("highlight","None");this.isLocateEvent=true;var row=this.roomsGrid.rows[this.roomsGrid.selectedRowIndex];this.fireBuildingCheckEvent(row);this.drawingPanel.clear();this.drawingPanel.currentHighlightDS="";this.drawingPanel.setDataSource("labels","labelEmployeesDs");this.drawingPanel.highlightAssets(null,row);this.zoomIn.defer(500,this,[room[0].bl_id,room[0].fl_id,room[0].rm_id,room[0].dwgname]);this.setIsLocateEvent.defer(500,this,[false]);},setIsLocateEvent:function(flag){this.isLocateEvent=flag;},zoomIn:function(bl_id,fl_id,rm_id,dwgname){var dcl=new Ab.drawing.DwgCtrlLoc(bl_id,fl_id,rm_id,dwgname);var opts=new DwgOpts();opts.rawDwgName=dwgname;this.drawingPanel.findAsset(dcl,opts,true,true,false);},highlightRooms:function(rows){this.drawingPanel.setDataSource("highlight","None");if(rows.length>0){this.drawingPanel.clearHighlights();for(var i=0;i<rows.length;i++){var opts_selectable=new DwgOpts();opts_selectable.rawDwgName=rows[i].dwgname;opts_selectable.appendRec(rows[i].bl_id+";"+rows[i].fl_id+";"+rows[i].rm_id);this.drawingPanel.setSelectColor("0xFFFF00");this.drawingPanel.highlightAssets(opts_selectable);}}if(rows.length==1){this.zoomIn(rows[0].bl_id,rows[0].fl_id,rows[0].rm_id,rows[0].dwgname);}},onClickRoom:function(pk,selected){var room={bl_id:pk[0],fl_id:pk[1],rm_id:pk[2]};if(this.mode==="spaceMode"){this.onClickRoomInSpaceMode(room,selected);}else{this.onClickRoomInEmployeeMode(room,selected);}},onClickRoomInSpaceMode:function(room,selected){if(this.assignmentTarget!=null){this.updateLocalRoomForReHighlight(this.assignedRooms,room,selected);}else{this.updateLocalRoomForReHighlight(this.selectedRooms,room,selected);}this.trigger("app:space:express:console:selectRoom",room,selected);},onClickRoomInEmployeeMode:function(room,selected){if(this.assignmentTarget!=null){if(this.isProhibitAssignEmployee()){this.drawingPanel.unselectAssets(this.getAssetForRoom(room));View.alert("Please first select an employee, then click on a room");return;}this.processAssignEmployees(room,selected);this.updateLocalRoomForReHighlight(this.movedEmployeesRooms,room,selected);}else{this.updateLocalRoomForReHighlight(this.selectedRooms,room,selected);this.trigger("app:space:express:console:selectRoom",room,selected);}},isProhibitAssignEmployee:function(){var rows=this.employeeGrid.getSelectedRows();return rows.length==0;},processAssignEmployees:function(room,selected){var appendRec=room.bl_id+";"+room.fl_id+";"+room.rm_id;var dwgname=this.getDwgnameByBlIdAndFlId(room.bl_id,room.fl_id);this.drawingPanel.unselectAssets(this.getAssetForRoom(room));if(selected){if(checkIfOverCapacity(room.bl_id,room.fl_id,room.rm_id)){var innerThis=this;View.confirm(getMessage("countOver"),function(button){if(button=="yes"){innerThis.trigger("app:space:express:console:selectRoom",room,selected);innerThis.reHighlightRoom(appendRec,dwgname);}else{var roomAssigned=innerThis.isRoomAssigned(room);if(!roomAssigned){innerThis.rollbackEmployeeAssignment(room);}}});}else{this.trigger("app:space:express:console:selectRoom",room,selected);this.reHighlightRoom(appendRec,dwgname);}}},isRoomAssigned:function(room){var currentPendingAssignments=this.drawingPanel.getSidecar().get("pendingAssignments");for(var i=0;i<currentPendingAssignments.models.length;i++){var assignment=currentPendingAssignments.models[i];var bl_id=assignment.attributes.to_bl_id;var fl_id=assignment.attributes.to_fl_id;var rm_id=assignment.attributes.to_rm_id;if(room.bl_id==bl_id&&room.fl_id==fl_id&&room.rm_id==rm_id){return true;}}return false;},updateLocalRoomForReHighlight:function(roomContainer,room,selected){if(selected){if(!roomContainer.findRoom(room)){roomContainer.addRoom(room);}}else{roomContainer.removeRoom(room);}},hideAssetPanel:function(){if(this.assetPanelCreated){this.drawingPanel.closeAssetPanel("em");}},refreshAssetPanel:function(){if(!this.drawingPanel.getDrawingControl()){return;}this.drawingPanel.clearPersistFills();this.drawingPanel.refresh();if(!this.assetPanelCreated){var restriction=new Ab.view.Restriction();restriction.addClause("em.em_id","none","=");this.employeesWaitingDS.setRestriction(restriction);this.drawingPanel.enableAssetPanel("em",getMessage("assetPanelTitle"),"employeesWaitingDS",{actions:[],filter:false,size:{width:400,height:200},font:{fontFamily:"Arial",fontSize:"11"},selectionColor:"#FFEAC6"});this.drawingPanel.addEventListener("onAssetLocationChange",this.onDropAsset.createDelegate(this));this.drawingPanel.addAssetPanelRowAction({type:"em",title:getMessage("removeButton"),icon:Ab.view.View.contextPath+"/schema/ab-core/graphics/delete.gif",handler:this.onRemoveEmployeeWaiting.createDelegate(this)});this.assetPanelCreated=true;}else{if(this.mode=="employeeMode"){this.drawingPanel.showAssetPanel("em");this.refreshEmployeeWaitingPanel();}else{this.drawingPanel.closeAssetPanel("em");}}},onDropAsset:function(record,assetType,dwgname){if(assetType=="em"){var assignment=this.createEmployeeAssignmentFromDrawingRecord(record);var bl_id=assignment.to_bl_id;var fl_id=assignment.to_fl_id;var rm_id=assignment.to_rm_id;var room={bl_id:bl_id,fl_id:fl_id,rm_id:rm_id};if(checkIfOverCapacity(bl_id,fl_id,rm_id,true)&&rm_id!=""){var innerThis=this;View.confirm(getMessage("countOver"),function(button){if(button=="yes"){innerThis.trigger("app:space:express:console:moveEmployee",assignment);if(!innerThis.movedEmployeesRooms.findRoom(room)){innerThis.movedEmployeesRooms.addRoom(room);}innerThis.removeEmployeeWaiting(assignment);innerThis.refreshEmployeeWaitingPanel();innerThis.reHighlightRoom.defer(50,innerThis,[bl_id+";"+fl_id+";"+rm_id,dwgname]);}else{assignment.to_bl_id="";assignment.to_fl_id="";assignment.to_rm_id="";innerThis.trigger("app:space:express:console:moveEmployee",assignment);if(innerThis.movedEmployeesRooms.findRoom(room)){innerThis.movedEmployeesRooms.removeRoom(room);}innerThis.employeesWaiting.push(assignment.em_id);innerThis.refreshEmployeeWaitingPanel();innerThis.refreshDrawing();innerThis.reHighlightSelectedAssets();}});}else{this.trigger("app:space:express:console:moveEmployee",assignment);if(rm_id!=""){if(!this.movedEmployeesRooms.findRoom(room)){this.movedEmployeesRooms.addRoom(room);}this.removeEmployeeWaiting(assignment);this.reHighlightRoom.defer(50,this,[bl_id+";"+fl_id+";"+rm_id,dwgname]);}else{this.employeesWaiting.push(assignment.em_id);this.refreshEmployeeWaitingPanel();}}this.disableButtonIfReadOnlyUserGroup();}return true;},refreshEmployeeWaitingPanel:function(){var restriction=new Ab.view.Restriction();if(this.employeesWaiting.length>0){restriction.addClause("em.em_id",this.employeesWaiting,"IN");}else{restriction.addClause("em.em_id","none","=");}this.employeesWaitingDS.setRestriction(restriction);this.drawingPanel.refreshAssetPanel("em");},disableButtonIfReadOnlyUserGroup:function(){this.drawingPanel.actionbar.actions.each(function(action){if(action.id=="commitPendingAssignments"){action.enable(View.user.isMemberOfGroup("SPACE-CONSOLE-ALL-ACCESS"));}});},reHighlightRoom:function(appendRec,dwgname){var fillValue=new DwgFill();fillValue.bc=255;fillValue.bt=5;fillValue.bo=1;fillValue.fc=16776960;var opts_selectable=new DwgOpts();if(dwgname){opts_selectable.rawDwgName=dwgname;}opts_selectable.appendRec(appendRec,fillValue);opts_selectable.mode="none";this.drawingPanel.highlightAssets(opts_selectable);},updateEmployeesWaiting:function(assignment){if(assignment.to_bl_id===""){var deletedRoom={bl_id:assignment.bl_id,fl_id:assignment.fl_id,rm_id:assignment.rm_id};if(this.movedEmployeesRooms.findRoom(deletedRoom)){this.movedEmployeesRooms.removeRoom(deletedRoom);}this.employeesWaiting.push(assignment.em_id);}else{this.removeEmployeeWaiting(assignment);var addedRoom={bl_id:assignment.to_bl_id,fl_id:assignment.to_fl_id,rm_id:assignment.to_rm_id};if(!this.movedEmployeesRooms.findRoom(addedRoom)){this.movedEmployeesRooms.addRoom(addedRoom);}}},clearEmployeesWaiting:function(){this.employeesWaiting=[];},removeEmployeeWaiting:function(assignment){this.employeesWaiting=_.reject(this.employeesWaiting,function(em_id){return assignment.em_id===em_id;});},addEmployeeWaiting:function(assignments){for(var i=0;i<assignments.length;i++){this.updateEmployeesWaiting(assignments[i]);}this.refreshEmployeeWaitingPanel();},onRemoveEmployeeWaiting:function(record){var assignment=this.createEmployeeAssignmentFromDrawingRecord(record);this.removeEmployeeWaiting(assignment);this.refreshEmployeeWaitingPanel();this.trigger("app:space:express:console:removeEmployeeWaiting",assignment);},removeAssignment:function(assignment){this.removeEmployeeWaiting(assignment);this.refreshEmployeeWaitingPanel();var rooms=this.getAssignedRoom(assignment);if(this.mode=="spaceMode"){this.assignedRooms.removeRoom(assignment);}else{this.movedEmployeesRooms.removeRoom(assignment);this.drawingPanel.selectAssets(rooms);}this.drawingPanel.unselectAssets(rooms);},getAssignedRoom:function(assignment){var rooms=[];var room=[];room[0]=assignment.bl_id;room[1]=assignment.fl_id;room[2]=assignment.rm_id;rooms.push(room);return rooms;},getAssetForRoom:function(room){var rooms=[];var roomArray=[];roomArray[0]=room.bl_id;roomArray[1]=room.fl_id;roomArray[2]=room.rm_id;rooms.push(roomArray);return rooms;},unassignEmployees:function(assignments){for(var i=0;i<assignments.length;i++){this.removeEmployeeWaiting(assignments[i]);}this.refreshAssetPanel();},clearAssignmentTarget:function(){this.assignmentTarget=null;if(this.mode==="spaceMode"){this.assignedRooms=new Ab.space.express.console.Rooms();}else{this.movedEmployeesRooms=new Ab.space.express.console.Rooms();}},afterBeginAssignment:function(assignmentTarget,pendingAssignments){this.pendingAssignments=pendingAssignments;this.setToAssign(assignmentTarget);this.assignmentTarget=assignmentTarget;},afterChangeAssignmentTarget:function(assignmentTarget){this.assignmentTarget=assignmentTarget;this.setToAssign(assignmentTarget);},setToAssign:function(assignmentTarget){if(this.drawingPanel.getDrawingControl()&&this.drawingPanel.dwgLoaded){if(assignmentTarget.type==="division"){this.drawingPanel.setToAssign("rm.dv_id",assignmentTarget.dv_id);}else{if(assignmentTarget.type==="department"){this.drawingPanel.setToAssign("rm.dp_id",assignmentTarget.dp_id);}else{if(assignmentTarget.type==="category"){this.drawingPanel.setToAssign("rm.rm_cat",assignmentTarget.rm_cat);}else{if(assignmentTarget.type==="type"){this.drawingPanel.setToAssign("rm.rm_type",assignmentTarget.rm_type);}else{if(assignmentTarget.type==="standard"){this.drawingPanel.setToAssign("rm.rm_std",assignmentTarget.rm_std);}}}}}}},afterClearAssignment:function(){this.clearEmployeesWaiting();this.assignedRooms=new Ab.space.express.console.Rooms();if(this.mode=="employeeMode"){this.refreshEmployeeWaitingPanel();}this.assignmentTarget=null;if(this.drawingPanel.dwgLoaded){this.drawingPanel.clearAssignCache(false);this.afterCommitPendingAssignment();if(this.mode==="spaceMode"){this.hideAssetPanel();}}},createEmployeeAssignmentFromDrawingRecord:function(record){var assignment={type:"employee",to_bl_id:"",to_fl_id:"",to_rm_id:""};if(!record.from){record.from=record;}for(var i=0;i<record.from.length;i++){switch(record.from[i].name){case"em.em_id":assignment.em_id=record.from[i].value;break;case"em.bl_id":case"rm.bl_id":assignment.bl_id=record.from[i].value;break;case"em.fl_id":case"rm.fl_id":assignment.fl_id=record.from[i].value;break;case"em.rm_id":case"rm.rm_id":assignment.rm_id=record.from[i].value;break;case"em.location":var location=record.from[i].value;this.setLocationToAssignment(assignment,record,location);break;}}if(record.to){for(var i=0;i<record.to.length;i++){switch(record.to[i].name){case"rm.bl_id":assignment.to_bl_id=record.to[i].value;break;case"rm.fl_id":assignment.to_fl_id=record.to[i].value;break;case"rm.rm_id":assignment.to_rm_id=record.to[i].value;break;}}}return assignment;},setLocationToAssignment:function(assignment,record,location){if(location&&location.indexOf("-")!=-1){var locatioins=location.split("-");}assignment.bl_id=locatioins[0];assignment.fl_id=locatioins[1];assignment.rm_id=locatioins[2];},rollbackEmployeeAssignment:function(room){if(this.movedEmployeesRooms.findRoom(room)){this.movedEmployeesRooms.removeRoom(room);}this.drawingPanel.clearPersistFills();this.drawingPanel.refresh();this.reHighlightSelectedAssets.defer(1,this);},drawingPanel_onViewDetails:function(){var anchor=this.drawingPanel.actionbar.toolbar.el.dom;this.trigger("app:space:express:console:viewSelectedRooms",anchor);},drawingPanel_onCommitPendingAssignments:function(){if(this.mode=="employeeMode"&&confirmClearWaitingRoom()){this.trigger("app:space:express:console:commitAssignment");this.afterCommitPendingAssignment();}else{this.trigger("app:space:express:console:commitAssignment");this.afterCommitPendingAssignment();}},afterCommitPendingAssignment:function(){this.clearAssignmentTarget();this.drawingPanel.clearPersistFills();this.drawingPanel.refresh();},drawingPanel_onCancelPendingAssignments:function(){this.clearAssignmentTarget();this.drawingPanel.clearPersistFills();this.drawingPanel.refresh();this.trigger("app:space:express:console:cancelAssignment");},drawingPanel_onViewPendingAssignments:function(){var anchor=this.drawingPanel.actionbar.toolbar.el.dom;this.trigger("app:space:express:console:viewAssignment",anchor);},drawingPanel_onCancelSelectedRooms:function(){this.drawingPanel.clearPersistFills();this.selectedRooms=new Ab.space.express.console.Rooms();this.drawingPanel.refresh();this.trigger("app:space:express:console:cancelSelectedRooms");},onExportDrawingToPDF:function(){if("None"==this.drawingPanel.currentHighlightDS){View.showMessage(getMessage("noHighlight"));}else{if("highlightRoomStandard"==this.drawingPanel.currentHighlightDS||"labelRoomStandardDs"==this.drawingPanel.currentLabelsDS){View.showMessage(getMessage("noHighlightOnRoomStandard"));}else{this.trigger("app:space:express:console:printPDF",this.filter,this.drawingPanel,this.selectedFloors);}}}});function setLegendLabel(row,column,cellElement){var value=row[column.id];if(column.id=="legend.value"&&value!=""){var text=value;switch(value){case"0":text=getMessage("legendLevel0");break;case"1":text=getMessage("legendLevel1");break;case"2":text=getMessage("legendLevel2");break;case"3":text=getMessage("legendLevel3");break;case"4":text=getMessage("legendLevel4");break;}var contentElement=cellElement.childNodes[0];if(contentElement){contentElement.nodeValue=text;}}}function openRoomStandardTab(action){if(spaceExpressConsoleDrawing.mode!="spaceMode"){if(action.checked){action.setChecked(false);View.showMessage("message","room standard tab is only available in space mode");}}else{spaceExpressConsoleDrawing.trigger("app:space:express:console:openRoomStandardTab",action);}}var spaceExpressConsoleEmployees=View.createController("spaceExpressConsoleEmployees",{isLocatingEmployee:false,emFilter:null,events:{"click #employeeRestrictToLocation":function(){this.onCheckEvent();},"click #employeeUnassigned":"toggleUnassigned"},afterCreate:function(){this.on("app:space:express:console:filter",this.refresh);this.on("app:space:express:console:changeMode",this.afterChangeMode);this.on("app:space:express:console:setLocateEmployeeFlag",this.setLocateEmployeeFlag);},afterViewLoad:function(){var template=_.template('<td class="checkbox-container"><input type="checkbox" id="employeeRestrictToLocation" checked="false"/><span id="employeesResMessageSpan">{{restrictToLocation}}</span>&nbsp;&nbsp;<input type="checkbox" id="employeeUnassigned"/><span>{{unassigned}}</span></td>');Ext.DomHelper.insertHtml("afterBegin",this.employeeGrid.toolbar.tr,template(View.messages));Ext.fly("employeeRestrictToLocation").setDisplayed(false);Ext.fly("employeesResMessageSpan").setDisplayed(false);this.employeeGrid.actionbar.actions.each(function(action){action.show(true);});this.enableSortLocationAndOrganization();},afterInitialDataFetch:function(){this.hidePagingForVirtualColumn();},hidePagingForVirtualColumn:function(){var locationHeader=getMessage("locationHeader");var organizationHeader=getMessage("organizationHeader");var nameHeader=getMessage("nameHeader");var editHeader=getMessage("editHeader");var pageNext=getMessage("pageNext");var customizedHeaders=jQuery("#grid_employeeGrid_header").find("th[id*='sortHeader'] div:contains("+locationHeader+"), th[id*='sortHeader'] div:contains("+organizationHeader+"), th[id*='sortHeader'] div:contains("+nameHeader+")");jQuery(customizedHeaders).each(function(){jQuery(this).parent().on("click",function(){jQuery("#grid_employeeGrid_footer a").text("");});});jQuery("#grid_employeeGrid_header").find("th[id*='sortHeader']").each(function(){var text=jQuery(this).find("div").text();if(text!=""&&text!=locationHeader&&text!=organizationHeader&&text.indexOf(nameHeader)==-1&&text!=editHeader){jQuery(this).on("click",function(){jQuery("#grid_employeeGrid_footer a").text(pageNext);});}});},afterChangeMode:function(){this.employeeGrid.resizeColumnWidths();},enableSortLocationAndOrganization:function(){this.employeeGrid.setFilterConfiguration({columns:{"em.location":{fields:["rm.bl_id","rm.fl_id","rm.rm_id"],delimiter:"-",placeholders:["building","floor","room"]},"em.organization":{fields:["em.dv_id","em.dp_id"],delimiter:"-",placeholders:["division","department"]}}});},toggleUnassigned:function(){var unassigned=$("employeeUnassigned").checked;var searchStr=this.emFilter.searchValuesString+this.emFilter.otherSearchValuesString;var refreshRestriction=new Ab.view.Restriction();if(searchStr!=""){this.employeeGrid.addParameters(this.emFilter.parameters);}if(unassigned){refreshRestriction=this.getUnassignedRestriction();}if(!$("employeeRestrictToLocation").checked){this.employeeGrid.clearParameters();}this.employeeGrid.refresh(refreshRestriction);},refresh:function(filter){var parameterOccupancy=filter.parameters.occupancy;if(filter){this.emFilter=jQuery.extend(true,{},filter);this.trigger("app:space:express:console:setEmClauseToFilter",this.emFilter);if(filter.parameters.occupancy.indexOf("EXISTS")!=-1){this.emFilter.parameters.occupancy=this.createOccupancyRestriction();}var rmExists=" AND rm.bl_id ${sql.concat} rm.fl_id ${sql.concat} rm.rm_id is not null ";if(filter.parameters.organizationUnassigned.indexOf("IS NULL")!=-1){this.emFilter.parameters.organizationUnassigned=filter.parameters.organizationUnassigned+rmExists;}if(filter.parameters.typeUnassigned.indexOf("IS NULL")!=-1){this.emFilter.parameters.typeUnassigned=filter.parameters.typeUnassigned+rmExists;}if(filter.parameters.totalArea.indexOf("total_area")!=-1||filter.parameters.totalArea.indexOf("total_count")!=-1){this.emFilter.parameters.totalArea=getTotalAreaAndCountQueryParameter("em");}}abSpConsole_refreshDataFromFilter(this.employeeGrid,this.emFilter,this.getUnassignedRestriction());abSpConsole_toggleFromFilter("employeeRestrictToLocation",["employeeRestrictToLocation","employeesResMessageSpan"],"employeesResMessageSpan",this.emFilter.searchValuesString+this.emFilter.otherSearchValuesString);var checkedRecords=this.employeeGrid.getSelectedRows();this.checkOriginalRecords(checkedRecords);},createOccupancyRestriction:function(){var occupancy=" 1=1 ";if(Ext.get("occupancyVacant").dom.checked||Ext.get("occupancyAvailable").dom.checked||Ext.get("occupancyAtCapacity").dom.checked||Ext.get("occupancyExceedsCapacity").dom.checked){var checkedLength=jQuery("#div_checkbox_control input:checked").length;var and_Or=checkedLength>1&&occupancy.indexOf("EXISTS")!=-1?" OR ":" AND ";var capClause=" EXISTS (select 1 from rmcat where rmcat.rm_cat = rm.rm_cat and rmcat.occupiable = 1) AND rm.cap_em > 0 ";if(Ext.get("occupancyVacant").dom.checked){and_Or=checkedLength>1&&occupancy.indexOf("EXISTS")!=-1?" OR ":" AND ";occupancy+=and_Or+"("+capClause+" AND NOT EXISTS (SELECT bl_id, fl_id, rm_id FROM em  WHERE em.bl_id = rm.bl_id AND em.fl_id = rm.fl_id AND em.rm_id = rm.rm_id))";}if(Ext.get("occupancyAvailable").dom.checked){and_Or=checkedLength>1&&occupancy.indexOf("EXISTS")!=-1?" OR ":" AND ";occupancy+=and_Or+"("+capClause+" AND rm.cap_em > (SELECT COUNT(1) FROM em WHERE em.bl_id = rm.bl_id AND em.fl_id = rm.fl_id AND em.rm_id = rm.rm_id  GROUP BY em.bl_id, em.fl_id, em.rm_id))";}if(Ext.get("occupancyAtCapacity").dom.checked){and_Or=checkedLength>1&&occupancy.indexOf("EXISTS")!=-1?" OR ":" AND ";occupancy+=and_Or+"("+capClause+"  AND rm.cap_em = (SELECT COUNT(1) FROM em WHERE em.bl_id = rm.bl_id AND em.fl_id = rm.fl_id AND em.rm_id = rm.rm_id  GROUP BY em.bl_id, em.fl_id, em.rm_id))";}if(Ext.get("occupancyExceedsCapacity").dom.checked){and_Or=checkedLength>1&&occupancy.indexOf("EXISTS")!=-1?" OR ":" AND ";occupancy+=and_Or+"("+capClause+"  AND rm.cap_em < (SELECT COUNT(1) FROM em WHERE em.bl_id = rm.bl_id AND em.fl_id = rm.fl_id AND em.rm_id = rm.rm_id  GROUP BY em.bl_id, em.fl_id, em.rm_id))";}}return"("+occupancy+")";},onCheckEvent:function(){var employeeRestrict=$("employeeRestrictToLocation").checked;var unassigned=$("employeeUnassigned").checked;if(unassigned&&!employeeRestrict){this.emFilter.unassignedRes=this.getUnassignedRestriction();}abSpConsole_toggleFromCheckEvent("employeeRestrictToLocation",["employeeRestrictToLocation","employeesResMessageSpan"],"dpResMessageSpan",this.emFilter.searchValuesString+this.emFilter.otherSearchValuesString);abSpConsole_refreshDataFromCheckEvent("employeeRestrictToLocation",this.employeeGrid,this.emFilter,this.getUnassignedRestriction());var checkedRecords=this.employeeGrid.getSelectedRows();this.checkOriginalRecords(checkedRecords);this.emFilter.unassignedRes=null;},getUnassignedRestriction:function(){var unassigned=Ext.getDom("employeeUnassigned").checked;var restriction=new Ab.view.Restriction();if(unassigned){restriction.addClause("em.bl_id","","IS NULL");restriction.addClause("em.fl_id","","IS NULL");restriction.addClause("em.rm_id","","IS NULL");}return restriction;},checkOriginalRecords:function(checkedRecords){var checkedLocation=[];var rows=this.employeeGrid.rows;for(var i=0;i<rows.length;i++){var row=rows[i];for(var j=0;j<checkedRecords.length;j++){var checkedRow=checkedRecords[j];if(row["em.em_id"]==checkedRow["em.em_id"]){row.row.select();break;}}}if(checkedRecords&&checkedRecords.length>0){this.employeeGrid.actionbar.actions.each(function(action){action.enable(true);});}},employeeGrid_onMultipleSelectionChange:function(row){var employees=[];var rows=this.employeeGrid.getSelectedGridRows();for(var i=0;i<rows.length;i++){employees.push(this.createEmployeeAssignmentFromGridRow(rows[i]));}if(!this.isLocatingEmployee){this.trigger("app:space:express:console:beginAssignment",{type:"employee",employees:employees});}this.disableButtonIfReadOnlyUserGroup();},disableButtonIfReadOnlyUserGroup:function(){if(!View.user.isMemberOfGroup("SPACE-CONSOLE-ALL-ACCESS")){this.employeeGrid.actionbar.actions.each(function(action){if(action.id=="unassign"){action.enable(false);}});}},employeeGrid_onWaiting:function(){var assignments=[];var rows=this.employeeGrid.getSelectedGridRows();for(var i=0;i<rows.length;i++){assignments.push(this.createEmployeeAssignmentFromGridRow(rows[i]));}this.employeeGrid.refresh();this.trigger("app:space:express:console:addEmployeeWaiting",assignments);},employeeGrid_onUnassign:function(){var assignments=[];var rows=this.employeeGrid.getSelectedGridRows();var location="";for(var i=0;i<rows.length;i++){assignments.push(this.createEmployeeAssignmentFromGridRow(rows[i]));location+=(rows[i].getFieldValue("rm.bl_id")+rows[i].getFieldValue("rm.fl_id")+rows[i].getFieldValue("rm.rm_id"));}if(location!=""){var controller=this;var message=getMessage("unassignEmployeeWarning");View.confirm(message,function(button){if(button=="yes"){controller.employeeGrid.unselectAll();controller.trigger("app:space:express:console:unassignEmployees",assignments);}});}},createEmployeeAssignmentFromGridRow:function(row){return{type:"employee",em_id:row.getFieldValue("em.em_id"),bl_id:row.getFieldValue("rm.bl_id"),fl_id:row.getFieldValue("rm.fl_id"),rm_id:row.getFieldValue("rm.rm_id"),to_bl_id:"",to_fl_id:"",to_rm_id:""};},employeePendingAssignments_onRemovePendingAssignment:function(row){this.trigger("app:space:express:console:removeAssignment",{em_id:row.getFieldValue("em.em_id"),location:row.getFieldValue("em.to")});},employeePendingAssignments_onCancelEmployeePendingAssignments:function(){this.trigger("app:space:express:console:cancelEmployeeAssignment");},employeePendingAssignments_onCommitEmployeePendingAssignments:function(){if(confirmClearWaitingRoom()){this.trigger("app:space:express:console:commitAssignment");View.closeDialog();}},editEmployeeForm_onSave:function(){if(this.editEmployeeForm.save()){this.employeeGrid.refresh();}},setLocateEmployeeFlag:function(flag){this.isLocatingEmployee=flag;},employeeGrid_afterRefresh:function(){jQuery("#employeeGrid_indexRow").remove();if(!View.user.isMemberOfGroup("SPACE-CONSOLE-ALL-ACCESS")){jQuery("#employeeGrid input[type=checkbox]").attr("disabled","true");}var nameHeader=getMessage("nameHeader");var th=jQuery("#grid_employeeGrid_header th[id*='sortHeader'] div:contains("+nameHeader+")").parent();var index=jQuery("#grid_employeeGrid_header th[id*='sortHeader']").index(th.get(0));jQuery("#grid_employeeGrid_body tr").each(function(){var $td=jQuery(this).find("td:eq("+index+"):contains(',')");var textWithComma=jQuery($td).text().replace(",",",&nbsp;&nbsp;");jQuery($td).empty().append(textWithComma);if(!/\S[\,]\s\s\S/.test(jQuery($td).text())){var newText=jQuery($td).text().replace(",","");jQuery($td).empty().append(jQuery.trim(newText));}});}});function locateEmployee(){var thisController=View.controllers.get("spaceExpressConsoleEmployees");var employeeGrid=View.panels.get("employeeGrid");var rowIndex=employeeGrid.rows[employeeGrid.selectedRowIndex];employeeGrid.unselectAll();rowIndex.row.select();var em_id=rowIndex["em.em_id"];var bl_id=rowIndex["rm.bl_id"];var fl_id=rowIndex["rm.fl_id"];var rm_id=rowIndex["rm.rm_id"];var dwgname=rowIndex["rm.dwgname"];var employees=[];employees.push({em_id:em_id,bl_id:bl_id,fl_id:fl_id,rm_id:rm_id,dwgname:dwgname});thisController.trigger("app:space:express:console:setLocateEmployeeFlag",true);thisController.trigger("app:space:express:console:locateEmployeesOrRooms",employees,true);employeeGrid.unselectAll();thisController.trigger("app:space:express:console:setLocateEmployeeFlag",false);}function exportEmToXLS(){doEmCustomExport(Ab.grid.ReportGrid.WORKFLOW_RULE_XLS_REPORT,"xls");}function exportEmToDOCX(){doEmCustomExport(Ab.grid.ReportGrid.WORKFLOW_RULE_DOCX_REPORT,"docx");}function doEmCustomExport(workflowRuleName,outputType){var ds="employeeDS";var categoryFieldsArray=[abSpConsole_getFieldDef(ds,"em.em_id"),abSpConsole_getFieldDef(ds,"em.location"),abSpConsole_getFieldDef(ds,"em.organization"),abSpConsole_getFieldDef(ds,"em.total_area")];var employeeRestrictToLocationChecked=Ext.getDom("employeeRestrictToLocation").checked;var employeeUnassignedChecked=Ext.getDom("employeeUnassigned").checked;var parameters=spaceExpressConsoleEmployees.emFilter.parameters;var hasRes=employeeRestrictToLocationChecked?true:false;if(!employeeRestrictToLocationChecked&&employeeUnassignedChecked){parameters={};}if(employeeUnassignedChecked){parameters.emUnassigned=" em.bl_id IS NULL AND em.fl_id IS NULL AND  em.rm_id IS NULL ";}var restriction=spaceExpressConsoleEmployees.emFilter.restriction;var printableRestrictions=getPrintableRestrictions(restriction,hasRes);parameters.printRestriction=hasRes;if(employeeUnassignedChecked){printableRestrictions.push({title:"Unassigned Employee",value:"[Yes]"});parameters.printRestriction=true;}if(hasRes){var em_id_value=View.panels.get("locationFilter").getFieldValue("em.em_id");if(valueExistsNotEmpty(em_id_value)){printableRestrictions.push({title:"Employee Code",value:em_id_value});}}parameters.printableRestriction=printableRestrictions;parameters.categoryFields=categoryFieldsArray;var roomStandardGrid=View.panels.get("employeeGrid");var jobId="";if(outputType=="xls"){jobId=roomStandardGrid.callXLSReportJob("Employee Report","",parameters);}else{jobId=roomStandardGrid.callDOCXReportJob("Employee Report","",parameters);}if(jobId!=null){var command=new Ab.command.exportPanel({});command.displayReport(jobId,outputType);}}var spaceExpressConsoleLocations=View.createController("spaceExpressConsoleLocations",{addNewAssetType:null,rowResForOpenDialog:null,filter:null,checkedRows:null,afterCreate:function(){this.on("app:space:express:console:filter",this.refresh);this.on("app:space:express:console:changeMode",this.afterChangeMode);this.on("app:space:express:console:locateEmployeesOrRooms",this.locateEmployeesOrRooms);this.on("app:space:express:console:locationFilter_onClearLocations",this.locationFilter_onClearLocations);this.on("app:space:express:console:reselectLocationsForDrawing",this.reselectLocationsForDrawing);this.on("app:space:express:console:setEmClauseToFilter",this.setEmClauseToFilter);},afterViewLoad:function(){jQuery("#locationsGrid_title").hide();$("occupancyVacantOnly").checked=false;var controller=this;this.locationsGrid.addEventListener("onMultipleSelectionChange",function(row){controller.trigger("app:space:express:console:selectLocation",row);});this.displayRecentSearches();this.showDefaultColumn();this.cascadeFiledVacant();},afterInitialDataFetch:function(){this.locationFilter_onFilterLocations();this.locationsGrid.enableSelectAll(false);},showDefaultColumn:function(){var maxDrawingsPerFloor=1;var records=this.drawingsPerFloorDS.getRecords();for(var i=0;i<records.length;i++){var drawingsPerFloor=records[i].getValue("rm.count_dwg");if(drawingsPerFloor>maxDrawingsPerFloor){maxDrawingsPerFloor=drawingsPerFloor;}}if(maxDrawingsPerFloor>1){this.locationsGrid.showColumn("rm.dwgname",true);}},cascadeFiledVacant:function(){document.getElementById("occupancyVacantOnly").onclick=function(){$("occupancyVacant").checked=$("occupancyVacantOnly").checked;$("occupancyAvailable").checked=false;$("occupancyAtCapacity").checked=false;$("occupancyExceedsCapacity").checked=false;};document.getElementById("occupancyVacant").onclick=function(){$("occupancyVacantOnly").checked=$("occupancyVacant").checked;};document.getElementById("div_checkbox_control").onclick=function(){if(jQuery("input:checked").length>1){$("occupancyVacantOnly").checked=false;}};},afterChangeMode:function(mode){this.locationFilter.showField("em.em_id",mode==="employeeMode");var filter=this.getFilterQueryCondition();this.filter=filter;},reselectLocationsForDrawing:function(){var checkedLocation=this.locationsGrid.getSelectedRows();for(var i=0;i<checkedLocation.length;i++){var row=checkedLocation[i];this.trigger("app:space:express:console:selectLocation",row);}},refresh:function(filter){var checkedLocation=this.locationsGrid.getSelectedRows();this.locationsGrid.clearParameters();this.locationsGrid.addParameters(filter.parameters);this.locationsGrid.refresh();this.showPreviousCheckedFloorPlan(checkedLocation);this.addRecentSearch();this.displayRecentSearches();},showPreviousCheckedFloorPlan:function(checkedLocation){var rows=this.locationsGrid.rows;for(var i=0;i<checkedLocation.length;i++){var rowChecked=false;for(var j=0;j<rows.length;j++){var row=rows[j];if(row["rm.bl_id"]+row["rm.fl_id"]==checkedLocation[i]["rm.bl_id"]+checkedLocation[i]["rm.fl_id"]){rowChecked=true;row.row.select();break;}}if(!rowChecked){var row=checkedLocation[i];row.row.unselect();this.trigger("app:space:express:console:selectLocation",row);}}},locateEmployeesOrRooms:function(employeesOrRooms,isLocateEmployee){if(employeesOrRooms[0].bl_id!=""&&employeesOrRooms[0].fl_id!=""&&employeesOrRooms[0].rm_id!=""){if(!this.isFlExistsInLocationGrid(employeesOrRooms[0].bl_id,employeesOrRooms[0].fl_id)){View.alert(getMessage("emNotExistsInFilter"));}else{var existsFlNotLoad=false;for(var i=0;i<employeesOrRooms.length;i++){var flag=this.isFlExistsInLocationGrid(employeesOrRooms[i].bl_id,employeesOrRooms[i].fl_id,true);if(!flag){existsFlNotLoad=true;break;}}if(existsFlNotLoad){this.checkIfSelectedRowsInLocationGrid(employeesOrRooms);if(isLocateEmployee){this.trigger("app:space:express:console:loadAndHighLightSelectedEmployees",employeesOrRooms);}else{this.trigger("app:space:express:console:loadAndHighLightSelectedRoom",employeesOrRooms);}}else{this.trigger("app:space:express:console:highlightRooms",employeesOrRooms);}}}},checkIfSelectedRowsInLocationGrid:function(rows){this.locationsGrid.unselectAll();var locationRows=this.locationsGrid.rows;for(var i=0;i<rows.length;i++){for(var j=0;j<locationRows.length;j++){var row=locationRows[j];if(row["rm.bl_id"]+row["rm.fl_id"]==rows[i].bl_id+rows[i].fl_id){row.row.select();break;}}}},getFilterQueryCondition:function(){var organizationUnassigned=$("organizationUnassigned").checked?" rm.dv_id IS NULL AND rm.dp_id IS NULL ":"1=1";var typeUnassigned=$("typeUnassigned").checked?" rm.rm_cat IS NULL AND rm.rm_type IS NULL ":"1=1";var filter={restriction:new Ab.view.Restriction(),parameters:{totalArea:this.getTotalAreaQueryParameter(),occupancy:this.createOccupancyRestriction(),organizationUnassigned:organizationUnassigned,typeUnassigned:typeUnassigned},searchValuesString:"",otherSearchValuesString:this.getSearchString()};var controller=this;_.each(["rm.dv_id","rm.dp_id","rm.bl_id","rm.fl_id","rm.rm_id"],function(fieldName){controller.addFilterValue(filter,controller.locationFilter,fieldName);});_.each(["rm.rm_cat","rm.rm_type"],function(fieldName){controller.addFilterValue(filter,controller.locationFilterOptions,fieldName);});return filter;},setEmClauseToFilter:function(filter){var emClause=this.getQueryParameter(filter,this.locationFilter,"em.em_id",true);var emRestrictioin=" exists (select 1 from em where em.bl_id = rm.bl_id AND em.fl_id = rm.fl_id AND em.rm_id = rm.rm_id and "+emClause+")";var value=this.locationFilter.getFieldValue("em.em_id");filter.parameters.emRestriction=value?emRestrictioin:"1=1";filter.parameters.emClause=emClause;},locationFilter_onFilterLocations:function(){var filter=this.getFilterQueryCondition();this.filter=filter;if(filter.searchValuesString+filter.otherSearchValuesString==""){jQuery("#dpRestriction").hide();jQuery("#catRestriction").hide();jQuery("#roomsRestriction").hide();jQuery("#employeeRestrictToLocation").hide();jQuery("#employeesResMessageSpan").hide();jQuery("#roomStandardRestriction").hide();jQuery("#totalArea").val("");jQuery("#totalRooms").val("");}this.trigger("app:space:express:console:filter",filter);},locationFilter_onClearLocations:function(){this.clearLocations();var filter=this.getFilterQueryCondition();this.filter=filter;this.trigger("app:space:express:console:filter",filter);},clearLocations:function(){this.locationFilter.clear();this.locationFilterOptions.clear();$("occupancyVacantOnly").checked=false;$("occupancyVacant").checked=false;$("occupancyAvailable").checked=false;$("occupancyAtCapacity").checked=false;$("occupancyExceedsCapacity").checked=false;$("occupancyWithTotalArea").checked=false;$("occupancyWithTotalRooms").checked=false;$("organizationUnassigned").checked=false;$("typeUnassigned").checked=false;jQuery("#dpRestriction").hide();jQuery("#catRestriction").hide();jQuery("#roomsRestriction").hide();jQuery("#employeeRestrictToLocation").hide();jQuery("#employeesResMessageSpan").hide();jQuery("#roomStandardRestriction").hide();jQuery("#totalArea").val("");jQuery("#totalRooms").val("");},isFlExistsInLocationGrid:function(buildingId,floorId,onlySelect){var rows=this.locationsGrid.rows;if(arguments.length==3&&onlySelect==true){rows=this.locationsGrid.getSelectedRows();}var flag=false;for(var i=0;i<rows.length;i++){var row=rows[i];if(row["rm.bl_id"]+row["rm.fl_id"]==buildingId+floorId){flag=true;break;}}return flag;},locationFilter_onMoreOptions:function(panel,action){this.locationFilterOptions.toggleCollapsed();action.setTitle(this.locationFilterOptions.collapsed?getMessage("locationFilterMore"):getMessage("locationFilterLess"));this.locationsGrid.updateHeight();},onSelectRecentSearch:function(search){this.clearLocations();_.each(search.locationFilter,function(filterObject){spaceExpressConsoleLocations.locationFilter.setFieldValue(filterObject.field,filterObject.value);});_.each(search.locationFilterOptions,function(filterObject){spaceExpressConsoleLocations.locationFilterOptions.setFieldValue(filterObject.field,filterObject.value);});for(var attr in search.otherFilter){jQuery("#"+attr).attr("checked",true);if(attr=="totalArea"){jQuery("#occupancyWithTotalArea").attr("checked",true);jQuery("#totalAreaOp").val(search.otherFilter.totalArea[0]);jQuery("#totalArea").val(search.otherFilter.totalArea[1]);}if(attr=="totalCount"){jQuery("#occupancyWithTotalRooms").attr("checked",true);jQuery("#totalRoomsOp").val(search.otherFilter.totalCount[0]);jQuery("#totalRooms").val(search.otherFilter.totalCount[1]);}}this.locationFilter_onFilterLocations();},displayRecentSearches:function(){var controller=this;var recentSearchMenu=this.locationFilter.actions.get("recentSearchMenu");recentSearchMenu.clear();var sidecar=this.locationFilter.getSidecar();var filterObject=sidecar.get("myRecentSearches");_.each(filterObject,function(search,index){var title="";_.each(search.locationFilter,function(object){title+=("  "+object.value);});_.each(search.locationFilterOptions,function(object){title+=("   "+object.value);});var str="";for(var p in search.otherFilter){str+=p+",";}if(str!=""){title+="  "+JSON.stringify(search.otherFilter).replace(/:true/gi,"").replace(/"/gi,"").replace("{","").replace("}","");}recentSearchMenu.addAction(index,title,controller.onSelectRecentSearch.createDelegate(controller,[search]));});},addRecentSearch:function(){var search=this.getFilterArray();var sidecar=this.locationFilter.getSidecar();var myRecentSearches=sidecar.get("myRecentSearches");var newRecentSearches=[];if(search){var existsInRecent=false;if(typeof(myRecentSearches)!="undefined"){for(var i=0;i<myRecentSearches.length;i++){if(JSON.stringify(search)==JSON.stringify(myRecentSearches[i])){existsInRecent=true;}}}if(!existsInRecent){newRecentSearches.push(search);if(typeof(myRecentSearches)!="undefined"){newRecentSearches=newRecentSearches.concat(myRecentSearches);}sidecar.set("myRecentSearches",newRecentSearches);sidecar.save();}}},getFilterArray:function(){var filterObject={locationFilter:[],locationFilterOptions:[],otherFilter:{}};_.each(["rm.dv_id","rm.dp_id","rm.bl_id","rm.fl_id","rm.rm_id"],function(fieldName){var value=spaceExpressConsoleLocations.locationFilter.getFieldValue(fieldName);if(value!=""){filterObject.locationFilter.push({field:fieldName,value:value});}});_.each(["rm.rm_cat","rm.rm_type"],function(fieldName){var value=spaceExpressConsoleLocations.locationFilterOptions.getFieldValue(fieldName);if(value!=""){filterObject.locationFilterOptions.push({field:fieldName,value:value});}});_.each(["organizationUnassigned","typeUnassigned","occupancyVacantOnly","occupancyVacant","occupancyAvailable","occupancyAtCapacity","occupancyExceedsCapacity"],function(fieldName){if($(fieldName).checked){filterObject.otherFilter[fieldName]=true;}});_.each(["occupancyWithTotalArea","occupancyWithTotalRooms"],function(fieldName){if($(fieldName).checked){if(fieldName=="occupancyWithTotalArea"){filterObject.otherFilter.totalArea=[Ext.get("totalAreaOp").dom.value,Ext.get("totalArea").dom.value];}else{filterObject.otherFilter.totalCount=[Ext.get("totalRoomsOp").dom.value,Ext.get("totalRooms").dom.value];}}});var str="";for(var p in filterObject.otherFilter){str+=p+",";}if(filterObject.locationFilter.length==0&&filterObject.locationFilterOptions.length==0&&str==""){return null;}else{return filterObject;}},addFilterValue:function(filter,form,fieldName){this.addRestrictionClause(filter.restriction,form,fieldName);var parameterName=fieldName.split(".")[1];filter.parameters[parameterName]=this.getQueryParameter(filter,form,fieldName);},addRestrictionClause:function(restriction,panel,fieldName){if(panel.hasFieldMultipleValues(fieldName)){restriction.addClause(fieldName,panel.getFieldMultipleValues(fieldName),"IN");}else{var value=panel.getFieldValue(fieldName);if(value){restriction.addClause(fieldName,value,"=");}}},getQueryParameter:function(filter,panel,fieldName,hasLiteral){var queryParameter="";if(panel.hasFieldMultipleValues(fieldName)){var originalValues=panel.getFieldMultipleValues(fieldName);var values=[];if(arguments.length==4&&hasLiteral){for(var i=0;i<originalValues.length;i++){values.push(makeLiteral(originalValues[i]));}}else{values=originalValues;}filter.searchValuesString=filter.searchValuesString+(filter.searchValuesString?",":"")+values;queryParameter=" IN ('"+values.join("','")+"')";}else{var value=panel.getFieldValue(fieldName);if(value){filter.searchValuesString=filter.searchValuesString+(filter.searchValuesString?",":"")+value;if(arguments.length==4&&hasLiteral){queryParameter=" = '"+makeLiteral(value)+"'";}else{queryParameter=" = '"+value+"'";}}}if(queryParameter){return fieldName+queryParameter;}else{return"1=1";}},createOccupancyRestriction:function(){var occupancy=" 1=1 ";if(Ext.get("occupancyVacant").dom.checked||Ext.get("occupancyAvailable").dom.checked||Ext.get("occupancyAtCapacity").dom.checked||Ext.get("occupancyExceedsCapacity").dom.checked){var checkedLength=jQuery("#div_checkbox_control input:checked").length;var and_Or=checkedLength>1&&occupancy.indexOf("EXISTS")!=-1?" OR ":" AND ";var capClause=" EXISTS (select 1 from rmcat where rmcat.rm_cat = rm.rm_cat and rmcat.occupiable = 1) AND rm.cap_em > 0 ";if(Ext.get("occupancyVacant").dom.checked){and_Or=checkedLength>1&&occupancy.indexOf("EXISTS")!=-1?" OR ":" AND ";occupancy+=and_Or+"("+capClause+" AND NOT EXISTS (SELECT bl_id, fl_id, rm_id FROM em  WHERE em.bl_id = rm.bl_id AND em.fl_id = rm.fl_id AND em.rm_id = rm.rm_id))";}if(Ext.get("occupancyAvailable").dom.checked){and_Or=checkedLength>1&&occupancy.indexOf("EXISTS")!=-1?" OR ":" AND ";occupancy+=and_Or+"("+capClause+" AND rm.cap_em > (SELECT COUNT(1) FROM em WHERE em.bl_id = rm.bl_id AND em.fl_id = rm.fl_id AND em.rm_id = rm.rm_id  GROUP BY em.bl_id, em.fl_id, em.rm_id))";}if(Ext.get("occupancyAtCapacity").dom.checked){and_Or=checkedLength>1&&occupancy.indexOf("EXISTS")!=-1?" OR ":" AND ";occupancy+=and_Or+"("+capClause+"  AND rm.cap_em = (SELECT COUNT(1) FROM em WHERE em.bl_id = rm.bl_id AND em.fl_id = rm.fl_id AND em.rm_id = rm.rm_id  GROUP BY em.bl_id, em.fl_id, em.rm_id))";}if(Ext.get("occupancyExceedsCapacity").dom.checked){and_Or=checkedLength>1&&occupancy.indexOf("EXISTS")!=-1?" OR ":" AND ";occupancy+=and_Or+"("+capClause+"  AND rm.cap_em < (SELECT COUNT(1) FROM em WHERE em.bl_id = rm.bl_id AND em.fl_id = rm.fl_id AND em.rm_id = rm.rm_id  GROUP BY em.bl_id, em.fl_id, em.rm_id))";}}return"("+occupancy+")";},getTotalAreaQueryParameter:function(){var areaAndCount=" 1=1 ";var checkTotalArea=Ext.get("occupancyWithTotalArea").dom.checked&&Ext.get("totalArea").dom.value!="";var checkTotalRooms=Ext.get("occupancyWithTotalRooms").dom.checked&&Ext.get("totalRooms").dom.value!="";var totalAreaValue=Ext.get("totalArea").dom.value;if(checkTotalArea&&isNaN(totalAreaValue)){alert("The total area value should be a number");return;}var totalRoomCount=Ext.get("totalRooms").dom.value;if(checkTotalRooms&&isNaN(totalRoomCount)){alert("The total room count should be a number");return;}var areaRestriction=" total_area "+Ext.get("totalAreaOp").dom.value+" "+Ext.get("totalArea").dom.value;var roomsRestriction=" total_count "+Ext.get("totalRoomsOp").dom.value+" "+Ext.get("totalRooms").dom.value;if(checkTotalArea&&checkTotalRooms){areaAndCount=areaRestriction+" AND "+roomsRestriction;}else{if(checkTotalArea&&!checkTotalRooms){areaAndCount=areaRestriction;}else{if(!checkTotalArea&&checkTotalRooms){areaAndCount=roomsRestriction;}}}return areaAndCount;},getFloorTotalsRestriction:function(){var restriction=new Ab.view.Restriction();if(Ext.get("occupancyWithTotalArea").dom.checked){restriction.addClause("rm.area_rm",Ext.get("totalArea").dom.value,Ext.get("totalAreaOp").dom.value);}if(Ext.get("occupancyWithTotalRooms").dom.checked){}return restriction;},getSearchString:function(){var result="";if($("organizationUnassigned").checked){result+=" Unassigned Organization, ";}if($("typeUnassigned").checked){result+=" Unassigned Room Categories";}var occupancy="";if($("occupancyVacantOnly").checked){occupancy+=" Vacant only, ";}if($("occupancyVacant").checked){occupancy+=" Vacant, ";}if($("occupancyAvailable").checked){occupancy+=" Available, ";}if($("occupancyAtCapacity").checked){occupancy+=" At capacity, ";}if($("occupancyExceedsCapacity").checked){occupancy+=" Exceeds capacity, ";}if(jQuery("#div_checkbox_control input:checked").length>0){result+=" Occupancy:["+occupancy.substring(0,occupancy.length-2)+"]";}if($("occupancyWithTotalArea").checked){result+=" , With total area"+Ext.get("totalAreaOp").dom.value+" "+Ext.get("totalArea").dom.value;}if($("occupancyWithTotalRooms").checked){result+=" , With total room count"+Ext.get("totalRoomsOp").dom.value+" "+Ext.get("totalRooms").dom.value;}return result;},editBuildingForm_onSaveBuilding:function(){this.editBuildingForm.save();this.editBuildingForm.closeWindow();this.locationFilter_onFilterLocations();},editFloorForm_onSaveFloor:function(){this.editFloorForm.save();this.editFloorForm.closeWindow();this.locationFilter_onFilterLocations();},locationsGrid_afterRefresh:function(){if(!View.user.isMemberOfGroup("SPACE-CONSOLE-ALL-ACCESS")){jQuery("#locationsGrid a[id*='rm.bl_id'],#locationsGrid a[id*='rm.fl_id']").each(function(){jQuery(this).parent().html(jQuery(this).html());});}}});function addBl(){var panel=View.panels.get("editBuildingForm");panel.showInWindow({newRecord:true,width:1150,height:700,restriction:new Ab.view.Restriction(),title:getMessage("addBuilding")});}function addFl(){var panel=View.panels.get("editFloorForm");panel.showInWindow({newRecord:true,width:800,height:500,restriction:new Ab.view.Restriction(),title:getMessage("addFloor")});}function editBl(){var gridPanel=View.panels.get("locationsGrid");var panel=View.panels.get("editBuildingForm");var rowIndex=gridPanel.rows[gridPanel.selectedRowIndex];var bl_id="";if(rowIndex){bl_id=rowIndex["rm.bl_id"];}var restriction=new Ab.view.Restriction();restriction.addClause("rm.bl_id",bl_id);panel.showInWindow({newRecord:false,width:1150,height:700,restriction:restriction,title:getMessage("editBl")});panel.actions.get("deleteBuilding").enableButton(true);}function editFl(){var gridPanel=View.panels.get("locationsGrid");var panel=View.panels.get("editFloorForm");var rowIndex=gridPanel.rows[gridPanel.selectedRowIndex];var bl_id="",fl_id="",rm_id="";if(rowIndex){bl_id=rowIndex["rm.bl_id"];fl_id=rowIndex["rm.fl_id"];}var restriction=new Ab.view.Restriction();restriction.addClause("rm.bl_id",bl_id);restriction.addClause("rm.fl_id",fl_id);panel.showInWindow({newRecord:false,width:600,height:300,restriction:restriction,title:getMessage("editFloor")});panel.actions.get("deleteFloor").enableButton(true);}function exportLocationToXLS(){doLocationCustomExport(Ab.grid.ReportGrid.WORKFLOW_RULE_XLS_REPORT,"xls");}function exportLocationToDOCX(){doLocationCustomExport(Ab.grid.ReportGrid.WORKFLOW_RULE_DOCX_REPORT,"docx");}function doLocationCustomExport(workflowRuleName,outputType){var locationsGrid=View.panels.get("locationsGrid");var parameters=spaceExpressConsoleLocations.filter.parameters;var restriction=spaceExpressConsoleLocations.filter.restriction;var printableRestrictions=getPrintableRestrictions(restriction,true);parameters.printRestriction=printableRestrictions.length==0?false:true;parameters.printableRestriction=printableRestrictions;parameters.categoryFields=getCategoryFieldsArray(locationsGrid,"locationsDS");parameters.showTotals=locationsGrid.getParametersForRefresh().showTotals;parameters.showCounts=locationsGrid.getParametersForRefresh().showCounts;var jobId="";var locationReport=getMessage("locationReport");if(outputType=="xls"){jobId=locationsGrid.callXLSReportJob(locationReport,"",parameters);}else{jobId=locationsGrid.callDOCXReportJob(locationReport,"",parameters);}if(jobId!=null){var command=new Ab.command.exportPanel({});command.displayReport(jobId,outputType);}}function makeLiteral(value){return value.replace(/\'/g,"''");}var roomStandardController=View.createController("roomStandardController",{mode:"",rmFilter:null,events:{"click #roomStandardRestrictToLocation":function(){this.onCheckEvent();}},afterCreate:function(){this.on("app:space:express:console:filter",this.refresh);this.on("app:space:express:console:changeMode",this.changeMode);this.on("app:space:express:console:openRoomStandardTab",this.openRoomStandardTab);},afterViewLoad:function(){var template=_.template('<td class="checkbox-container" id="roomStandardRestriction"><input type="checkbox" id="roomStandardRestrictToLocation" checked="false"/><span id="roomStandardResMessageSpan">{{restrictToLocation}}</span></td>');Ext.DomHelper.insertHtml("afterBegin",this.roomStandardGrid.toolbar.tr,template(View.messages));Ext.fly("roomStandardRestriction").setDisplayed(false);this.roomStandardGrid.setColorOpacity(this.drawingPanel.getFillOpacity());},refresh:function(filter){if(filter){this.rmFilter=jQuery.extend(true,{},filter);var rmExists=" AND rm.bl_id ${sql.concat} rm.fl_id ${sql.concat} rm.rm_id is not null ";if(filter.parameters.typeUnassigned.indexOf("IS NULL")!=-1||filter.parameters.organizationUnassigned.indexOf("IS NULL")!=-1){this.rmFilter.parameters.typeUnassigned=filter.parameters.typeUnassigned+rmExists;}if(filter.parameters.totalArea.indexOf("total_area")!=-1||filter.parameters.totalArea.indexOf("total_count")!=-1){this.rmFilter.parameters.totalArea=getTotalAreaAndCountQueryParameter();}}abSpConsole_refreshDataFromFilter(this.roomStandardGrid,this.rmFilter,null);abSpConsole_toggleFromFilter("roomStandardRestrictToLocation",["roomStandardRestriction"],"roomStandardResMessageSpan",this.rmFilter.searchValuesString+this.rmFilter.otherSearchValuesString);},roomStandardGrid_afterRefresh:function(){jQuery("#grid_roomStandardGrid_body tr").each(function(){if(jQuery(this).find("td:eq(0)").text()==""){jQuery(this).find("td:eq(0)").text(getMessage("titleUnassigned"));jQuery(this).find("input[id*='_assignRoomStandard']").hide();}});},changeMode:function(mode){this.mode=mode;},openRoomStandardTab:function(action){if(action.checked){this.trigger("app:space:express:console:changeRoomStandardStatus","1");this.attributeTabs.showTab("roomStandardTab");this.attributeTabs.selectTab("roomStandardTab");}else{this.trigger("app:space:express:console:changeRoomStandardStatus","0");this.attributeTabs.hideTab("roomStandardTab");this.attributeTabs.selectTab("departmentsTab");}},roomStandardDetailPanel_beforeSave:function(){var form=this.roomStandardDetailPanel;if(form){var width=form.getFieldValue("rmstd.width");var length=form.getFieldValue("rmstd.length");var area=width*length;form.setFieldValue("rmstd.std_area",area);}},onCheckEvent:function(){abSpConsole_toggleFromCheckEvent("roomStandardRestrictToLocation",["roomStandardRestriction"],"roomStandardResMessageSpan",this.rmFilter.searchValuesString+this.rmFilter.otherSearchValuesString);abSpConsole_refreshDataFromCheckEvent("roomStandardRestrictToLocation",this.roomStandardGrid,this.rmFilter,null);},roomStandardGrid_onAssignRoomStandard:function(){var row=this.roomStandardGrid.rows[this.roomStandardGrid.selectedRowIndex];this.trigger("app:space:express:console:beginAssignment",{type:"standard",rm_std:row["rm.rm_std"]});},roomstdPendingAssignmentPanel_onCommitRoomStdPendingAssignments:function(){this.trigger("app:space:express:console:commitAssignment");},roomstdPendingAssignmentPanel_onRemoveRoomStdPendingAssignment:function(row){this.trigger("app:space:express:console:removeAssignment",{bl_id:row.getFieldValue("rm.bl_id"),fl_id:row.getFieldValue("rm.fl_id"),rm_id:row.getFieldValue("rm.rm_id"),rm_std:row.getFieldValue("rm.assigned_rm_std")});this.roomstdPendingAssignmentPanel.refresh();},roomstdPendingAssignmentPanel_onCancelRoomStdPendingAssignments:function(){this.trigger("app:space:express:console:cancelAssignment");},roomStandardGrid_beforeExportReport:function(panel,fieldDefs){fieldDefs[0].defaultValue=getMessage("titleUnassigned");return fieldDefs;}});function editRoomStandard(){var gridPanel=View.panels.get("roomStandardGrid");var panel=View.panels.get("roomStandardDetailPanel");var rowIndex=gridPanel.rows[gridPanel.selectedRowIndex];var rm_std="";if(rowIndex){rm_std=rowIndex["rm.rm_std"];}var restriction=new Ab.view.Restriction();restriction.addClause("rmstd.rm_std",rm_std);panel.showInWindow({newRecord:false,width:880,height:300,restriction:restriction,title:getMessage("editRoomStandard"),closeButton:false});}function exportRoomStandardToXLS(){doRoomStandardCustomExport(Ab.grid.ReportGrid.WORKFLOW_RULE_XLS_REPORT,"xls");}function exportRoomStandardToDOCX(){doRoomStandardCustomExport(Ab.grid.ReportGrid.WORKFLOW_RULE_DOCX_REPORT,"docx");}function doRoomStandardCustomExport(workflowRuleName,outputType){var roomStandardGrid=View.panels.get("roomStandardGrid");var hasRes=Ext.getDom("roomStandardRestrictToLocation").checked?true:false;var parameters=hasRes?roomStandardController.rmFilter.parameters:{};var restriction=roomStandardController.rmFilter.restriction;var printableRestrictions=getPrintableRestrictions(restriction,hasRes);parameters.printRestriction=hasRes;parameters.printableRestriction=printableRestrictions;parameters.showTotals=roomStandardGrid.getParametersForRefresh().showTotals;parameters.showCounts=roomStandardGrid.getParametersForRefresh().showCounts;var jobId="";var roomStdReport=getMessage("roomStdReport");if(outputType=="xls"){jobId=roomStandardGrid.callXLSReportJob(roomStdReport,"",parameters);}else{jobId=roomStandardGrid.callDOCXReportJob(roomStdReport,"",parameters);}if(jobId!=null){var command=new Ab.command.exportPanel({});command.displayReport(jobId,outputType);}}var spaceExpressConsoleRooms=View.createController("spaceExpressConsoleRooms",{rmFilter:null,events:{"click #roomsRestrictToLocation":function(){this.onCheckEvent();}},afterCreate:function(){this.on("app:space:express:console:filter",this.refresh);},afterViewLoad:function(){var template=_.template('<td class="checkbox-container" id="roomsRestriction"><input type="checkbox" id="roomsRestrictToLocation" checked="false"/><span id="roomsResMessageSpan">{{restrictToLocation}}</span></td>');Ext.DomHelper.insertHtml("afterBegin",this.roomsGrid.toolbar.tr,template(View.messages));Ext.fly("roomsRestriction").setDisplayed(false);this.roomsGrid.setColorOpacity(this.drawingPanel.getFillOpacity());},afterInitialDataFetch:function(){jQuery("#roomsGrid_title").hide();},refresh:function(filter){if(filter){this.rmFilter=jQuery.extend(true,{},filter);if(filter.parameters.totalArea.indexOf("total_area")!=-1||filter.parameters.totalArea.indexOf("total_count")!=-1){this.rmFilter.parameters.totalArea=getTotalAreaAndCountQueryParameter();}}abSpConsole_refreshDataFromFilter(this.roomsGrid,this.rmFilter,null);abSpConsole_toggleFromFilter("roomsRestrictToLocation",["roomsRestriction"],"roomsResMessageSpan",this.rmFilter.searchValuesString+this.rmFilter.otherSearchValuesString);},onCheckEvent:function(){abSpConsole_toggleFromCheckEvent("roomsRestrictToLocation",["roomsRestriction"],"roomsResMessageSpan",this.rmFilter.searchValuesString+this.rmFilter.otherSearchValuesString);abSpConsole_refreshDataFromCheckEvent("roomsRestrictToLocation",this.roomsGrid,this.rmFilter,null);},editSingleRoomDetailPanel_onSave:function(){if(this.editSingleRoomDetailPanel.save()){this.roomsGrid.refresh();}},roomsGrid_afterRefresh:function(){jQuery("#roomsGrid_indexRow").remove();}});function addNewRoom(){var panel=View.panels.get("editSingleRoomDetailPanel");panel.showInWindow({newRecord:true,width:880,height:300,restriction:new Ab.view.Restriction(),title:getMessage("addRoom")});}function locateRoom(){var thisController=View.controllers.get("spaceExpressConsoleRooms");var roomsGrid=View.panels.get("roomsGrid");var rowIndex=roomsGrid.rows[roomsGrid.selectedRowIndex];var bl_id=rowIndex["rm.bl_id"];var fl_id=rowIndex["rm.fl_id"];var rm_id=rowIndex["rm.rm_id"];var dwgname=rowIndex["rm.dwgname"];var rooms=[];rooms.push({bl_id:bl_id,fl_id:fl_id,rm_id:rm_id,dwgname:dwgname});thisController.trigger("app:space:express:console:locateEmployeesOrRooms",rooms,false);}function exportRoomToXLS(){doRoomCustomExport(Ab.grid.ReportGrid.WORKFLOW_RULE_XLS_REPORT,"xls");}function exportRoomToDOCX(){doRoomCustomExport(Ab.grid.ReportGrid.WORKFLOW_RULE_DOCX_REPORT,"docx");}function doRoomCustomExport(workflowRuleName,outputType){var roomsGrid=View.panels.get("roomsGrid");var hasRes=Ext.getDom("roomsRestrictToLocation").checked?true:false;var parameters=hasRes?spaceExpressConsoleRooms.rmFilter.parameters:{};var restriction=spaceExpressConsoleRooms.rmFilter.restriction;var printableRestrictions=getPrintableRestrictions(restriction,hasRes);parameters.printRestriction=hasRes;parameters.printableRestriction=printableRestrictions;parameters.categoryFields=getCategoryFieldsArray(roomsGrid,"roomsDS");parameters.showTotals=roomsGrid.getParametersForRefresh().showTotals;parameters.showCounts=roomsGrid.getParametersForRefresh().showCounts;var jobId="";var reprotName=getMessage("roomReport");if(outputType=="xls"){jobId=roomsGrid.callXLSReportJob(reprotName,"",parameters);}else{jobId=roomsGrid.callDOCXReportJob(reprotName,"",parameters);}if(jobId!=null){var command=new Ab.command.exportPanel({});command.displayReport(jobId,outputType);}}var selectedRmsEmsController=View.createController("selectedRmsEmsController",{afterInitialDataFetch:function(){jQuery("#selectedRmsEmsGrid_title").hide();},afterViewLoad:function(){var controller=this;this.selectedRmsEmsGrid.addEventListener("onMultipleSelectionChange",function(row){controller.fireSelectedEmployeeRow(row);});},fireSelectedEmployeeRow:function(row){var rows=this.selectedRmsEmsGrid.getSelectedRows();if(rows.length==0){this.singleEmployeeForm.show(false);this.readOnlyRmEmTabs.updateHeight();}else{if(rows.length==1){this.editSingleEmployee(rows[0]);this.readOnlyRmEmTabs.updateHeight();}else{this.editMultipleEmployees(rows);if(rows.length==2){this.readOnlyRmEmTabs.updateHeight();}}}},editSingleEmployee:function(row){this.multipleEmployeeForm.show(false);var restriction=new Ab.view.Restriction();restriction.addClause("em.em_id",row["em.em_id"]);this.singleEmployeeForm.refresh(restriction);this.singleEmployeeForm.show(true);},editMultipleEmployees:function(rows){this.singleEmployeeForm.show(false);this.multipleEmployeeForm.show(true);var escapedFields=[];for(var i=0;i<rows.length;i++){var baseRow=rows[i];for(var j=i+1;j<rows.length;j++){var comparedRow=rows[j];escapedFields=escapedFields.concat(this.compareEmployeeRows(baseRow,comparedRow,escapedFields));}}var dataRow=rows[0];this.multipleEmployeeForm.setFieldValue("em.bl_id",dataRow["rm.bl_id"]);this.multipleEmployeeForm.setFieldValue("em.fl_id",dataRow["rm.fl_id"]);this.multipleEmployeeForm.setFieldValue("em.rm_id",dataRow["rm.rm_id"]);this.multipleEmployeeForm.setFieldValue("em.dv_id",dataRow["dv.dv_id"]);this.multipleEmployeeForm.setFieldValue("em.dp_id",dataRow["dp.dp_id"]);for(var k=0;k<escapedFields.length;k++){var fieldName=escapedFields[k];if(fieldName=="rm.bl_id"){this.multipleEmployeeForm.setFieldValue("em.bl_id","<varies>");}else{if(fieldName=="rm.fl_id"){this.multipleEmployeeForm.setFieldValue("em.fl_id","<varies>");}else{if(fieldName=="rm.rm_id"){this.multipleEmployeeForm.setFieldValue("em.rm_id","<varies>");}else{if(fieldName=="dv.dv_id"){this.multipleEmployeeForm.setFieldValue("em.dv_id","<varies>");}else{if(fieldName=="dp.dp_id"){this.multipleEmployeeForm.setFieldValue("em.dp_id","<varies>");}}}}}}},compareEmployeeRows:function(baseRow,comparedRow,escapedFields){var comparedFields=["rm.bl_id","rm.fl_id","rm.rm_id","dv.dv_id","dp.dp_id"];var difFields=[];for(var i=0;i<comparedFields.length;i++){var escape=false;for(var j=0;j<escapedFields.length;j++){if(comparedFields[i]==escapedFields[j]){escape=true;}}if(!escape){var fieldName=comparedFields[i];if(baseRow[fieldName]!=comparedRow[fieldName]){difFields.push(fieldName);}}}return difFields;},multipleEmployeeForm_onSave:function(){var newValues=this.getNewFormValueForEdit();var rows=this.selectedRmsEmsGrid.getSelectedRows();var employees=[];for(var i=0;i<rows.length;i++){var currentRow=rows[i];var emId=currentRow["em.em_id"];var employee={"em.em_id":emId};employees.push(employee);}try{Workflow.callMethod("AbSpaceRoomInventoryBAR-SpaceExpressService-updateMultipleEmployees",employees,newValues);this.multipleEmployeeForm.show(false);this.selectedRmsEmsGrid.refresh();this.refreshEmployeeTabData();this.trigger("app:space:express:console:cancelSelectedRooms");this.trigger("app:space:express:console:commitRoomsAlteration");}catch(e){this.multipleEmployeeForm.displayTemporaryMessage(e.message,4000);}},getNewFormValueForEdit:function(){var blId=this.multipleEmployeeForm.getFieldValue("em.bl_id");var flId=this.multipleEmployeeForm.getFieldValue("em.fl_id");var rmId=this.multipleEmployeeForm.getFieldValue("em.rm_id");var dvId=this.multipleEmployeeForm.getFieldValue("em.dv_id");var dpId=this.multipleEmployeeForm.getFieldValue("em.dp_id");var newValues=[{fieldName:"rm.bl_id",fieldValue:blId},{fieldName:"rm.fl_id",fieldValue:flId},{fieldName:"rm.rm_id",fieldValue:rmId},{fieldName:"rm.dv_id",fieldValue:dvId},{fieldName:"rm.dp_id",fieldValue:dpId}];return newValues;},saveSingleEmployee:function(){this.singleEmployeeForm.show(false);this.selectedRmsEmsGrid.refresh();this.refreshEmployeeTabData();this.trigger("app:space:express:console:cancelSelectedRooms");this.trigger("app:space:express:console:commitRoomsAlteration");},refreshEmployeeTabData:function(){var panel=View.panels.get("employeeGrid");panel.refresh();},deleteSingleEmployee:function(){var panel=View.panels.get("employeeGrid");panel.refresh();this.singleEmployeeForm.show(false);this.trigger("app:space:express:console:cancelSelectedRooms");this.trigger("app:space:express:console:commitRoomsAlteration");},cancelEditEmployee:function(){this.multipleEmployeeForm.show(false);this.singleEmployeeForm.show(false);this.selectedRmsEmsGrid.refresh();},selectedRmsEmsGrid_afterRefresh:function(){if(!View.user.isMemberOfGroup("SPACE-CONSOLE-ALL-ACCESS")){jQuery("#selectedRmsEmsGrid input[type=checkbox]").attr("disabled","true");}}});var spaceSelectedRmsController=View.createController("spaceSelectedRmsController",{afterViewLoad:function(){var controller=this;this.selectedRoomsGrid.addEventListener("onMultipleSelectionChange",function(row){controller.fireSelectedRoomRow(row);});},afterInitialDataFetch:function(){jQuery("#selectedRoomsGrid_title").hide();this.multipleRoomForm.enableFieldActions("employee_capacity",false);this.multipleRoomForm.enableFieldActions("total_room_area",false);},fireSelectedRoomRow:function(row){var rows=this.selectedRoomsGrid.getSelectedRows();if(rows.length==0){this.singleRoomForm.show(false);this.readOnlyRmEmTabs.updateHeight();}else{if(rows.length==1){this.editSingleRoom(rows[0]);this.readOnlyRmEmTabs.updateHeight();}else{this.editMultipleRooms(rows);if(rows.length==2){this.readOnlyRmEmTabs.updateHeight();}}}},editSingleRoom:function(row){this.multipleRoomForm.show(false);var restriction=new Ab.view.Restriction();restriction.addClause("rm.bl_id",row["rm.bl_id"]);restriction.addClause("rm.fl_id",row["rm.fl_id"]);restriction.addClause("rm.rm_id",row["rm.rm_id"]);this.singleRoomForm.refresh(restriction);this.singleRoomForm.show(true);},editMultipleRooms:function(rows){this.singleRoomForm.show(false);this.multipleRoomForm.show(true);var totalRoomArea=0;var escapedFields=[];for(var i=0;i<rows.length;i++){var baseRow=rows[i];for(var j=i+1;j<rows.length;j++){var comparedRow=rows[j];escapedFields=escapedFields.concat(this.compareRoomRows(baseRow,comparedRow,escapedFields));}totalRoomArea=totalRoomArea+parseFloat(baseRow["rm.area"]);}var dataRow=rows[0];this.multipleRoomForm.setFieldValue("rm.dv_id",dataRow["rm.dv_id"]);this.multipleRoomForm.setFieldValue("rm.dp_id",dataRow["rm.dp_id"]);this.multipleRoomForm.setFieldValue("rm.rm_cat",dataRow["rm.rm_cat"]);this.multipleRoomForm.setFieldValue("rm.rm_type",dataRow["rm.rm_type"]);this.multipleRoomForm.setFieldValue("employee_capacity",dataRow["rm.cap_em"]);this.multipleRoomForm.setFieldValue("total_room_area",totalRoomArea.toFixed(2));for(var k=0;k<escapedFields.length;k++){var fieldName=escapedFields[k];if(fieldName=="rm.dv_id"){this.multipleRoomForm.setFieldValue("rm.dv_id","<varies>");}else{if(fieldName=="rm.dp_id"){this.multipleRoomForm.setFieldValue("rm.dp_id","<varies>");}else{if(fieldName=="rm.rm_cat"){this.multipleRoomForm.setFieldValue("rm.rm_cat","<varies>");}else{if(fieldName=="rm.rm_type"){this.multipleRoomForm.setFieldValue("rm.rm_type","<varies>");}else{if(fieldName=="rm.cap_em"){this.multipleRoomForm.setFieldValue("employee_capacity","<varies>");}}}}}}},compareRoomRows:function(baseRow,comparedRow,escapedFields){var fieldNames=["rm.dv_id","rm.dp_id","rm.rm_cat","rm.rm_type","rm.cap_em"];var difFields=[];for(var i=0;i<fieldNames.length;i++){var escape=false;for(var j=0;j<escapedFields.length;j++){if(fieldNames[i]==escapedFields[j]){escape=true;}}if(!escape){var fieldName=fieldNames[i];if(baseRow[fieldName]!=comparedRow[fieldName]){difFields.push(fieldName);}}}return difFields;},multipleRoomForm_onSaveMultiRoom:function(){var newValueArray=this.getNewFormValueForRoomsBulkEdit();var rooms=[];var rows=this.selectedRoomsGrid.getSelectedRows();for(var i=0;i<rows.length;i++){var row=rows[i];var blId=row["rm.bl_id"];var flId=row["rm.fl_id"];var roomId=row["rm.rm_id"];var roomJsonArray={"rm.bl_id":blId,"rm.fl_id":flId,"rm.rm_id":roomId};rooms.push(roomJsonArray);}try{Workflow.callMethod("AbSpaceRoomInventoryBAR-SpaceExpressService-updateMultipleRooms",rooms,newValueArray);this.refreshRoomsGrid();}catch(e){this.multipleRoomForm.displayTemporaryMessage(e.message,4000);}},getNewFormValueForRoomsBulkEdit:function(){var rows=this.selectedRoomsGrid.getSelectedRows();var inputDivisionId=this.multipleRoomForm.getFieldValue("rm.dv_id");var inputDepartmentId=this.multipleRoomForm.getFieldValue("rm.dp_id");var inputRoomCategory=this.multipleRoomForm.getFieldValue("rm.rm_cat");var inputRoomType=this.multipleRoomForm.getFieldValue("rm.rm_type");var employeeCapacity=this.multipleRoomForm.getFieldValue("employee_capacity");var newValueArray=[{fieldName:"rm.dv_id",fieldValue:inputDivisionId},{fieldName:"rm.dp_id",fieldValue:inputDepartmentId},{fieldName:"rm.rm_cat",fieldValue:inputRoomCategory},{fieldName:"rm.rm_type",fieldValue:inputRoomType},{fieldName:"rm.cap_em",fieldValue:employeeCapacity}];return newValueArray;},refreshRoomsGrid:function(){var panel=View.panels.get("roomsGrid");panel.refresh();this.cancelEditRoom();this.trigger("app:space:express:console:cancelSelectedRooms");this.trigger("app:space:express:console:commitRoomsAlteration");},cancelEditRoom:function(){this.singleRoomForm.show(false);this.multipleRoomForm.show(false);this.selectedRoomsGrid.refresh();},selectedRoomsGrid_afterRefresh:function(){if(!View.user.isMemberOfGroup("SPACE-CONSOLE-ALL-ACCESS")){jQuery("#selectedRoomsGrid input[type=checkbox]").attr("disabled","true");}}});var spaceExpressConsole=View.createController("spaceExpressConsole",{mode:"",showRoomStandard:0,events:{"click #spaceMode":function(){this.selectMode("spaceMode");},"click #employeeMode":function(){this.selectMode("employeeMode");}},afterCreate:function(){this.on("app:space:express:console:changeRoomStandardStatus",this.changeRoomStandardStatus);},afterInitialDataFetch:function(){this.switchMode("spaceMode");},changeRoomStandardStatus:function(value){this.showRoomStandard=value;},updateModeButtons:function(){Ext.get("spaceMode").removeClass("selected");Ext.get("employeeMode").removeClass("selected");Ext.get(this.mode).addClass("selected");},selectMode:function(mode){if(this.mode!=mode){var currentPendingAssignments=this.drawingPanel.getSidecar().get("pendingAssignments");if(currentPendingAssignments&&currentPendingAssignments.length>0){var message=getMessage("switchMode");var innerThis=this;View.confirm(message,function(button){if(button=="yes"){innerThis.switchMode(mode);}});}else{this.switchMode(mode);}}},switchMode:function(mode){this.mode=mode;this.updateModeButtons();this.attributeTabs.hideTab("roomStandardTab");if(mode==="employeeMode"){this.attributeTabs.hideTab("departmentsTab");this.attributeTabs.hideTab("categoriesTab");this.attributeTabs.hideTab("roomsTab");this.attributeTabs.showTab("employeesTab");this.attributeTabs.selectTab("employeesTab");}else{this.attributeTabs.showTab("departmentsTab");this.attributeTabs.showTab("categoriesTab");this.attributeTabs.showTab("roomsTab");if(this.showRoomStandard=="1"){this.attributeTabs.showTab("roomStandardTab");}this.attributeTabs.hideTab("employeesTab");this.attributeTabs.selectTab("departmentsTab");}this.modeSelector.getSidecar().set("mode",this.mode);this.modeSelector.getSidecar().save();this.trigger("app:space:express:console:cancelAssignment");this.trigger("app:space:express:console:changeMode",this.mode);}});