<view version="2.0">
    <!-- esri js library (required) -->
    <js url="//js.arcgis.com/3.9/"/>
    <css url="//js.arcgis.com/3.9/js/esri/css/esri.css" />
    <!-- ab core map control (required) -->
    <js file="ab-arcgis-map.js"/>
    <css file="ab-arcgis-map.css"/>
    <!-- ab geocode control (optional) -->
    <js file="ab-arcgis-geocoder.js"/>

	<js file="ab-cb-rpt-hl-haz.js"/>
    <js file="ab-cb-rpt-common.js"/>
	
	
    <title translatable="true">Hazard Areas and Assessment Items</title>

    <message name="noDrawing" translatable="true">No Floor Drawing</message>
    <message name="selectAFloor" translatable="true">Please select a floor</message>
    <message name="labelShowDetails" translatable="true">Show Details</message>

    <layout type="borderLayout" id="mainLayout">
        <north autoScroll="true" split="true" initialSize="182px"/>
        <west autoScroll="true" split="true" initialSize="20%"/>
        <center autoScroll="true"/>
    </layout>
    <layout type="borderLayout" id="westLayout" containingLayout="mainLayout" region="west">
        <north split="true" initialSize="50%"/>
        <center autoScroll="true"/>
    </layout>
    <layout type="borderLayout" id="centerLayout" containingLayout="mainLayout" region="center">
        <north split="true" initialSize="40%"/>
        <center autoScroll="true"/>
    </layout>
	
    <!--Filter Console Panel-->
    <panel type="view" id="abCbRptHlHaz_filterPanel" file="ab-cb-rpt-common-filter.axvw" layout="mainLayout" region="north"/>   

    <!-- Tree definition -->
    <dataSource id="abCbRptHlHaz_dsCtryTree" applyVpaRestrictions="false">
        <sql dialect="generic">
            SELECT
                bl.ctry_id ${sql.as} ctry_id,
                '(' ${sql.concat} COUNT(activity_log.activity_log_id) ${sql.concat} ')' ${sql.as} name
            FROM activity_log, project, bl
            WHERE activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                AND activity_log.project_id IS NOT NULL AND project.project_id = activity_log.project_id AND project.project_type='ASSESSMENT - HAZMAT'
                AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                AND bl.bl_id = activity_log.bl_id
                AND ${parameters['consoleRestriction']}
                AND ${parameters['userAssignedRestriction']}
            GROUP BY bl.ctry_id
        </sql>
        
        <sql dialect="sqlserver">
            SELECT
                bl.ctry_id ${sql.as} ctry_id,
                '(' ${sql.concat} CONVERT(VARCHAR, COUNT(activity_log.activity_log_id)) ${sql.concat} ')' ${sql.as} name
            FROM activity_log, project, bl
            WHERE activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                AND activity_log.project_id IS NOT NULL AND project.project_id = activity_log.project_id AND project.project_type='ASSESSMENT - HAZMAT'
                AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                AND bl.bl_id = activity_log.bl_id
                AND ${parameters['consoleRestriction']}
                AND ${parameters['userAssignedRestriction']}
            GROUP BY bl.ctry_id
        </sql>
        <table name="ctry" role="main"/>
        <field table="ctry" name="ctry_id"/>
        <field table="ctry" name="name"/>
        <sortField table="ctry" name="ctry_id" ascending="true"/>
        <parameter name="consoleRestriction" dataType="verbatim" value="1=1"/>
        <parameter name="userAssignedRestriction" dataType="verbatim" value="1=1"/>
    </dataSource>

    <dataSource id="abCbRptHlHaz_dsRegnTree" applyVpaRestrictions="false">
        <sql dialect="generic">
            SELECT
                bl.ctry_id ${sql.as} ctry_id,
                bl.regn_id ${sql.as} regn_id,
                '(' ${sql.concat} COUNT(activity_log.activity_log_id) ${sql.concat} ')' ${sql.as} name
            FROM activity_log, project, bl
            WHERE activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                AND activity_log.project_id IS NOT NULL AND project.project_id = activity_log.project_id AND project.project_type='ASSESSMENT - HAZMAT'
                AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                AND bl.bl_id = activity_log.bl_id
                AND ${parameters['consoleRestriction']}
                AND ${parameters['userAssignedRestriction']}
            GROUP BY bl.ctry_id, bl.regn_id
        </sql>
        
        <sql dialect="sqlserver">
            SELECT
                bl.ctry_id ${sql.as} ctry_id,
                bl.regn_id ${sql.as} regn_id,
                '(' ${sql.concat} CONVERT(VARCHAR, COUNT(activity_log.activity_log_id)) ${sql.concat} ')' ${sql.as} name
            FROM activity_log, project, bl
            WHERE activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                AND activity_log.project_id IS NOT NULL AND project.project_id = activity_log.project_id AND project.project_type='ASSESSMENT - HAZMAT'
                AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                AND bl.bl_id = activity_log.bl_id
                AND ${parameters['consoleRestriction']}
                AND ${parameters['userAssignedRestriction']}
            GROUP BY bl.ctry_id, bl.regn_id
        </sql>
        <table name="regn" role="main"/>
        <field table="regn" name="regn_id"/>
        <field table="regn" name="name"/>
        <sortField table="regn" name="regn_id" ascending="true"/>
        <parameter name="consoleRestriction" dataType="verbatim" value="1=1"/>
        <parameter name="userAssignedRestriction" dataType="verbatim" value="1=1"/>
    </dataSource>

    <dataSource id="abCbRptHlHaz_dsStateTree" applyVpaRestrictions="false">
        <sql dialect="generic">
            SELECT
                bl.ctry_id ${sql.as} ctry_id,
                bl.regn_id ${sql.as} regn_id,
                bl.state_id ${sql.as} state_id,
                '(' ${sql.concat} COUNT(activity_log.activity_log_id) ${sql.concat} ')' ${sql.as} name
            FROM activity_log, project, bl
            WHERE activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                AND activity_log.project_id IS NOT NULL AND project.project_id = activity_log.project_id AND project.project_type='ASSESSMENT - HAZMAT'
                AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                AND bl.bl_id = activity_log.bl_id
                AND ${parameters['consoleRestriction']}
                AND ${parameters['userAssignedRestriction']}
            GROUP BY bl.ctry_id, bl.regn_id, bl.state_id
        </sql>
        
        <sql dialect="sqlserver">
            SELECT
                bl.ctry_id ${sql.as} ctry_id,
                bl.regn_id ${sql.as} regn_id,
                bl.state_id ${sql.as} state_id,
                '(' ${sql.concat} CONVERT(VARCHAR, COUNT(activity_log.activity_log_id)) ${sql.concat} ')' ${sql.as} name
            FROM activity_log, project, bl
            WHERE activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                AND activity_log.project_id IS NOT NULL AND project.project_id = activity_log.project_id AND project.project_type='ASSESSMENT - HAZMAT'
                AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                AND bl.bl_id = activity_log.bl_id
                AND ${parameters['consoleRestriction']}
                AND ${parameters['userAssignedRestriction']}
            GROUP BY bl.ctry_id, bl.regn_id, bl.state_id
        </sql>
        <table name="state" role="main"/>
        <field table="state" name="state_id"/>
        <field table="state" name="name"/>
        <sortField table="state" name="state_id" ascending="true"/>
        <parameter name="consoleRestriction" dataType="verbatim" value="1=1"/>
        <parameter name="userAssignedRestriction" dataType="verbatim" value="1=1"/>
    </dataSource>
    
    <dataSource id="abCbRptHlHaz_dsCityTree" applyVpaRestrictions="false">
        <sql dialect="generic">
            SELECT
                bl.ctry_id ${sql.as} ctry_id,
                bl.regn_id ${sql.as} regn_id,
                bl.state_id ${sql.as} state_id,
                bl.city_id ${sql.as} city_id,
                '(' ${sql.concat} COUNT(activity_log.activity_log_id) ${sql.concat} ')' ${sql.as} name
            FROM activity_log, project, bl
            WHERE activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                AND activity_log.project_id IS NOT NULL AND project.project_id = activity_log.project_id AND project.project_type='ASSESSMENT - HAZMAT'
                AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                AND bl.bl_id = activity_log.bl_id
                AND ${parameters['consoleRestriction']}
                AND ${parameters['userAssignedRestriction']}
            GROUP BY bl.ctry_id, bl.regn_id, bl.state_id, bl.city_id
        </sql>
        
        <sql dialect="sqlserver">
            SELECT
                bl.ctry_id ${sql.as} ctry_id,
                bl.regn_id ${sql.as} regn_id,
                bl.state_id ${sql.as} state_id,
                bl.city_id ${sql.as} city_id,
                '(' ${sql.concat} CONVERT(VARCHAR, COUNT(activity_log.activity_log_id)) ${sql.concat} ')' ${sql.as} name
            FROM activity_log, project, bl
            WHERE activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                AND activity_log.project_id IS NOT NULL AND project.project_id = activity_log.project_id AND project.project_type='ASSESSMENT - HAZMAT'
                AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                AND bl.bl_id = activity_log.bl_id
                AND ${parameters['consoleRestriction']}
                AND ${parameters['userAssignedRestriction']}
            GROUP BY bl.ctry_id, bl.regn_id, bl.state_id, bl.city_id
        </sql>
        <table name="city" role="main"/>
        <field table="city" name="city_id"/>
        <field table="city" name="name"/>
        <sortField table="city" name="city_id" ascending="true"/>
        <parameter name="consoleRestriction" dataType="verbatim" value="1=1"/>
        <parameter name="userAssignedRestriction" dataType="verbatim" value="1=1"/>
    </dataSource>
    
    <dataSource id="abCbRptHlHaz_dsSiteTree" applyVpaRestrictions="false">
        <sql dialect="generic">
            SELECT
                bl.ctry_id ${sql.as} ctry_id,
                bl.regn_id ${sql.as} regn_id,
                bl.state_id ${sql.as} state_id,
                bl.city_id ${sql.as} city_id,
                bl.site_id ${sql.as} site_id,
                '(' ${sql.concat} COUNT(activity_log.activity_log_id) ${sql.concat} ')' ${sql.as} name
            FROM activity_log, project, bl
            WHERE activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                AND activity_log.project_id IS NOT NULL AND project.project_id = activity_log.project_id AND project.project_type='ASSESSMENT - HAZMAT'
                AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                AND bl.bl_id = activity_log.bl_id
                AND ${parameters['consoleRestriction']}
                AND ${parameters['userAssignedRestriction']}
            GROUP BY bl.ctry_id, bl.regn_id, bl.state_id, bl.city_id, bl.site_id
        </sql>
        
        <sql dialect="sqlserver">
            SELECT
                bl.ctry_id ${sql.as} ctry_id,
                bl.regn_id ${sql.as} regn_id,
                bl.state_id ${sql.as} state_id,
                bl.city_id ${sql.as} city_id,
                bl.site_id ${sql.as} site_id,
                '(' ${sql.concat} CONVERT(VARCHAR, COUNT(activity_log.activity_log_id)) ${sql.concat} ')' ${sql.as} name
            FROM activity_log, project, bl
            WHERE activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                AND activity_log.project_id IS NOT NULL AND project.project_id = activity_log.project_id AND project.project_type='ASSESSMENT - HAZMAT'
                AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                AND bl.bl_id = activity_log.bl_id
                AND ${parameters['consoleRestriction']}
                AND ${parameters['userAssignedRestriction']}
            GROUP BY bl.ctry_id, bl.regn_id, bl.state_id, bl.city_id, bl.site_id
        </sql>
        
        <table name="site" role="main"/>
        <field table="site" name="site_id"/>
        <field table="site" name="name"/>
        <sortField table="site" name="site_id" ascending="true"/>
        <parameter name="consoleRestriction" dataType="verbatim" value="1=1"/>
        <parameter name="userAssignedRestriction" dataType="verbatim" value="1=1"/>
    </dataSource>
    
    
    <dataSource id="abCbRptHlHaz_dsBuildingTree" applyVpaRestrictions="false">
        <sql dialect="generic">
            SELECT
                bl.ctry_id ${sql.as} ctry_id,
                bl.regn_id ${sql.as} regn_id,
                bl.state_id ${sql.as} state_id,
                bl.city_id ${sql.as} city_id,
                bl.site_id ${sql.as} site_id,
                bl.bl_id ${sql.as} bl_id,
                '(' ${sql.concat} COUNT(activity_log.activity_log_id) ${sql.concat} ')' ${sql.as} name
            FROM activity_log, project, bl
            WHERE activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                AND activity_log.project_id IS NOT NULL AND project.project_id = activity_log.project_id AND project.project_type='ASSESSMENT - HAZMAT'
                AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                AND bl.bl_id = activity_log.bl_id
                AND ${parameters['consoleRestriction']}
                AND ${parameters['userAssignedRestriction']}
            GROUP BY bl.ctry_id, bl.regn_id, bl.state_id, bl.city_id, bl.site_id, bl.bl_id
        </sql>
        
        <sql dialect="sqlserver">
            SELECT
                bl.ctry_id ${sql.as} ctry_id,
                bl.regn_id ${sql.as} regn_id,
                bl.state_id ${sql.as} state_id,
                bl.city_id ${sql.as} city_id,
                bl.site_id ${sql.as} site_id,
                bl.bl_id ${sql.as} bl_id,
                '(' ${sql.concat} CONVERT(VARCHAR, COUNT(activity_log.activity_log_id)) ${sql.concat} ')' ${sql.as} name
            FROM activity_log, project, bl
            WHERE activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                AND activity_log.project_id IS NOT NULL AND project.project_id = activity_log.project_id AND project.project_type='ASSESSMENT - HAZMAT'
                AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                AND bl.bl_id = activity_log.bl_id
                AND ${parameters['consoleRestriction']}
                AND ${parameters['userAssignedRestriction']}
            GROUP BY bl.ctry_id, bl.regn_id, bl.state_id, bl.city_id, bl.site_id, bl.bl_id
        </sql>
        
        <table name="bl" role="main"/>
        <field table="bl" name="bl_id"/>
        <field table="bl" name="name"/>
        <sortField table="bl" name="bl_id" ascending="true"/>
        <parameter name="consoleRestriction" dataType="verbatim" value="1=1"/>
        <parameter name="userAssignedRestriction" dataType="verbatim" value="1=1"/>
    </dataSource>

    <dataSource id="abCbRptHlHaz_dsFloorTree" applyVpaRestrictions="false">
        <sql dialect="generic">
            SELECT DISTINCT
                fl.fl_id ${sql.as} fl_id,
                fl.bl_id ${sql.as} bl_id,
                (CASE WHEN (SELECT TOP 1 rm.dwgname FROM rm WHERE rm.bl_id = fl.bl_id AND rm.fl_id = fl.fl_id) IS NULL
                    THEN (CASE WHEN fl.detail_dwg IS NULL THEN ${parameters['noDrawing']} ELSE fl.detail_dwg END)
                    ELSE (SELECT TOP 1 rm.dwgname FROM rm WHERE rm.bl_id = fl.bl_id AND rm.fl_id = fl.fl_id)
                    END
                ) ${sql.as} dwgname,
                (CASE WHEN (SELECT TOP 1 rm.dwgname FROM rm WHERE rm.bl_id = fl.bl_id AND rm.fl_id = fl.fl_id) IS NULL
                    THEN fl.detail_dwg
                    ELSE (SELECT TOP 1 rm.dwgname FROM rm WHERE rm.bl_id = fl.bl_id AND rm.fl_id = fl.fl_id)
                    END
                ) ${sql.as} raw_dwgname,
                bl.site_id ${sql.as} site_id,
                bl.city_id ${sql.as} city_id,
                bl.state_id ${sql.as} state_id,
                bl.regn_id ${sql.as} regn_id,
                bl.ctry_id ${sql.as} ctry_id
            FROM activity_log, project, fl, bl
            WHERE activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                AND activity_log.project_id IS NOT NULL AND project.project_id = activity_log.project_id AND project.project_type='ASSESSMENT - HAZMAT'
                AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                AND fl.bl_id = activity_log.bl_id AND fl.fl_id = activity_log.fl_id
                AND bl.bl_id = activity_log.bl_id
                AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                AND ${parameters['consoleRestriction']}
                AND ${parameters['userAssignedRestriction']}
        </sql>
        <sql dialect="oracle">
            SELECT DISTINCT
                fl.fl_id ${sql.as} fl_id,
                fl.bl_id ${sql.as} bl_id,
                (CASE WHEN (SELECT rm.dwgname FROM rm WHERE rm.bl_id = fl.bl_id AND rm.fl_id = fl.fl_id AND rownum=1) IS NULL
                    THEN (CASE WHEN fl.detail_dwg IS NULL THEN ${parameters['noDrawing']} ELSE fl.detail_dwg END)
                    ELSE (SELECT rm.dwgname FROM rm WHERE rm.bl_id = fl.bl_id AND rm.fl_id = fl.fl_id AND rownum=1)
                    END
                ) ${sql.as} dwgname,
                (CASE WHEN (SELECT rm.dwgname FROM rm WHERE rm.bl_id = fl.bl_id AND rm.fl_id = fl.fl_id AND rownum=1) IS NULL
                    THEN fl.detail_dwg
                    ELSE (SELECT rm.dwgname FROM rm WHERE rm.bl_id = fl.bl_id AND rm.fl_id = fl.fl_id AND rownum=1)
                    END
                ) ${sql.as} raw_dwgname,
                bl.site_id ${sql.as} site_id,
                bl.city_id ${sql.as} city_id,
                bl.state_id ${sql.as} state_id,
                bl.regn_id ${sql.as} regn_id,
                bl.ctry_id ${sql.as} ctry_id
            FROM activity_log, project, fl, bl
            WHERE activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                AND activity_log.project_id IS NOT NULL AND project.project_id = activity_log.project_id AND project.project_type='ASSESSMENT - HAZMAT'
                AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                AND fl.bl_id = activity_log.bl_id AND fl.fl_id = activity_log.fl_id
                AND bl.bl_id = activity_log.bl_id
                AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                AND ${parameters['consoleRestriction']}
                AND ${parameters['userAssignedRestriction']}
        </sql>
        
        <table name="rm" role="main"/>
        <field table="rm" name="bl_id" dataType="text"/>
        <field table="rm" name="fl_id" dataType="text"/>
        <field table="rm" name="ctry_id" dataType="text"/>
        <field table="rm" name="regn_id" dataType="text"/>
        <field table="rm" name="state_id" dataType="text"/>
        <field table="rm" name="city_id" dataType="text"/>
        <field table="rm" name="site_id" dataType="text"/>
        <field table="rm" name="dwgname" dataType="text"/>
        <field table="rm" name="raw_dwgname" dataType="text" hidden="true"/>
        <sortField table="rm" name="fl_id" ascending="true"/>
        <parameter name="consoleRestriction" dataType="verbatim" value="1=1"/>
        <parameter name="userAssignedRestriction" dataType="verbatim" value="1=1"/>
        <parameter name="noDrawing" dataType="text" value=""/>
    </dataSource>

    <panel type="tree" id="abCbRptHlHaz_ctryTree" dataSource="abCbRptHlHaz_dsCtryTree" layout="westLayout" region="north">
        <title translatable="true">Select a building or floor</title>

        <panel type="tree" id="abCbRptHlHaz_regnTree" dataSource="abCbRptHlHaz_dsRegnTree"/>
        <panel type="tree" id="abCbRptHlHaz_stateTree" dataSource="abCbRptHlHaz_dsStateTree"/>
        <panel type="tree" id="abCbRptHlHaz_cityTree" dataSource="abCbRptHlHaz_dsCityTree"/>
        <panel type="tree" id="abCbRptHlHaz_siteTree" dataSource="abCbRptHlHaz_dsSiteTree"/>
        <panel type="tree" id="abCbRptHlHaz_buildingTree" dataSource="abCbRptHlHaz_dsBuildingTree">
            <event type="onClickNode">
                <command type="callFunction" functionName="abCbRptHlHaz_showBlDetails"/>
            </event>
        </panel>
        <panel type="tree" id="abCbRptHlHaz_floorTree" dataSource="abCbRptHlHaz_dsFloorTree">
            <event type="onClickNode">
                <command type="callFunction" functionName="abCbRptHlHaz_showGrid"/>
            </event>    
        </panel>
    </panel>

    <panel type="html" id="abCbRptHlHaz_assetTypePanel" layout="westLayout" region="center">
        <title translatable="true">Items to Highlight on Drawing</title>
        <html>
            <table style="font-size: 9pt; color:#100070">
                <tr><td>
                <input type="radio" id="radioAssetType_rooms" name="radioAssetType" value="rooms" onclick="disPlayDrawing()" checked="true">
                    <span translatable="true">Rooms</span>
                </input>
                </td></tr>
                
                <tr><td>
                <input type="radio" id="radioAssetType_hazards" name="radioAssetType" value="hazards" onclick="disPlayDrawing()">
                    <span translatable="true">Hazards</span>
                </input>
                </td></tr>
                
                <tr><td>
                <input type="radio" id="radioAssetType_samples" name="radioAssetType" value="samples" onclick="disPlayDrawing()">
                    <span translatable="true">Samples</span>
                </input>
                </td></tr>
            </table>
        </html>
    </panel>

    <!-- Building details panel -->
    <dataSource id="abCbRptHlHaz_dsBlDetails">
        <table name="bl" role="main"/>
        <field table="bl" name="bl_id"/>
        <field table="bl" name="regn_id"/>
        <field table="bl" name="count_occup"/>
        <field table="bl" name="name"/>
        <field table="bl" name="ctry_id"/>
        <field table="bl" name="count_fl"/>
        <field table="bl" name="address1"/>
        <field table="bl" name="pr_id"/>
        <field table="bl" name="construction_type"/>
        <field table="bl" name="address2"/>
        <field table="bl" name="ac_id"/>
        <field table="bl" name="area_gross_ext"/>
        <field table="bl" name="city_id"/>
        <field table="bl" name="contact_name"/>
        <field table="bl" name="area_gross_int"/>
        <field table="bl" name="state_id"/>
        <field table="bl" name="contact_phone"/>
        <field table="bl" name="area_ext_wall"/>
        <field table="bl" name="zip"/>
        <field table="bl" name="use1"/>
        <field table="bl" name="cost_sqft"/>
        <field table="bl" name="site_id"/>
        <field table="bl" name="date_bl"/>
        <field table="bl" name="comments"/>     
    </dataSource>
     
    
    <panel type="form" id="abCbRptHlHaz_blDetailsPanel" dataSource="abCbRptHlHaz_dsBlDetails" columns="3" layout="centerLayout" showOnLoad="false" region="north">
        <title translatable="true">Building Details</title>
        <field table="bl" name="bl_id" readOnly="true"/>
        <field table="bl" name="regn_id" readOnly="true"/>
        <field table="bl" name="count_occup" readOnly="true"/>
        <field table="bl" name="name" readOnly="true"/>
        <field table="bl" name="ctry_id" readOnly="true"/>
        <field table="bl" name="count_fl" readOnly="true"/>
        <field table="bl" name="address1" readOnly="true"/>
        <field table="bl" name="pr_id" readOnly="true"/>
        <field table="bl" name="construction_type" readOnly="true"/>
        <field table="bl" name="address2" readOnly="true"/>
        <field table="bl" name="ac_id" readOnly="true"/>
        <field table="bl" name="area_gross_ext" readOnly="true"/>
        <field table="bl" name="city_id" readOnly="true"/>
        <field table="bl" name="contact_name" readOnly="true"/>
        <field table="bl" name="area_gross_int" readOnly="true"/>
        <field table="bl" name="state_id" readOnly="true"/>
        <field table="bl" name="contact_phone" readOnly="true"/>
        <field table="bl" name="area_ext_wall" readOnly="true"/>
        <field table="bl" name="zip" readOnly="true"/>
        <field table="bl" name="use1" readOnly="true"/>
        <field table="bl" name="cost_sqft" readOnly="true"/>
        <field table="bl" name="site_id" readOnly="true"/>
        <field table="bl" name="date_bl" readOnly="true"/>
        <field/>
        <field table="bl" name="comments" colspan="3" readOnly="true"/>
    </panel>

    <!-- Drawing panel's data sources -->
    <dataSource id="abCbRptHlHaz_dsDrawingRmHighlight">
        <table name="rm" role="main"/>
        <field table="rm" name="bl_id"/>
        <field table="rm" name="fl_id"/>
        <field table="rm" name="rm_id"/>
    </dataSource>
    <dataSource id="abCbRptHlHaz_dsDrawingRmLabel">
        <table name="rm" role="main"/>
        <field name="bl_id" hidden="true"/>
        <field name="fl_id" hidden="true"/>
        <field name="rm_id"/>
        <field name="rm_cat"/>
        <field name="rm_type"/>
        <field name="area"/>
    </dataSource>
    
    <dataSource id="abCbRptHlHaz_dsDrawingHazardsHighlight">
        <table name="activity_log" role="main"/>
        <field table="activity_log" name="activity_log_id"/>
        <field table="activity_log" name="bl_id"/>
        <field table="activity_log" name="fl_id"/>
        <field table="activity_log" name="rm_id"/>
    </dataSource>
    <dataSource id="abCbRptHlHaz_dsDrawingHazardsLabel">
        <table name="activity_log" role="main"/>
        <field table="activity_log" name="activity_log_id"/>
        <field table="activity_log" name="prob_type"/>
        <field table="activity_log" name="rm_id"/>
        <field table="activity_log" name="hcm_id"/>
        <!-- field table="activity_log" name="hcm_cond_id"/-->
        <field table="activity_log" name="action_title"/>
        <field name="vf_qty" dataType="text">
            <sql dialect="generic">hcm_qty ${sql.concat} ' ' ${sql.concat} cb_units_id</sql>
            <sql dialect="sqlserver">CONVERT(VARCHAR,hcm_qty) ${sql.concat} ' ' ${sql.concat} cb_units_id</sql>
        </field>
        <field table="activity_log" name="repair_type"/>
        <!-- field table="activity_log" name="date_assessed"/-->
        <field table="activity_log" name="project_id"/>
    </dataSource>
    
    <dataSource id="abCbRptHlHaz_dsDrawingSamplesHighlight">
        <table name="cb_samples" role="main"/>
        <table name="activity_log" role="standard"/>
        <field table="cb_samples" name="activity_log_id"/>
        <field table="activity_log" name="bl_id"/>
        <field table="activity_log" name="fl_id"/>
        <field table="activity_log" name="rm_id"/>
    </dataSource>
    <dataSource id="abCbRptHlHaz_dsDrawingSamplesLabel">
        <table name="cb_samples" role="main"/>
        <table name="activity_log" role="standard"/>
        <field table="cb_samples" name="sample_code"/>
        <field table="cb_samples" name="sample_loc"/>
        <field table="cb_samples" name="sample_desc"/>
        <field table="cb_samples" name="sample_type"/>
        <field table="cb_samples" name="date_collected"/>
        <field table="activity_log" name="bl_id" hidden="true"/>
        <field table="cb_samples" name="sample_id" hidden="true"/>
    </dataSource>
    
    <!-- Drawing panel
        (place it BEFORE the map panel in order to avoid flash error on initializing several flash controls in FireFox:
         FABridge.js: FABridge__bridgeInitialized(bridgeName))
     -->
    <panel type="drawing" id="abCbRptHlHaz_drawingPanel" showOnLoad="false" layout="centerLayout" region="north" multiple="false"
        selectionMode="0" 
        toolbarSettings="hide=all"
        highlightDataSource="abCbRptHlHaz_dsDrawingRmHighlight"
        labelsDataSource="abCbRptHlHaz_dsDrawingRmLabel">
    </panel>
    
    <!-- used for geocoding -->
    <dataSource id="abCbRptHlHaz_dsGeoBuilding">
        <table name="bl" role="main"/>
        <field table="bl" name="bl_id"/>
        <field table="bl" name="address1"/>
        <field table="bl" name="city_id"/>
        <field table="bl" name="state_id"/>
        <field table="bl" name="ctry_id"/>
        <field table="bl" name="zip"/>
        <field table="bl" name="lat"/>
        <field table="bl" name="lon"/>
    </dataSource>
    
    <!-- used for marker definition -->
    <dataSource id="abCbRptHlHaz_dsBuilding">
        <table name="bl"/>
        <field table="bl" name="bl_id"/>
        <field name="address" dataType="text">
            <title translatable="true">Address</title>
            <sql dialect="generic">address1${sql.concat}','${sql.concat}address2</sql>
        </field>
        <field table="bl" name="lat"/>
        <field table="bl" name="lon"/>
        <field table="bl" name="site_id"/>
        <field table="bl" name="name"/>
        <restriction type="sql"
            sql="bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                AND EXISTS(SELECT a.activity_log_id
                            FROM activity_log a, project b
                            WHERE a.activity_type = 'ASSESSMENT - HAZMAT'
                                AND a.bl_id IS NOT NULL AND a.bl_id = bl.bl_id
                                AND a.project_id IS NOT NULL AND b.project_id = a.project_id AND b.project_type='ASSESSMENT - HAZMAT'
                                AND a.fl_id IS NOT NULL
                                AND ${parameters['consoleRestriction']}
                                AND ${parameters['userAssignedRestriction']})"/>
        <parameter name="consoleRestriction" dataType="verbatim" value="1=1"/>
        <parameter name="userAssignedRestriction" dataType="verbatim" value="1=1"/>
    </dataSource>

    <!-- Map panel
        (place it AFTER the drawing panel in order to avoid flash error on initializing several flash controls in FireFox:
        FABridge.js: FABridge__bridgeInitialized(bridgeName))
    -->
    <panel type="html" id="abCbRptHlHaz_htmlMap" showOnLoad="true" layout="centerLayout" region="north">
        <action id="basemapLayerMenu" type="menu" imageName="/schema/ab-core/graphics/icons/view/ab-arcgis-basemap-16.png">
            <title translatable="true">Basemaps</title>
        </action>
        <html>    
            <div id="abCbRptHlHaz_objMap" style="width:100%; height:575px; border:1px solid #000;"> </div>
        </html>
    </panel>
    
    <tabs id="abCbRptHlHaz_tabs" workflow="free" tabRefreshPolicy="refreshOnLoad" layout="centerLayout" region="center">

        <tab name="abCbRptHlHaz_tabRooms" selected="true">
            <title translatable="true">Rooms</title>
            
            <dataSource id="abCbRptHlHaz_dsRepRooms">
                <table name="rm" role="main"/>
                <table name="bl" role="standard"/>
                
                <field name="bl_id" table="bl" hidden="true"/>
                <field name="bl_id">
                    <title translatable="true">Building</title>
                </field>
                <field name="fl_id">
                    <title translatable="true">Floor</title>
                </field>
                <field name="rm_id">
                    <title translatable="true">Room</title>
                </field>
                <field name="rm_cat"/>
                <field name="rm_type"/>
                <field name="dv_id"/>
                <field name="dp_id"/>
                <field name="area"/>
                <field name="vf_assess" dataType="number" size="12" decimals="0">
                    <title translatable="true">Assessments</title>
                    <sql dialect="generic">
                        (SELECT COUNT(activity_log_id)
                        FROM activity_log, project
                        WHERE
                            activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                            AND activity_log.bl_id = rm.bl_id AND activity_log.fl_id = rm.fl_id AND activity_log.rm_id = rm.rm_id
                            AND activity_log.project_id IS NOT NULL AND project.project_id = activity_log.project_id AND project.project_type='ASSESSMENT - HAZMAT'
                            AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                            AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                            AND ${parameters['consoleRestriction']}
                            AND ${parameters['userAssignedRestriction']}
                        )
                    </sql>
                </field>
                <field name="vf_samples" dataType="number" size="12" decimals="0">
                    <title translatable="true">Samples</title>
                    <sql dialect="generic">
                        (SELECT COUNT(cb_samples.activity_log_id)
                        FROM cb_samples, activity_log, project
                        WHERE cb_samples.activity_log_id = activity_log.activity_log_id
                            AND activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                            AND activity_log.bl_id = rm.bl_id AND activity_log.fl_id = rm.fl_id AND activity_log.rm_id = rm.rm_id
                            AND activity_log.project_id IS NOT NULL AND project.project_id = activity_log.project_id AND project.project_type='ASSESSMENT - HAZMAT'
                            AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                            AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                            AND ${parameters['consoleRestriction']}
                            AND ${parameters['userAssignedRestriction']}
                        )
                    </sql>
                </field>
                <field table="rm" name="dwgname" hidden="true"/>
                
                <restriction type="sql"
                    sql="EXISTS(SELECT 1 FROM activity_log, project
                                    WHERE
                        activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                        AND activity_log.bl_id = rm.bl_id AND activity_log.fl_id = rm.fl_id AND activity_log.rm_id = rm.rm_id
                        AND activity_log.project_id IS NOT NULL AND project.project_id = activity_log.project_id AND project.project_type='ASSESSMENT - HAZMAT'
                        AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                        AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                        AND ${parameters['consoleRestriction']}
                        AND ${parameters['userAssignedRestriction']})"/>
                <parameter name="consoleRestriction" dataType="verbatim" value="1=1"/>
                <parameter name="userAssignedRestriction" dataType="verbatim" value="1=1"/>
            </dataSource>

            <panel type="grid" id="abCbRptHlHaz_gridRepRooms" dataSource="abCbRptHlHaz_dsRepRooms" multipleSelectionEnabled="true" showOnLoad="false" layout="centerLayout" region="center">
                <sortField name="bl_id" table="rm" ascending="true"/>
                <sortField name="fl_id" table="rm" ascending="true"/>
                <sortField name="rm_id" table="rm" ascending="true"/>
            </panel>
        </tab>

        <tab name="abCbRptHlHaz_tabHazards">
            <title translatable="true">Hazards</title>

            <dataSource id="abCbRptHlHaz_dsRepHazards">
                <table name="activity_log" role="main"/>
                <table name="project" role="standard"/>
                <table name="bl" role="standard"/>
                
                <field name="activity_log_id">
                    <title translatable="true">Item ID</title>
                </field>
                <field name="site_id">
                    <title translatable="true">Site</title>
                </field>
                <field name="bl_id" table="activity_log">
                    <title translatable="true">Building</title>
                </field>
                <field name="fl_id">
                    <title translatable="true">Floor</title>
                </field>
                <field name="rm_id">
                    <title translatable="true">Room</title>
                </field>
                <field name="hcm_loc_typ_id">
                    <title translatable="true">Location of Material</title>
                </field>
                <field name="project_id" table="project">
                    <title translatable="true">Project</title>
                </field>
                <field name="hcm_is_hazard">
                    <title translatable="true">Contains Hazard?</title>
                </field>
                <field name="hcm_haz_status_id">
                    <title translatable="true">Hazard Status</title>
                </field>
                <field name="prob_type">
                    <title translatable="true">Substance</title>
                </field>
                <field name="date_assessed"/>
                <field name="repair_type">
                    <title translatable="true">Hazard Response</title>
                </field>
                <field name="hcm_id"/>
                <field name="hcm_cond_id">
                    <title translatable="true">Material Condition</title>
                </field>
                <field name="hcm_friable"/>
                <field name="hcm_qty">
                    <title translatable="true">Quantity</title>
                </field>
                <field name="cb_units_id">
                    <title translatable="true">Units</title>
                </field>
                <field name="action_title">
                    <title translatable="true">Material Description</title>
                </field>
                <field name="hcm_haz_rank_id">
                    <title translatable="true">Hazard Rank</title>
                </field>
                <field name="hcm_haz_rating_id">
                    <title translatable="true">Hazard Rating</title>
                </field>
                <field name="vf_samples" dataType="number" size="12" decimals="0">
                    <title translatable="true">Samples Count</title>
                    <sql dialect="generic">
                        (SELECT COUNT(a.activity_log_id) FROM cb_samples ${sql.as} a WHERE a.activity_log_id = activity_log.activity_log_id)
                    </sql>
                </field>
                <field name="location">
                    <title translatable="true">Location Detail</title>
                </field>
                <field name="hcm_harea_id"/>
                <field name="rec_action"/>
                <field name="hcm_pending_act"/>
                <field name="assessed_by"/>
                <field name="assigned_to">
                    <title translatable="true">Inspector/ Assigned To</title>
                </field>
                <field name="hcm_abate_by"/>
                <field name="hcm_class1_id">
                    <title translatable="true">Classification I</title>
                </field>
                <field name="hcm_class2_id">
                    <title translatable="true">Classification II</title>
                </field>
                <field name="hcm_class3_id">
                    <title translatable="true">Classification III</title>
                </field>
                <field name="date_required"/>
                <field name="date_review">
                    <title translatable="true">Date Inspected</title>
                </field>
                <field name="date_installed">
                    <title translatable="true">Date Abated</title>
                </field>
                <field name="date_completed"/>
                <field name="date_closed"/>
                <field name="hcm_pipe_cnt">
                    <title translatable="true">Pipes Count</title>
                </field>
                <field name="hcm_fittings_num">
                    <title translatable="true">Fittings Count</title>
                </field>
                <field name="hcm_labeled"/>
                <field name="cause_type">
                    <title translatable="true">Abatement Reason</title>
                </field>
                <field name="assessment_id">
                    <title translatable="true">Initial Item ID</title>
                </field>
                <field name="cost_estimated"/>
                <field name="cost_est_cap"/>
                <field name="vf_costEstBase" dataType="number" size="12" decimals="2" showTotals="true">
                    <title translatable="true">Cost-Est Baseline</title>
                    <sql dialect="generic">
                        (cost_est_cap + cost_estimated)
                    </sql>
                </field>
                <field name="cost_actual"/>
                <field name="cost_act_cap"/>
                <field name="vf_costActual" dataType="number" size="12" decimals="2" showTotals="true">
                    <title translatable="true">Cost-Actual</title>
                    <sql dialect="generic">
                        (cost_actual + cost_act_cap)
                    </sql>
                </field>
                <!-- field name="project_id" table="project" hidden="true"/-->
                <field name="name" table="bl" hidden="true"/>
                <field table="activity_log" name="dwgname" hidden="true"/>

                <restriction type="sql"
                    sql="activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                        AND activity_log.project_id IS NOT NULL AND project.project_type='ASSESSMENT - HAZMAT'
                        AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                        AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                        AND ${parameters['consoleRestriction']}
                        AND ${parameters['userAssignedRestriction']}"/>
                <parameter name="consoleRestriction" dataType="verbatim" value="1=1"/>
                <parameter name="userAssignedRestriction" dataType="verbatim" value="1=1"/>
            </dataSource>
        
            <panel type="grid" id="abCbRptHlHaz_gridRepHazards" dataSource="abCbRptHlHaz_dsRepHazards" multipleSelectionEnabled="true" showOnLoad="false" layout="centerLayout" region="center">
                <sortField table="activity_log" name="date_assessed" ascending="false"/>
        		<sortField table="activity_log" name="hcm_is_hazard" ascending="false"/>
                <sortField table="activity_log" name="prob_type" ascending="true"/>
                <sortField table="project" name="project_id" ascending="true"/>
                <sortField table="activity_log" name="site_id" ascending="true"/>
                <sortField table="activity_log" name="bl_id" ascending="true"/>
                <sortField table="activity_log" name="hcm_harea_id" ascending="true"/>
                <sortField table="activity_log" name="fl_id" ascending="true"/>
                <sortField table="activity_log" name="rm_id" ascending="true"/>
                <sortField table="activity_log" name="hcm_loc_typ_id" ascending="true"/>
            </panel>
        </tab>

        <tab name="abCbRptHlHaz_tabSamples">
            <title translatable="true">Samples</title>
            
            <dataSource id="abCbRptHlHaz_dsRepSamples">
                <table name="cb_samples" role="main"/>
                <table name="activity_log" role="standard"/>

                <field name="sample_id" table="cb_samples" hidden="true"/>

                <field name="bl_id" table="activity_log">
                    <title translatable="true">Building</title>
                </field>
                <field name="fl_id" table="activity_log">
                    <title translatable="true">Floor</title>
                </field>
                <field name="rm_id" table="activity_log">
                    <title translatable="true">Room</title>
                </field>
                <field name="activity_log_id" table="activity_log">
                    <title translatable="true">Item ID</title>
                </field>
                <field name="hcm_loc_typ_id" table="activity_log">
                    <title translatable="true">Location</title>
                </field>
                <field name="hcm_harea_id" table="activity_log"/>
                <field name="hcm_id" table="activity_log"/>
                <field name="hcm_is_hazard" table="activity_log">
                    <title translatable="true">Hazardous?</title>
                </field>
                <field name="date_collected"/>
                <field name="sample_id"/>
                <field name="sample_code"/>
                <field name="sample_prefix_num"/>
                <field name="sample_desc"/>
                <field name="vf_lab_results" dataType="number" size="12" decimals="0">
                    <title translatable="true">Lab Results</title>
                    <sql dialect="generic">
                        (SELECT COUNT(a.sample_id) FROM cb_sample_result ${sql.as} a WHERE a.sample_id = cb_samples.sample_id)
                    </sql>
                </field>
                <field name="date_received"/>
                <field name="date_analysis"/>
                <field name="sample_loc"/>
                <field name="sample_loc_code"/>
                <field table="cb_samples" name="dwgname" hidden="true"/>

                <restriction type="sql"
                    sql="activity_log.activity_type = 'ASSESSMENT - HAZMAT'
                        AND activity_log.project_id IS NOT NULL
                        AND EXISTS (SELECT 1 FROM project WHERE project.project_id = activity_log.project_id AND project.project_type='ASSESSMENT - HAZMAT')
                        AND activity_log.bl_id IS NOT NULL AND activity_log.fl_id IS NOT NULL
                        AND EXISTS (SELECT 1 FROM bl
                                    WHERE bl.bl_id = activity_log.bl_id
                                        AND bl.ctry_id IS NOT NULL AND bl.regn_id IS NOT NULL AND bl.state_id IS NOT NULL AND bl.city_id IS NOT NULL AND bl.site_id IS NOT NULL
                                        AND ${parameters['consoleRestriction']})
                        AND ${parameters['userAssignedRestriction']}"/>
                <parameter name="consoleRestriction" dataType="verbatim" value="1=1"/>
                <parameter name="userAssignedRestriction" dataType="verbatim" value="1=1"/>
            </dataSource>
        
            <panel type="grid" id="abCbRptHlHaz_gridRepSamples" dataSource="abCbRptHlHaz_dsRepSamples" multipleSelectionEnabled="true" showOnLoad="false" layout="centerLayout" region="center">
                <sortField name="bl_id" table="activity_log" ascending="true"/>
                <sortField name="fl_id" table="activity_log" ascending="true"/>
                <sortField name="rm_id" table="activity_log" ascending="true"/>
                <sortField name="activity_log_id" table="activity_log" ascending="true"/>
            </panel>
        </tab>
    </tabs>
</view>