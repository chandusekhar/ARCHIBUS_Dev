package com.archibus.eventhandler.energy;

import org.apache.log4j.Logger;

import com.archibus.datasource.*;

/**
 * CalculateVarianceValues - calculates the bill variance values for any given bill.
 *
 * <p>
 * History:
 * <li>19.1 Initial implementation.
 *
 * @author Winston Lagos
 */
public class CalculateVarianceValuesService {
    /**
     * Logger to write messages to archibus.log.
     */
    private final static Logger log = Logger.getLogger(IdentifyOutliersService.class);

    static String[] qtyFlds = { "bill_id", "vn_id", "income_variance_avg", "income_variance_month",
            "income_variance_year", "expense_variance_avg", "expense_variance_month",
            "expense_variance_year" };

    /**
     * find all bills within the last 12 months matching bill_id and vn_id and average the
     * amount_expense column
     *
     * @param billId
     * @param vnId
     */
    protected static void calcExpenseVarianceAvgORACLE(final String billId, final String vnId) {
        final String SQL = "" + "UPDATE bill " + "SET    bill.expense_variance_avg = "
                + "       (SELECT " + "               CASE "
                + "                       WHEN sum(bba.amount_expense) IS NULL "
                + "                       THEN  0 "
                + "                       WHEN SUM(bba.amount_expense) / COUNT(1) = 0 "
                + "                       AND     bill.amount_expense             = 0 "
                + "                       THEN 0 "
                + "                       WHEN SUM(bba.amount_expense) / COUNT(1) = 0 "
                + "                       THEN 100 "
                + "                       WHEN bill.amount_expense = 0 "
                + "                       THEN                      - 100 "
                + "                       ELSE (bill.amount_expense - (SUM(bba.amount_expense) / COUNT(1)) ) * 100 / (SUM(bba.amount_expense) / COUNT(1)) "
                + "               END " + "       FROM    (SELECT totalbills.amount_expense "
                + "               FROM    (SELECT mergedbills.* "
                + "                       FROM    (SELECT billunion.bl_id       , "
                + "                                       billunion.vn_id       , "
                + "                                       billunion.vn_ac_id    , "
                + "                                       billunion.bill_type_id, "
                + "                                       billunion.time_period , "
                + "                                       billunion.amount_expense "
                + "                                FROM (SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill x"
                + "                                       WHERE   x.vn_id   = ${parameters['vnId']} "
                + "                                       AND     x.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( x.prorated_aggregated ='NO' "
                + "                                                  AND x.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = x.bill_id )) "
                + "                                             OR x.prorated_aggregated <> 'NO') "
                + "                                       UNION ALL "
                + "                                       SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill_archive y"
                + "                                       WHERE   y.vn_id   = ${parameters['vnId']} "
                + "                                       AND     y.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( y.prorated_aggregated ='NO' "
                + "                                                  AND y.reference_bill_id IS NULL "
                + "                                                  AND (NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = y.bill_id ) "
                + "                                                                   AND NOT EXISTS(SELECT 1 FROM bill_archive bbc WHERE bbc.reference_bill_id = y.bill_id ))) "
                + "                                             OR y.prorated_aggregated <> 'NO') "
                + "                                    ) billunion"
                + "                               ) "
                + "                               mergedbills "
                + "                               JOIN "
                + "                                       (SELECT bl_id        , "
                + "                                               vn_id        , "
                + "                                               vn_ac_id     , "
                + "                                               bill_type_id , "
                + "                                               time_period  , "
                + "                                               amount_expense, "
                + "                                               prorated_aggregated, "
                + "                                               reference_bill_id "
                + "                                       FROM    bill z"
                + "                                       WHERE   z.bill_id = ${parameters['billId']} "
                + "                                       AND     z.vn_id   = ${parameters['vnId']} "
                + "                                       AND ( ( z.prorated_aggregated ='NO' "
                + "                                                  AND z.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = z.bill_id )) "
                + "                                             OR z.prorated_aggregated <> 'NO') "
                + "                                       ) "
                + "                                       abill "
                + "                               ON      mergedbills.bl_id        = abill.bl_id "
                + "                               AND     mergedbills.vn_id        = abill.vn_id "
                + "                               AND     mergedbills.vn_ac_id     = abill.vn_ac_id "
                + "                               AND     mergedbills.bill_type_id = abill.bill_type_id "
                + "                       WHERE   mergedbills.time_period IN "
                + "                               (SELECT h.time_period "
                + "                               FROM    energy_time_period h "
                + "                               WHERE   h.period_index >= "
                + "                                       (SELECT c.period_index - 12 "
                + "                                       FROM    bill b "
                + "                                               JOIN energy_time_period c "
                + "                                               ON      b.time_period = c.time_period "
                + "                                       WHERE   b.bill_id             = ${parameters['billId']} "
                + "                                       AND     b.vn_id               = ${parameters['vnId']} "
                + "                                       ) "
                + "                               AND     h.period_index < "
                + "                                       (SELECT c.period_index "
                + "                                       FROM    bill b "
                + "                                               JOIN energy_time_period c "
                + "                                               ON      b.time_period = c.time_period "
                + "                                       WHERE   b.bill_id             = ${parameters['billId']} "
                + "                                       AND     b.vn_id               = ${parameters['vnId']} "
                + "                                       ) " + "                               ) "
                + "                       ) " + "                       totalbills "
                + "               ) " + "               bba " + "       ) "
                + "WHERE  bill.bill_id = ${parameters['billId']} "
                + "AND    bill.vn_id   = ${parameters['vnId']}";

        final DataSource DS = DataSourceFactory.createDataSourceForFields("bill", qtyFlds);
        DS.addQuery(SQL);
        DS.addParameter("billId", billId, DataSource.DATA_TYPE_TEXT);
        DS.addParameter("vnId", vnId, DataSource.DATA_TYPE_TEXT);
        DS.executeUpdate();
    }

    /**
     * find all bills within the last 12 months matching bill_id and vn_id and average the
     * amount_expense column
     *
     * @param billId
     * @param vnId
     */
    protected static void calcExpenseVarianceAvgSQL(final String billId, final String vnId) {
        final String SQL = "" + "UPDATE bill " + "SET    bill.expense_variance_avg = "
                + "       CASE " + "              WHEN a.expense_variance_avg = 0 "
                + "              AND    bill.amount_expense  = 0 " + "              THEN 0 "
                + "              WHEN a.expense_variance_avg = 0 " + "              THEN 100 "
                + "              WHEN bill.amount_expense = 0 " + "              THEN -100 "
                + "              ELSE ( ( bill.amount_expense - a.expense_variance_avg ) / a.expense_variance_avg ) * 100 "
                + "       END "
                + "FROM   (SELECT SUM(bba.amount_expense) / COUNT(1) AS expense_variance_avg "
                + "       FROM    (SELECT totalbills.amount_expense "
                + "               FROM    (SELECT mergedbills.* "
                + "                       FROM    (SELECT billunion.bl_id       , "
                + "                                       billunion.vn_id       , "
                + "                                       billunion.vn_ac_id    , "
                + "                                       billunion.bill_type_id, "
                + "                                       billunion.time_period , "
                + "                                       billunion.amount_expense "
                + "                                FROM (SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill x"
                + "                                       WHERE   x.vn_id   = ${parameters['vnId']} "
                + "                                       AND     x.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( x.prorated_aggregated ='NO' "
                + "                                                  AND x.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = x.bill_id )) "
                + "                                             OR x.prorated_aggregated <> 'NO') "
                + "                                       UNION ALL "
                + "                                       SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill_archive y"
                + "                                       WHERE   y.vn_id   = ${parameters['vnId']} "
                + "                                       AND     y.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( y.prorated_aggregated ='NO' "
                + "                                                  AND y.reference_bill_id IS NULL "
                + "                                                  AND (NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = y.bill_id ) "
                + "                                                                   AND NOT EXISTS(SELECT 1 FROM bill_archive bbc WHERE bbc.reference_bill_id = y.bill_id ))) "
                + "                                             OR y.prorated_aggregated <> 'NO') "
                + "                                    ) billunion"
                + "                               ) "
                + "                               mergedbills "
                + "                               JOIN "
                + "                                       (SELECT bl_id       , "
                + "                                               vn_id       , "
                + "                                               vn_ac_id    , "
                + "                                               bill_type_id, "
                + "                                               time_period , "
                + "                                               amount_expense, "
                + "                                               prorated_aggregated, "
                + "                                               reference_bill_id "
                + "                                       FROM    bill z "
                + "                                       WHERE   z.bill_id = ${parameters['billId']} "
                + "                                       AND     z.vn_id   = ${parameters['vnId']} "
                + "                                       AND ( ( z.prorated_aggregated ='NO' "
                + "                                                  AND z.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = z.bill_id )) "
                + "                                             OR z.prorated_aggregated <> 'NO') "
                + "                                       ) "
                + "                                       abill "
                + "                               ON      mergedbills.bl_id        = abill.bl_id "
                + "                               AND     mergedbills.vn_id        = abill.vn_id "
                + "                               AND     mergedbills.vn_ac_id     = abill.vn_ac_id "
                + "                               AND     mergedbills.bill_type_id = abill.bill_type_id "
                + "                       WHERE   mergedbills.time_period IN "
                + "                               (SELECT h.time_period "
                + "                               FROM    energy_time_period h "
                + "                               WHERE   h.period_index >= "
                + "                                       (SELECT c.period_index - 12 "
                + "                                       FROM    bill b "
                + "                                               JOIN energy_time_period c "
                + "                                               ON      b.time_period = c.time_period "
                + "                                       WHERE   b.bill_id             = ${parameters['billId']} "
                + "                                       AND     b.vn_id               = ${parameters['vnId']} "
                + "                                       ) "
                + "                               AND     h.period_index < "
                + "                                       (SELECT c.period_index "
                + "                                       FROM    bill b "
                + "                                               JOIN energy_time_period c "
                + "                                               ON      b.time_period = c.time_period "
                + "                                       WHERE   b.bill_id             = ${parameters['billId']} "
                + "                                       AND     b.vn_id               = ${parameters['vnId']} "
                + "                                       ) " + "                               ) "
                + "                       ) " + "                       totalbills "
                + "               ) " + "               bba " + "       ) " + "       a "
                + "WHERE  bill.expense_variance_avg <> a.expense_variance_avg "
                + "AND    bill.bill_id               = ${parameters['billId']} "
                + "AND    bill.vn_id                 = ${parameters['vnId']}";

        final DataSource DS = DataSourceFactory.createDataSourceForFields("bill", qtyFlds);
        DS.addQuery(SQL);
        DS.addParameter("billId", billId, DataSource.DATA_TYPE_TEXT);
        DS.addParameter("vnId", vnId, DataSource.DATA_TYPE_TEXT);
        DS.executeUpdate();
    }

    /**
     * get difference between current month and previous month's amount_expense for a given bill_id
     * and vn_id
     *
     * @param billId
     * @param vnId
     */
    protected static void calcExpenseVarianceMonthORACLE(final String billId, final String vnId) {
        final String SQL = "" + "UPDATE bill " + "SET    bill.expense_variance_month = "
                + "       (SELECT " + "               CASE " + "                       WHEN "
                + "                               ( "
                + "                                       prev.amount_expense IS NULL "
                + "                               OR      prev.amount_expense       = 0 "
                + "                               ) "
                + "                       AND     curr.amount_expense = 0 "
                + "                       THEN 0 "
                + "                       WHEN prev.amount_expense IS NULL "
                + "                       OR      prev.amount_expense    = 0 "
                + "                       THEN 100 "
                + "                       WHEN curr.amount_expense = 0 "
                + "                       THEN                         - 100 "
                + "                       ELSE ( ( curr.amount_expense - prev.amount_expense ) / prev.amount_expense ) * 100 "
                + "               END AS expense_variance_month " + "       FROM    bill curr "
                + "               LEFT OUTER JOIN "
                + "                       (SELECT mergedbills.* "
                + "                       FROM    (SELECT billunion.bl_id       , "
                + "                                       billunion.vn_id       , "
                + "                                       billunion.vn_ac_id    , "
                + "                                       billunion.bill_type_id, "
                + "                                       billunion.time_period , "
                + "                                       billunion.amount_expense "
                + "                                FROM (SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill x "
                + "                                       WHERE   x.vn_id   = ${parameters['vnId']} "
                + "                                       AND     x.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( x.prorated_aggregated ='NO' "
                + "                                                  AND x.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = x.bill_id )) "
                + "                                             OR x.prorated_aggregated <> 'NO') "
                + "                                       UNION ALL "
                + "                                       SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill_archive y "
                + "                                       WHERE   y.vn_id   = ${parameters['vnId']} "
                + "                                       AND     y.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( y.prorated_aggregated ='NO' "
                + "                                                  AND y.reference_bill_id IS NULL "
                + "                                                  AND (NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = y.bill_id ) "
                + "                                                                   AND NOT EXISTS(SELECT 1 FROM bill_archive bbc WHERE bbc.reference_bill_id = y.bill_id ))) "
                + "                                             OR y.prorated_aggregated <> 'NO') "
                + "                                    ) billunion"
                + "                               ) "
                + "                               mergedbills "
                + "                               JOIN "
                + "                                       (SELECT bl_id        , "
                + "                                               vn_id        , "
                + "                                               vn_ac_id     , "
                + "                                               bill_type_id , "
                + "                                               time_period  , "
                + "                                               amount_expense, "
                + "                                               prorated_aggregated, "
                + "                                               reference_bill_id "
                + "                                       FROM    bill z"
                + "                                       WHERE   z.bill_id = ${parameters['billId']} "
                + "                                       AND     z.vn_id   = ${parameters['vnId']} "
                + "                                       AND ( ( z.prorated_aggregated ='NO' "
                + "                                                  AND z.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = z.bill_id )) "
                + "                                             OR z.prorated_aggregated <> 'NO') "
                + "                                       ) "
                + "                                       abill "
                + "                               ON      mergedbills.bl_id        = abill.bl_id "
                + "                               AND     mergedbills.vn_id        = abill.vn_id "
                + "                               AND     mergedbills.vn_ac_id     = abill.vn_ac_id "
                + "                               AND     mergedbills.bill_type_id = abill.bill_type_id "
                + "                       WHERE   mergedbills.time_period          = "
                + "                               (SELECT h.time_period "
                + "                               FROM    energy_time_period h "
                + "                               WHERE   h.period_index = "
                + "                                       (SELECT c.period_index - 1 "
                + "                                       FROM    bill b "
                + "                                               JOIN energy_time_period c "
                + "                                               ON      b.time_period = c.time_period "
                + "                                       WHERE   b.bill_id             = ${parameters['billId']} "
                + "                                       AND     b.vn_id               = ${parameters['vnId']} "
                + "                                       ) " + "                               ) "
                + "                       ) " + "                       prev "
                + "               ON      curr.bl_id        = prev.bl_id "
                + "               AND     curr.vn_id        = prev.vn_id "
                + "               AND     curr.vn_ac_id     = prev.vn_ac_id "
                + "               AND     curr.bill_type_id = prev.bill_type_id "
                + "       WHERE   curr.bill_id              = ${parameters['billId']} "
                + "       AND     curr.vn_id                = ${parameters['vnId']} "
                + "       AND     ROWNUM                    = 1  ) "
                + "WHERE  bill.bill_id = ${parameters['billId']} "
                + "AND    bill.vn_id   = ${parameters['vnId']}";

        final DataSource DS = DataSourceFactory.createDataSourceForFields("bill", qtyFlds);
        DS.addQuery(SQL);
        DS.addParameter("billId", billId, DataSource.DATA_TYPE_TEXT);
        DS.addParameter("vnId", vnId, DataSource.DATA_TYPE_TEXT);
        DS.executeUpdate();
    }

    /**
     * get difference between current month and previous month's amount_expense for a given bill_id
     * and vn_id
     *
     * @param billId
     * @param vnId
     */
    protected static void calcExpenseVarianceMonthSQL(final String billId, final String vnId) {
        final String SQL = "" + "UPDATE bill "
                + "SET    bill.expense_variance_month = a.expense_variance_month "
                + "FROM   (SELECT " + "               CASE " + "                       WHEN "
                + "                               ( "
                + "                                       prev.amount_expense IS NULL "
                + "                               OR      prev.amount_expense       = 0 "
                + "                               ) "
                + "                       AND     curr.amount_expense = 0 "
                + "                       THEN 0 "
                + "                       WHEN prev.amount_expense IS NULL "
                + "                       OR      prev.amount_expense    = 0 "
                + "                       THEN 100 "
                + "                       WHEN curr.amount_expense = 0 "
                + "                       THEN -100 "
                + "                       ELSE ( ( curr.amount_expense - prev.amount_expense ) / prev.amount_expense ) * 100 "
                + "               END AS expense_variance_month " + "       FROM    bill curr "
                + "               LEFT OUTER JOIN "
                + "                       (SELECT mergedbills.* "
                + "                       FROM    (SELECT billunion.bl_id       , "
                + "                                       billunion.vn_id       , "
                + "                                       billunion.vn_ac_id    , "
                + "                                       billunion.bill_type_id, "
                + "                                       billunion.time_period , "
                + "                                       billunion.amount_expense "
                + "                                FROM (SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill x"
                + "                                       WHERE   x.vn_id   = ${parameters['vnId']} "
                + "                                       AND     x.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( x.prorated_aggregated ='NO' "
                + "                                                  AND x.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = x.bill_id )) "
                + "                                             OR x.prorated_aggregated <> 'NO') "
                + "                                       UNION ALL "
                + "                                       SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill_archive y"
                + "                                       WHERE   y.vn_id   = ${parameters['vnId']} "
                + "                                       AND     y.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( y.prorated_aggregated ='NO' "
                + "                                                  AND y.reference_bill_id IS NULL "
                + "                                                  AND (NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = y.bill_id ) "
                + "                                                                   AND NOT EXISTS(SELECT 1 FROM bill_archive bbc WHERE bbc.reference_bill_id = y.bill_id ))) "
                + "                                             OR y.prorated_aggregated <> 'NO') "
                + "                                    ) billunion"
                + "                               ) "
                + "                               mergedbills "
                + "                               JOIN "
                + "                                       (SELECT bl_id       , "
                + "                                               vn_id       , "
                + "                                               vn_ac_id    , "
                + "                                               bill_type_id, "
                + "                                               time_period , "
                + "                                               amount_expense, "
                + "                                               prorated_aggregated, "
                + "                                               reference_bill_id "
                + "                                       FROM    bill z"
                + "                                       WHERE   z.bill_id = ${parameters['billId']} "
                + "                                       AND     z.vn_id   = ${parameters['vnId']} "
                + "                                       AND ( ( z.prorated_aggregated ='NO' "
                + "                                                  AND z.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = z.bill_id )) "
                + "                                             OR z.prorated_aggregated <> 'NO') "
                + "                                       ) "
                + "                                       abill "
                + "                               ON      mergedbills.bl_id        = abill.bl_id "
                + "                               AND     mergedbills.vn_id        = abill.vn_id "
                + "                               AND     mergedbills.vn_ac_id     = abill.vn_ac_id "
                + "                               AND     mergedbills.bill_type_id = abill.bill_type_id "
                + "                       WHERE   mergedbills.time_period          = "
                + "                               (SELECT h.time_period "
                + "                               FROM    energy_time_period h "
                + "                               WHERE   h.period_index = "
                + "                                       (SELECT c.period_index - 1 "
                + "                                       FROM    bill b "
                + "                                               JOIN energy_time_period c "
                + "                                               ON      b.time_period = c.time_period "
                + "                                       WHERE   b.bill_id             = ${parameters['billId']} "
                + "                                       AND     b.vn_id               = ${parameters['vnId']} "
                + "                                       ) " + "                               ) "
                + "                       ) " + "                       prev "
                + "               ON      curr.bl_id        = prev.bl_id "
                + "               AND     curr.vn_id        = prev.vn_id "
                + "               AND     curr.vn_ac_id     = prev.vn_ac_id "
                + "               AND     curr.bill_type_id = prev.bill_type_id "
                + "       WHERE   curr.bill_id              = ${parameters['billId']} "
                + "       AND     curr.vn_id                = ${parameters['vnId']} " + "       ) "
                + "       a " + "WHERE  bill.expense_variance_month <> a.expense_variance_month "
                + "AND    bill.bill_id                 = ${parameters['billId']} "
                + "AND    bill.vn_id                   = ${parameters['vnId']}";

        final DataSource DS = DataSourceFactory.createDataSourceForFields("bill", qtyFlds);
        DS.addQuery(SQL);
        DS.addParameter("billId", billId, DataSource.DATA_TYPE_TEXT);
        DS.addParameter("vnId", vnId, DataSource.DATA_TYPE_TEXT);
        DS.executeUpdate();
    }

    /**
     * get difference between current month and previous years's same month amount_expense for a
     * given bill_id and vn_id
     *
     * @param billId
     * @param vnId
     */
    protected static void calcExpenseVarianceYearORACLE(final String billId, final String vnId) {
        final String SQL = "" + "UPDATE bill " + "SET    bill.expense_variance_year = "
                + "       (SELECT " + "               CASE " + "                       WHEN "
                + "                               ( "
                + "                                       prev.amount_expense IS NULL "
                + "                               OR      prev.amount_expense       = 0 "
                + "                               ) "
                + "                       AND     curr.amount_expense = 0 "
                + "                       THEN 0 "
                + "                       WHEN prev.amount_expense IS NULL "
                + "                       OR      prev.amount_expense    = 0 "
                + "                       THEN 100 "
                + "                       WHEN curr.amount_expense = 0 "
                + "                       THEN                         - 100 "
                + "                       ELSE ( ( curr.amount_expense - prev.amount_expense ) / prev.amount_expense ) * 100 "
                + "               END AS expense_variance_year " + "       FROM    bill curr "
                + "               LEFT OUTER JOIN "
                + "                       (SELECT mergedbills.* "
                + "                       FROM    (SELECT billunion.bl_id       , "
                + "                                       billunion.vn_id       , "
                + "                                       billunion.vn_ac_id    , "
                + "                                       billunion.bill_type_id, "
                + "                                       billunion.time_period , "
                + "                                       billunion.amount_expense "
                + "                                FROM (SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense,"
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill x "
                + "                                       WHERE   x.vn_id   = ${parameters['vnId']} "
                + "                                       AND     x.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( x.prorated_aggregated ='NO' "
                + "                                                  AND x.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = x.bill_id )) "
                + "                                             OR x.prorated_aggregated <> 'NO') "
                + "                                       UNION ALL "
                + "                                       SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill_archive y "
                + "                                       WHERE   y.vn_id   = ${parameters['vnId']} "
                + "                                       AND     y.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( y.prorated_aggregated ='NO' "
                + "                                                  AND y.reference_bill_id IS NULL "
                + "                                                  AND (NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = y.bill_id ) "
                + "                                                                   AND NOT EXISTS(SELECT 1 FROM bill_archive bbc WHERE bbc.reference_bill_id = y.bill_id ))) "
                + "                                             OR y.prorated_aggregated <> 'NO') "
                + "                                    ) billunion"
                + "                               ) "
                + "                               mergedbills "
                + "                               JOIN "
                + "                                       (SELECT bl_id        , "
                + "                                               vn_id        , "
                + "                                               vn_ac_id     , "
                + "                                               bill_type_id , "
                + "                                               time_period  , "
                + "                                               amount_expense, "
                + "                                               prorated_aggregated, "
                + "                                               reference_bill_id "
                + "                                       FROM    bill z "
                + "                                       WHERE   z.bill_id = ${parameters['billId']} "
                + "                                       AND     z.vn_id   = ${parameters['vnId']} "
                + "                                       AND ( ( z.prorated_aggregated ='NO' "
                + "                                                  AND z.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = z.bill_id )) "
                + "                                             OR z.prorated_aggregated <> 'NO') "
                + "                                       ) "
                + "                                       abill "
                + "                               ON      mergedbills.bl_id        = abill.bl_id "
                + "                               AND     mergedbills.vn_id        = abill.vn_id "
                + "                               AND     mergedbills.vn_ac_id     = abill.vn_ac_id "
                + "                               AND     mergedbills.bill_type_id = abill.bill_type_id "
                + "                       WHERE   mergedbills.time_period          = "
                + "                               (SELECT h.time_period "
                + "                               FROM    energy_time_period h "
                + "                               WHERE   h.period_index = "
                + "                                       (SELECT c.period_index - 12 "
                + "                                       FROM    bill b "
                + "                                               JOIN energy_time_period c "
                + "                                               ON      b.time_period = c.time_period "
                + "                                       WHERE   b.bill_id             = ${parameters['billId']} "
                + "                                       AND     b.vn_id               = ${parameters['vnId']} "
                + "                                       ) " + "                               ) "
                + "                       ) " + "                       prev "
                + "               ON      curr.bl_id        = prev.bl_id "
                + "               AND     curr.vn_id        = prev.vn_id "
                + "               AND     curr.vn_ac_id     = prev.vn_ac_id "
                + "               AND     curr.bill_type_id = prev.bill_type_id "
                + "       WHERE   curr.bill_id              = ${parameters['billId']} "
                + "       AND     curr.vn_id                = ${parameters['vnId']} "
                + "       AND     ROWNUM                    = 1  ) "
                + "WHERE  bill.bill_id = ${parameters['billId']} "
                + "AND    bill.vn_id   = ${parameters['vnId']}";

        final DataSource DS = DataSourceFactory.createDataSourceForFields("bill", qtyFlds);
        DS.addQuery(SQL);
        DS.addParameter("billId", billId, DataSource.DATA_TYPE_TEXT);
        DS.addParameter("vnId", vnId, DataSource.DATA_TYPE_TEXT);
        DS.executeUpdate();
    }

    /**
     * get difference between current month and previous years's same month amount_expense for a
     * given bill_id and vn_id
     *
     * @param billId
     * @param vnId
     */
    protected static void calcExpenseVarianceYearSQL(final String billId, final String vnId) {
        final String SQL = "" + "UPDATE bill "
                + "SET    bill.expense_variance_year = a.expense_variance_year " + "FROM   (SELECT "
                + "               CASE " + "                       WHEN "
                + "                               ( "
                + "                                       prev.amount_expense IS NULL "
                + "                               OR      prev.amount_expense       = 0 "
                + "                               ) "
                + "                       AND     curr.amount_expense = 0 "
                + "                       THEN 0 "
                + "                       WHEN prev.amount_expense IS NULL "
                + "                       OR      prev.amount_expense    = 0 "
                + "                       THEN 100 "
                + "                       WHEN curr.amount_expense = 0 "
                + "                       THEN -100 "
                + "                       ELSE ( ( curr.amount_expense - prev.amount_expense ) / prev.amount_expense ) * 100 "
                + "               END AS expense_variance_year " + "       FROM    bill curr "
                + "               LEFT OUTER JOIN "
                + "                       (SELECT mergedbills.* "
                + "                       FROM    (SELECT billunion.bl_id       , "
                + "                                       billunion.vn_id       , "
                + "                                       billunion.vn_ac_id    , "
                + "                                       billunion.bill_type_id, "
                + "                                       billunion.time_period , "
                + "                                       billunion.amount_expense "
                + "                                FROM (SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill x "
                + "                                       WHERE   x.vn_id   = ${parameters['vnId']} "
                + "                                       AND     x.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( x.prorated_aggregated ='NO' "
                + "                                                  AND x.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = x.bill_id )) "
                + "                                             OR x.prorated_aggregated <> 'NO') "
                + "                                       UNION ALL "
                + "                                       SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill_archive y"
                + "                                       WHERE   y.vn_id   = ${parameters['vnId']} "
                + "                                       AND     y.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( y.prorated_aggregated ='NO' "
                + "                                                  AND y.reference_bill_id IS NULL "
                + "                                                  AND (NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = y.bill_id ) "
                + "                                                                   AND NOT EXISTS(SELECT 1 FROM bill_archive bbc WHERE bbc.reference_bill_id = y.bill_id ))) "
                + "                                             OR y.prorated_aggregated <> 'NO') "
                + "                                    ) billunion"
                + "                               ) "
                + "                               mergedbills "
                + "                               JOIN "
                + "                                       (SELECT bl_id       , "
                + "                                               vn_id       , "
                + "                                               vn_ac_id    , "
                + "                                               bill_type_id, "
                + "                                               time_period , "
                + "                                               amount_expense, "
                + "                                               prorated_aggregated, "
                + "                                               reference_bill_id "
                + "                                       FROM    bill z"
                + "                                       WHERE   z.bill_id = ${parameters['billId']} "
                + "                                       AND     z.vn_id   = ${parameters['vnId']} "
                + "                                       AND ( ( z.prorated_aggregated ='NO' "
                + "                                                  AND z.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = z.bill_id )) "
                + "                                             OR z.prorated_aggregated <> 'NO') "
                + "                                       ) "
                + "                                       abill "
                + "                               ON      mergedbills.bl_id        = abill.bl_id "
                + "                               AND     mergedbills.vn_id        = abill.vn_id "
                + "                               AND     mergedbills.vn_ac_id     = abill.vn_ac_id "
                + "                               AND     mergedbills.bill_type_id = abill.bill_type_id "
                + "                       WHERE   mergedbills.time_period          = "
                + "                               (SELECT h.time_period "
                + "                               FROM    energy_time_period h "
                + "                               WHERE   h.period_index = "
                + "                                       (SELECT c.period_index - 12 "
                + "                                       FROM    bill b "
                + "                                               JOIN energy_time_period c "
                + "                                               ON      b.time_period = c.time_period "
                + "                                       WHERE   b.bill_id             = ${parameters['billId']} "
                + "                                       AND     b.vn_id               = ${parameters['vnId']} "
                + "                                       ) " + "                               ) "
                + "                       ) " + "                       prev "
                + "               ON      curr.bl_id        = prev.bl_id "
                + "               AND     curr.vn_id        = prev.vn_id "
                + "               AND     curr.vn_ac_id     = prev.vn_ac_id "
                + "               AND     curr.bill_type_id = prev.bill_type_id "
                + "       WHERE   curr.bill_id              = ${parameters['billId']} "
                + "       AND     curr.vn_id                = ${parameters['vnId']} " + "       ) "
                + "       a " + "WHERE  bill.expense_variance_year <> a.expense_variance_year "
                + "AND    bill.bill_id                = ${parameters['billId']} "
                + "AND    bill.vn_id                  = ${parameters['vnId']}";

        final DataSource DS = DataSourceFactory.createDataSourceForFields("bill", qtyFlds);
        DS.addQuery(SQL);
        DS.addParameter("billId", billId, DataSource.DATA_TYPE_TEXT);
        DS.addParameter("vnId", vnId, DataSource.DATA_TYPE_TEXT);
        DS.executeUpdate();
    }

    /*
     * ORALCE
     *
     * /
     *
     * /** find all bills within the last 12 months matching bill_id and vn_id and average the
     * amount_income column
     *
     * @param billId
     *
     * @param vnId
     */
    protected static void calcIncomeVarianceAvgORACLE(final String billId, final String vnId) {
        final String SQL = "" + "UPDATE bill " + "SET    bill.income_variance_avg = "
                + "       (SELECT " + "               CASE "
                + "                       WHEN sum(bba.amount_income) IS NULL "
                + "                       THEN  0 "
                + "                       WHEN SUM(bba.amount_income) / COUNT(1) = 0 "
                + "                       AND     bill.amount_income             = 0 "
                + "                       THEN 0 "
                + "                       WHEN SUM(bba.amount_income) / COUNT(1) = 0 "
                + "                       THEN 100 "
                + "                       WHEN bill.amount_income = 0 "
                + "                       THEN                     - 100 "
                + "                       ELSE (bill.amount_income - (SUM(bba.amount_income) / COUNT(1)) ) * 100 / (SUM(bba.amount_income) / COUNT(1)) "
                + "               END " + "       FROM    (SELECT totalbills.amount_income "
                + "               FROM    (SELECT mergedbills.* "
                + "                       FROM    (SELECT billunion.bl_id       , "
                + "                                       billunion.vn_id       , "
                + "                                       billunion.vn_ac_id    , "
                + "                                       billunion.bill_type_id, "
                + "                                       billunion.time_period , "
                + "                                       billunion.amount_income "
                + "                                FROM (SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense,"
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill x"
                + "                                       WHERE   vn_id   = ${parameters['vnId']} "
                + "                                       AND     vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( x.prorated_aggregated ='NO' "
                + "                                                  AND x.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = x.bill_id )) "
                + "                                             OR x.prorated_aggregated <> 'NO') "
                + "                                       UNION ALL "
                + "                                       SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense,"
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill_archive y"
                + "                                       WHERE   vn_id   = ${parameters['vnId']} "
                + "                                       AND     vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( y.prorated_aggregated ='NO' "
                + "                                                  AND y.reference_bill_id IS NULL "
                + "                                                  AND (NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = y.bill_id ) "
                + "                                                                   AND NOT EXISTS(SELECT 1 FROM bill_archive bbc WHERE bbc.reference_bill_id = y.bill_id ))) "
                + "                                             OR y.prorated_aggregated <> 'NO') "
                + "                                    ) billunion"
                + "                               ) "
                + "                               mergedbills "
                + "                               JOIN "
                + "                                       (SELECT bl_id        , "
                + "                                               vn_id        , "
                + "                                               vn_ac_id     , "
                + "                                               bill_type_id , "
                + "                                               time_period  , "
                + "                                               amount_income, "
                + "                                               prorated_aggregated, "
                + "                                               reference_bill_id "
                + "                                       FROM    bill z"
                + "                                       WHERE   bill_id = ${parameters['billId']} "
                + "                                       AND     vn_id   = ${parameters['vnId']} "
                + "                                       AND ( ( z.prorated_aggregated ='NO' "
                + "                                                  AND z.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = z.bill_id )) "
                + "                                             OR z.prorated_aggregated <> 'NO') "
                + "                                       ) "
                + "                                       abill "
                + "                               ON      mergedbills.bl_id        = abill.bl_id "
                + "                               AND     mergedbills.vn_id        = abill.vn_id "
                + "                               AND     mergedbills.vn_ac_id     = abill.vn_ac_id "
                + "                               AND     mergedbills.bill_type_id = abill.bill_type_id "
                + "                       WHERE   mergedbills.time_period IN "
                + "                               (SELECT h.time_period "
                + "                               FROM    energy_time_period h "
                + "                               WHERE   h.period_index >= "
                + "                                       (SELECT c.period_index - 12 "
                + "                                       FROM    bill b "
                + "                                               JOIN energy_time_period c "
                + "                                               ON      b.time_period = c.time_period "
                + "                                       WHERE   b.bill_id             = ${parameters['billId']} "
                + "                                       AND     b.vn_id               = ${parameters['vnId']} "
                + "                                       ) "
                + "                               AND     h.period_index < "
                + "                                       (SELECT c.period_index "
                + "                                       FROM    bill b "
                + "                                               JOIN energy_time_period c "
                + "                                               ON      b.time_period = c.time_period "
                + "                                       WHERE   b.bill_id             = ${parameters['billId']} "
                + "                                       AND     b.vn_id               = ${parameters['vnId']} "
                + "                                       ) " + "                               ) "
                + "                       ) " + "                       totalbills "
                + "               ) " + "               bba " + "       ) "
                + "WHERE  bill.bill_id = ${parameters['billId']} "
                + "AND    bill.vn_id   = ${parameters['vnId']}";

        final DataSource DS = DataSourceFactory.createDataSourceForFields("bill", qtyFlds);
        DS.addQuery(SQL);
        DS.addParameter("billId", billId, DataSource.DATA_TYPE_TEXT);
        DS.addParameter("vnId", vnId, DataSource.DATA_TYPE_TEXT);
        DS.executeUpdate();
    }

    /**
     * find all bills within the last 12 months matching bill_id and vn_id and average the
     * amount_income column
     *
     * @param billId
     * @param vnId
     */
    protected static void calcIncomeVarianceAvgSQL(final String billId, final String vnId) {
        final String SQL = "" + "UPDATE bill " + "SET    bill.income_variance_avg = "
                + "       CASE " + "              WHEN a.income_variance_avg = 0 "
                + "              AND    bill.amount_income  = 0 " + "              THEN 0 "
                + "              WHEN a.income_variance_avg = 0 " + "              THEN 100 "
                + "              WHEN bill.amount_income = 0 " + "              THEN -100 "
                + "              ELSE ( ( bill.amount_income - a.income_variance_avg ) / a.income_variance_avg ) * 100 "
                + "       END "
                + "FROM   (SELECT SUM(bba.amount_income) / COUNT(1) AS income_variance_avg "
                + "       FROM    (SELECT totalbills.amount_income "
                + "               FROM    (SELECT mergedbills.* "
                + "                       FROM    (SELECT billunion.bl_id       , "
                + "                                       billunion.vn_id       , "
                + "                                       billunion.vn_ac_id    , "
                + "                                       billunion.bill_type_id, "
                + "                                       billunion.time_period , "
                + "                                       billunion.amount_income "
                + "                                FROM (SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense,"
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill x"
                + "                                       WHERE   x.vn_id   = ${parameters['vnId']} "
                + "                                       AND     x.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} ) "
                + "                                       AND ( ( x.prorated_aggregated ='NO' "
                + "                                                  AND x.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = x.bill_id )) "
                + "                                             OR x.prorated_aggregated <> 'NO') "
                + "                                       UNION ALL "
                + "                                       SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill_archive y"
                + "                                       WHERE   y.vn_id   = ${parameters['vnId']} "
                + "                                       AND     y.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( y.prorated_aggregated ='NO' "
                + "                                                  AND y.reference_bill_id IS NULL "
                + "                                                  AND (NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = y.bill_id ) "
                + "                                                                   AND NOT EXISTS(SELECT 1 FROM bill_archive bbc WHERE bbc.reference_bill_id = y.bill_id ))) "
                + "                                             OR y.prorated_aggregated <> 'NO') "
                + "                                    ) billunion"
                + "                               ) "
                + "                               mergedbills "
                + "                               JOIN "
                + "                                       (SELECT bl_id       , "
                + "                                               vn_id       , "
                + "                                               vn_ac_id    , "
                + "                                               bill_type_id, "
                + "                                               time_period , "
                + "                                               amount_income, "
                + "                                               prorated_aggregated, "
                + "                                               reference_bill_id "
                + "                                       FROM    bill z "
                + "                                       WHERE   z.bill_id = ${parameters['billId']} "
                + "                                       AND     z.vn_id   = ${parameters['vnId']} "
                + "                                       AND ( ( z.prorated_aggregated ='NO' "
                + "                                                  AND z.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = z.bill_id )) "
                + "                                             OR z.prorated_aggregated <> 'NO') "
                + "                                       ) "
                + "                                       abill "
                + "                               ON      mergedbills.bl_id        = abill.bl_id "
                + "                               AND     mergedbills.vn_id        = abill.vn_id "
                + "                               AND     mergedbills.vn_ac_id     = abill.vn_ac_id "
                + "                               AND     mergedbills.bill_type_id = abill.bill_type_id "
                + "                       WHERE   mergedbills.time_period IN "
                + "                               (SELECT h.time_period "
                + "                               FROM    energy_time_period h "
                + "                               WHERE   h.period_index >= "
                + "                                       (SELECT c.period_index - 12 "
                + "                                       FROM    bill b "
                + "                                               JOIN energy_time_period c "
                + "                                               ON      b.time_period = c.time_period "
                + "                                       WHERE   b.bill_id             = ${parameters['billId']} "
                + "                                       AND     b.vn_id               = ${parameters['vnId']} "
                + "                                       ) "
                + "                               AND     h.period_index < "
                + "                                       (SELECT c.period_index "
                + "                                       FROM    bill b "
                + "                                               JOIN energy_time_period c "
                + "                                               ON      b.time_period = c.time_period "
                + "                                       WHERE   b.bill_id             = ${parameters['billId']} "
                + "                                       AND     b.vn_id               = ${parameters['vnId']} "
                + "                                       ) " + "                               ) "
                + "                       ) " + "                       totalbills "
                + "               ) " + "               bba " + "       ) " + "       a "
                + "WHERE  bill.income_variance_avg <> a.income_variance_avg "
                + "AND    bill.bill_id              = ${parameters['billId']} "
                + "AND    bill.vn_id                = ${parameters['vnId']}";

        final DataSource DS = DataSourceFactory.createDataSourceForFields("bill", qtyFlds);
        DS.addQuery(SQL);
        DS.addParameter("billId", billId, DataSource.DATA_TYPE_TEXT);
        DS.addParameter("vnId", vnId, DataSource.DATA_TYPE_TEXT);
        DS.executeUpdate();
    }

    /**
     * get difference between current month and previous month's amount_income for a given bill_id
     * and vn_id
     *
     * @param billId
     * @param vnId
     */
    protected static void calcIncomeVarianceMonthORACLE(final String billId, final String vnId) {
        final String SQL = "" + "UPDATE bill " + "SET    bill.income_variance_month = "
                + "       (SELECT " + "               CASE " + "                       WHEN "
                + "                               ( "
                + "                                       prev.amount_income IS NULL "
                + "                               OR      prev.amount_income       = 0 "
                + "                               ) "
                + "                       AND     curr.amount_income = 0 "
                + "                       THEN 0 "
                + "                       WHEN prev.amount_income IS NULL "
                + "                       OR      prev.amount_income    = 0 "
                + "                       THEN 100 "
                + "                       WHEN curr.amount_income = 0 "
                + "                       THEN                        - 100 "
                + "                       ELSE ( ( curr.amount_income - prev.amount_income ) / prev.amount_income ) * 100 "
                + "               END AS income_variance_month " + "       FROM    bill curr "
                + "               LEFT OUTER JOIN "
                + "                       (SELECT mergedbills.* "
                + "                       FROM    (SELECT billunion.bl_id       , "
                + "                                       billunion.vn_id       , "
                + "                                       billunion.vn_ac_id    , "
                + "                                       billunion.bill_type_id, "
                + "                                       billunion.time_period , "
                + "                                       billunion.amount_income "
                + "                                FROM (SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill x "
                + "                                       WHERE   x.vn_id   = ${parameters['vnId']} "
                + "                                       AND     x.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} ) AND bill_id = ${parameters['billId']} "
                + "                                       AND ( ( x.prorated_aggregated ='NO' "
                + "                                                  AND x.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = x.bill_id )) "
                + "                                             OR x.prorated_aggregated <> 'NO') "
                + "                                       UNION ALL "
                + "                                       SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill_archive y "
                + "                                       WHERE   y.vn_id   = ${parameters['vnId']} "
                + "                                       AND     y.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} ) AND bill_id = ${parameters['billId']}"
                + "                                       AND ( ( y.prorated_aggregated ='NO' "
                + "                                                  AND y.reference_bill_id IS NULL "
                + "                                                  AND (NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = y.bill_id ) "
                + "                                                                   AND NOT EXISTS(SELECT 1 FROM bill_archive bbc WHERE bbc.reference_bill_id = y.bill_id ))) "
                + "                                             OR y.prorated_aggregated <> 'NO') "
                + "                                    ) billunion"
                + "                               ) "
                + "                               mergedbills "
                + "                               JOIN "
                + "                                       (SELECT bl_id        , "
                + "                                               vn_id        , "
                + "                                               vn_ac_id     , "
                + "                                               bill_type_id , "
                + "                                               time_period  , "
                + "                                               amount_income, "
                + "                                               prorated_aggregated, "
                + "                                               reference_bill_id "
                + "                                       FROM    bill z "
                + "                                       WHERE   z.bill_id = ${parameters['billId']} "
                + "                                       AND     z.vn_id   = ${parameters['vnId']} "
                + "                                       AND ( ( z.prorated_aggregated ='NO' "
                + "                                                  AND z.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = z.bill_id )) "
                + "                                             OR z.prorated_aggregated <> 'NO') "
                + "                                       ) "
                + "                                       abill "
                + "                               ON      mergedbills.bl_id        = abill.bl_id "
                + "                               AND     mergedbills.vn_id        = abill.vn_id "
                + "                               AND     mergedbills.vn_ac_id     = abill.vn_ac_id "
                + "                               AND     mergedbills.bill_type_id = abill.bill_type_id "
                + "                       WHERE   mergedbills.time_period          = "
                + "                               (SELECT h.time_period "
                + "                               FROM    energy_time_period h "
                + "                               WHERE   h.period_index = "
                + "                                       (SELECT c.period_index - 1 "
                + "                                       FROM    bill b "
                + "                                               JOIN energy_time_period c "
                + "                                               ON      b.time_period = c.time_period "
                + "                                       WHERE   b.bill_id             = ${parameters['billId']} "
                + "                                       AND     b.vn_id               = ${parameters['vnId']} "
                + "                                       ) " + "                               ) "
                + "                       ) " + "                       prev "
                + "               ON      curr.bl_id        = prev.bl_id "
                + "               AND     curr.vn_id        = prev.vn_id "
                + "               AND     curr.vn_ac_id     = prev.vn_ac_id "
                + "               AND     curr.bill_type_id = prev.bill_type_id "
                + "       WHERE   curr.bill_id              = ${parameters['billId']} "
                + "       AND     curr.vn_id                = ${parameters['vnId']} "
                + "       AND     ROWNUM                    = 1  ) "
                + "WHERE  bill.bill_id = ${parameters['billId']} "
                + "AND    bill.vn_id   = ${parameters['vnId']}";

        final DataSource DS = DataSourceFactory.createDataSourceForFields("bill", qtyFlds);
        DS.addQuery(SQL);
        DS.addParameter("billId", billId, DataSource.DATA_TYPE_TEXT);
        DS.addParameter("vnId", vnId, DataSource.DATA_TYPE_TEXT);
        DS.executeUpdate();
    }

    /**
     * get difference between current month and previous month's amount_income for a given bill_id
     * and vn_id
     *
     * @param billId
     * @param vnId
     */
    protected static void calcIncomeVarianceMonthSQL(final String billId, final String vnId) {
        final String SQL = "" + "UPDATE bill "
                + "SET    bill.income_variance_month = a.income_variance_month " + "FROM   (SELECT "
                + "               CASE " + "                       WHEN "
                + "                               ( "
                + "                                       prev.amount_income IS NULL "
                + "                               OR      prev.amount_income       = 0 "
                + "                               ) "
                + "                       AND     curr.amount_income = 0 "
                + "                       THEN 0 "
                + "                       WHEN prev.amount_income IS NULL "
                + "                       OR      prev.amount_income    = 0 "
                + "                       THEN 100 "
                + "                       WHEN curr.amount_income = 0 "
                + "                       THEN -100 "
                + "                       ELSE ( ( curr.amount_income - prev.amount_income ) / prev.amount_income ) * 100 "
                + "               END AS income_variance_month " + "       FROM    bill curr "
                + "               LEFT OUTER JOIN "
                + "                       (SELECT mergedbills.* "
                + "                       FROM    (SELECT billunion.bl_id       , "
                + "                                       billunion.vn_id       , "
                + "                                       billunion.vn_ac_id    , "
                + "                                       billunion.bill_type_id, "
                + "                                       billunion.time_period , "
                + "                                       billunion.amount_income "
                + "                                FROM (SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill x"
                + "                                       WHERE   x.vn_id   = ${parameters['vnId']} "
                + "                                       AND     x.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( x.prorated_aggregated ='NO' "
                + "                                                  AND x.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = x.bill_id )) "
                + "                                             OR x.prorated_aggregated <> 'NO') "
                + "                                       UNION ALL "
                + "                                       SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill_archive y "
                + "                                       WHERE   y.vn_id   = ${parameters['vnId']} "
                + "                                       AND     y.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( y.prorated_aggregated ='NO' "
                + "                                                  AND y.reference_bill_id IS NULL "
                + "                                                  AND (NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = y.bill_id ) "
                + "                                                                   AND NOT EXISTS(SELECT 1 FROM bill_archive bbc WHERE bbc.reference_bill_id = y.bill_id ))) "
                + "                                             OR y.prorated_aggregated <> 'NO') "
                + "                                    ) billunion"
                + "                               ) "
                + "                               mergedbills "
                + "                               JOIN "
                + "                                       (SELECT bl_id       , "
                + "                                               vn_id       , "
                + "                                               vn_ac_id    , "
                + "                                               bill_type_id, "
                + "                                               time_period , "
                + "                                               amount_income, "
                + "                                               prorated_aggregated, "
                + "                                               reference_bill_id "
                + "                                       FROM    bill z "
                + "                                       WHERE   z.bill_id = ${parameters['billId']} "
                + "                                       AND     z.vn_id   = ${parameters['vnId']} "
                + "                                       AND ( ( z.prorated_aggregated ='NO' "
                + "                                                  AND z.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = z.bill_id )) "
                + "                                             OR z.prorated_aggregated <> 'NO') "
                + "                                       ) "
                + "                                       abill "
                + "                               ON      mergedbills.bl_id        = abill.bl_id "
                + "                               AND     mergedbills.vn_id        = abill.vn_id "
                + "                               AND     mergedbills.vn_ac_id     = abill.vn_ac_id "
                + "                               AND     mergedbills.bill_type_id = abill.bill_type_id "
                + "                       WHERE   mergedbills.time_period          = "
                + "                               (SELECT h.time_period "
                + "                               FROM    energy_time_period h "
                + "                               WHERE   h.period_index = "
                + "                                       (SELECT c.period_index - 1 "
                + "                                       FROM    bill b "
                + "                                               JOIN energy_time_period c "
                + "                                               ON      b.time_period = c.time_period "
                + "                                       WHERE   b.bill_id             = ${parameters['billId']} "
                + "                                       AND     b.vn_id               = ${parameters['vnId']} "
                + "                                       ) " + "                               ) "
                + "                       ) " + "                       prev "
                + "               ON      curr.bl_id        = prev.bl_id "
                + "               AND     curr.vn_id        = prev.vn_id "
                + "               AND     curr.vn_ac_id     = prev.vn_ac_id "
                + "               AND     curr.bill_type_id = prev.bill_type_id "
                + "       WHERE   curr.bill_id              = ${parameters['billId']} "
                + "       AND     curr.vn_id                = ${parameters['vnId']} " + "       ) "
                + "       a " + "WHERE  bill.income_variance_month <> a.income_variance_month "
                + "AND    bill.bill_id                = ${parameters['billId']} "
                + "AND    bill.vn_id                  = ${parameters['vnId']}";

        final DataSource DS = DataSourceFactory.createDataSourceForFields("bill", qtyFlds);
        DS.addQuery(SQL);
        DS.addParameter("billId", billId, DataSource.DATA_TYPE_TEXT);
        DS.addParameter("vnId", vnId, DataSource.DATA_TYPE_TEXT);
        DS.executeUpdate();
    }

    /**
     * get difference between current month and previous years's same month amount_income for a
     * given bill_id and vn_id
     *
     * @param billId
     * @param vnId
     */
    protected static void calcIncomeVarianceYearORACLE(final String billId, final String vnId) {
        final String SQL = "" + "UPDATE bill " + "SET    bill.income_variance_year = "
                + "       (SELECT " + "               CASE " + "                       WHEN "
                + "                               ( "
                + "                                       prev.amount_income IS NULL "
                + "                               OR      prev.amount_income       = 0 "
                + "                               ) "
                + "                       AND     curr.amount_income = 0 "
                + "                       THEN 0 "
                + "                       WHEN prev.amount_income IS NULL "
                + "                       OR      prev.amount_income    = 0 "
                + "                       THEN 100 "
                + "                       WHEN curr.amount_income = 0 "
                + "                       THEN                        - 100 "
                + "                       ELSE ( ( curr.amount_income - prev.amount_income ) / prev.amount_income ) * 100 "
                + "               END AS income_variance_year " + "       FROM    bill curr "
                + "               LEFT OUTER JOIN "
                + "                       (SELECT mergedbills.* "
                + "                       FROM    (SELECT billunion.bl_id       , "
                + "                                       billunion.vn_id       , "
                + "                                       billunion.vn_ac_id    , "
                + "                                       billunion.bill_type_id, "
                + "                                       billunion.time_period , "
                + "                                       billunion.amount_income "
                + "                                FROM (SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill x"
                + "                                       WHERE   x.vn_id   = ${parameters['vnId']} "
                + "                                       AND     x.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( x.prorated_aggregated ='NO' "
                + "                                                  AND x.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = x.bill_id )) "
                + "                                             OR x.prorated_aggregated <> 'NO') "
                + "                                       UNION ALL "
                + "                                       SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill_archive y"
                + "                                       WHERE   y.vn_id   = ${parameters['vnId']} "
                + "                                       AND     y.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( y.prorated_aggregated ='NO' "
                + "                                                  AND y.reference_bill_id IS NULL "
                + "                                                  AND (NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = y.bill_id ) "
                + "                                                                   AND NOT EXISTS(SELECT 1 FROM bill_archive bbc WHERE bbc.reference_bill_id = y.bill_id ))) "
                + "                                             OR y.prorated_aggregated <> 'NO') "
                + "                                    ) billunion"
                + "                               ) "
                + "                               mergedbills "
                + "                               JOIN "
                + "                                       (SELECT bl_id        , "
                + "                                               vn_id        , "
                + "                                               vn_ac_id     , "
                + "                                               bill_type_id , "
                + "                                               time_period  , "
                + "                                               amount_income, "
                + "                                               prorated_aggregated, "
                + "                                               reference_bill_id "
                + "                                       FROM    bill z"
                + "                                       WHERE   z.bill_id = ${parameters['billId']} "
                + "                                       AND     z.vn_id   = ${parameters['vnId']} "
                + "                                       AND ( ( z.prorated_aggregated ='NO' "
                + "                                                  AND z.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = z.bill_id )) "
                + "                                             OR z.prorated_aggregated <> 'NO') "
                + "                                       ) "
                + "                                       abill "
                + "                               ON      mergedbills.bl_id        = abill.bl_id "
                + "                               AND     mergedbills.vn_id        = abill.vn_id "
                + "                               AND     mergedbills.vn_ac_id     = abill.vn_ac_id "
                + "                               AND     mergedbills.bill_type_id = abill.bill_type_id "
                + "                       WHERE   mergedbills.time_period          = "
                + "                               (SELECT h.time_period "
                + "                               FROM    energy_time_period h "
                + "                               WHERE   h.period_index = "
                + "                                       (SELECT c.period_index - 12 "
                + "                                       FROM    bill b "
                + "                                               JOIN energy_time_period c "
                + "                                               ON      b.time_period = c.time_period "
                + "                                       WHERE   b.bill_id             = ${parameters['billId']} "
                + "                                       AND     b.vn_id               = ${parameters['vnId']} "
                + "                                       ) " + "                               ) "
                + "                       ) " + "                       prev "
                + "               ON      curr.bl_id        = prev.bl_id "
                + "               AND     curr.vn_id        = prev.vn_id "
                + "               AND     curr.vn_ac_id     = prev.vn_ac_id "
                + "               AND     curr.bill_type_id = prev.bill_type_id "
                + "       WHERE   curr.bill_id              = ${parameters['billId']} "
                + "       AND     curr.vn_id                = ${parameters['vnId']} "
                + "       AND     ROWNUM                    = 1  ) "
                + "WHERE  bill.bill_id = ${parameters['billId']} "
                + "AND    bill.vn_id   = ${parameters['vnId']}";

        final DataSource DS = DataSourceFactory.createDataSourceForFields("bill", qtyFlds);
        DS.addQuery(SQL);
        DS.addParameter("billId", billId, DataSource.DATA_TYPE_TEXT);
        DS.addParameter("vnId", vnId, DataSource.DATA_TYPE_TEXT);
        DS.executeUpdate();
    }

    /**
     * get difference between current month and previous years's same month amount_income for a
     * given bill_id and vn_id
     *
     * @param billId
     * @param vnId
     */
    protected static void calcIncomeVarianceYearSQL(final String billId, final String vnId) {
        final String SQL = "" + "UPDATE bill "
                + "SET    bill.income_variance_year = a.income_variance_year " + "FROM   (SELECT "
                + "               CASE " + "                       WHEN "
                + "                               ( "
                + "                                       prev.amount_income IS NULL "
                + "                               OR      prev.amount_income       = 0 "
                + "                               ) "
                + "                       AND     curr.amount_income = 0 "
                + "                       THEN 0 "
                + "                       WHEN prev.amount_income IS NULL "
                + "                       OR      prev.amount_income    = 0 "
                + "                       THEN 100 "
                + "                       WHEN curr.amount_income = 0 "
                + "                       THEN -100 "
                + "                       ELSE ( ( curr.amount_income - prev.amount_income ) / prev.amount_income ) * 100 "
                + "               END AS income_variance_year " + "       FROM    bill curr "
                + "               LEFT OUTER JOIN "
                + "                       (SELECT mergedbills.* "
                + "                       FROM    (SELECT billunion.bl_id       , "
                + "                                       billunion.vn_id       , "
                + "                                       billunion.vn_ac_id    , "
                + "                                       billunion.bill_type_id, "
                + "                                       billunion.time_period , "
                + "                                       billunion.amount_income "
                + "                                FROM (SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill x"
                + "                                       WHERE   x.vn_id   = ${parameters['vnId']} "
                + "                                       AND     x.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( x.prorated_aggregated ='NO' "
                + "                                                  AND x.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = x.bill_id )) "
                + "                                             OR x.prorated_aggregated <> 'NO') "
                + "                                       UNION ALL "
                + "                                       SELECT "
                + "                                           bl_id       , "
                + "                                           vn_id       , "
                + "                                           vn_ac_id    , "
                + "                                           bill_type_id, "
                + "                                           time_period , "
                + "                                           amount_income, "
                + "                                           amount_expense, "
                + "                                           prorated_aggregated, "
                + "                                           reference_bill_id "
                + "                                       FROM   bill_archive y"
                + "                                       WHERE   y.vn_id   = ${parameters['vnId']} "
                + "                                       AND     y.vn_ac_id   = "
                + "                                               (SELECT     vn_ac_id "
                + "                                               FROM     bill "
                + "                                               WHERE   bill_id = ${parameters['billId']} "
                + "                                               AND     vn_id = ${parameters['vnId']} )"
                + "                                       AND ( ( y.prorated_aggregated ='NO' "
                + "                                                  AND y.reference_bill_id IS NULL "
                + "                                                  AND (NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = y.bill_id ) "
                + "                                                                   AND NOT EXISTS(SELECT 1 FROM bill_archive bbc WHERE bbc.reference_bill_id = y.bill_id ))) "
                + "                                             OR y.prorated_aggregated <> 'NO') "
                + "                                    ) billunion"
                + "                               ) "
                + "                               mergedbills "
                + "                               JOIN "
                + "                                       (SELECT bl_id       , "
                + "                                               vn_id       , "
                + "                                               vn_ac_id    , "
                + "                                               bill_type_id, "
                + "                                               time_period , "
                + "                                               amount_income "
                + "                                       FROM    bill z "
                + "                                       WHERE   z.bill_id = ${parameters['billId']} "
                + "                                       AND     z.vn_id   = ${parameters['vnId']} "
                + "                                       AND ( ( z.prorated_aggregated ='NO' "
                + "                                                  AND z.reference_bill_id IS NULL "
                + "                                                  AND NOT EXISTS (SELECT 1 FROM bill bb "
                + "                                                                           WHERE bb.reference_bill_id = z.bill_id )) "
                + "                                             OR z.prorated_aggregated <> 'NO') "
                + "                                       ) "
                + "                                       abill "
                + "                               ON      mergedbills.bl_id        = abill.bl_id "
                + "                               AND     mergedbills.vn_id        = abill.vn_id "
                + "                               AND     mergedbills.vn_ac_id     = abill.vn_ac_id "
                + "                               AND     mergedbills.bill_type_id = abill.bill_type_id "
                + "                       WHERE   mergedbills.time_period          = "
                + "                               (SELECT h.time_period "
                + "                               FROM    energy_time_period h "
                + "                               WHERE   h.period_index = "
                + "                                       (SELECT c.period_index - 12 "
                + "                                       FROM    bill b "
                + "                                               JOIN energy_time_period c "
                + "                                               ON      b.time_period = c.time_period "
                + "                                       WHERE   b.bill_id             = ${parameters['billId']} "
                + "                                       AND     b.vn_id               = ${parameters['vnId']} "
                + "                                       ) " + "                               ) "
                + "                       ) " + "                       prev "
                + "               ON      curr.bl_id        = prev.bl_id "
                + "               AND     curr.vn_id        = prev.vn_id "
                + "               AND     curr.vn_ac_id     = prev.vn_ac_id "
                + "               AND     curr.bill_type_id = prev.bill_type_id "
                + "       WHERE   curr.bill_id              = ${parameters['billId']} "
                + "       AND     curr.vn_id                = ${parameters['vnId']} " + "       ) "
                + "       a " + "WHERE  bill.income_variance_year <> a.income_variance_year "
                + "AND    bill.bill_id               = ${parameters['billId']} "
                + "AND    bill.vn_id                 = ${parameters['vnId']}";

        final DataSource DS = DataSourceFactory.createDataSourceForFields("bill", qtyFlds);
        DS.addQuery(SQL);
        DS.addParameter("billId", billId, DataSource.DATA_TYPE_TEXT);
        DS.addParameter("vnId", vnId, DataSource.DATA_TYPE_TEXT);
        DS.executeUpdate();
    }

    /**
     * Invokes the methods that calculate the income_variance_avg, income_variance_month,
     * income_variance_year, expense_variance_avg, expense_variance_month, expense_variance_year.
     *
     * @param billId
     * @param vnId
     * @return true if all methods executed OK.
     */
    public static boolean run(final String billId, final String vnId) {
        if (log.isDebugEnabled()) {
            log.info("CalculateVarianceValues");
        }
        final String[] flds = { "bl_id" };
        final DataSource DS = DataSourceFactory.createDataSourceForFields("bl", flds);
        final Boolean isOracle = DS.isOracle();
        final Boolean isSybase = DS.isSybase();
        final Boolean isSqlServer = DS.isSqlServer();
        if (isSqlServer || isSybase) {
            calcIncomeVarianceAvgSQL(billId, vnId);
            calcIncomeVarianceMonthSQL(billId, vnId);
            calcIncomeVarianceYearSQL(billId, vnId);
            calcExpenseVarianceAvgSQL(billId, vnId);
            calcExpenseVarianceMonthSQL(billId, vnId);
            calcExpenseVarianceYearSQL(billId, vnId);
        } else if (isOracle) {
            calcIncomeVarianceAvgORACLE(billId, vnId);
            calcIncomeVarianceMonthORACLE(billId, vnId);
            calcIncomeVarianceYearORACLE(billId, vnId);
            calcExpenseVarianceAvgORACLE(billId, vnId);
            calcExpenseVarianceMonthORACLE(billId, vnId);
            calcExpenseVarianceYearORACLE(billId, vnId);
        }
        return true;

    }

}
