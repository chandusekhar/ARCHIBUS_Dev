<view version="2.0">
  <layout type="borderLayout" id="mainLayout">
    <west initialSize="300" split="true"/>
    <center autoScroll="true"/>
  </layout>
  <layout type="borderLayout" id="nestedLayout" containingLayout="mainLayout" region="center">
    <north split="true"/>
    <center autoScroll="true"/>
  </layout>
  
    <js file="ab-energy-measure-and-verify.js"/>
    <js file="ab-energy-bill-archive-view-document.js"/>
    
    <title translatable="true">Measurement and Verification</title>
    
    <panel type="view" id="commonView" file="ab-energy-bill-common.axvw"/>
    
    <!-- Console -->    
    <dataSource id="ds_measureVerifyConsole">
        <table name="bill_archive" role="main"/>
        <field table="bill_archive" name="time_period"/>
    </dataSource>
    
    <panel type="console" columns="3" id="panel_measureVerifyConsole" showOnLoad="true" dataSource="ds_measureVerifyConsole" layout="nestedLayout" region="north">
        <title translatable="true">Filter</title>
        <action id="filter">
            <title>Apply</title>
        </action>
        <action id="clear">
            <title translatable="true">Clear</title>
        </action>
        <field table="bill_archive" name="time_period" alias="bill_archive.time_period.from" showSelectValueAction="true">
	    <title translatable="true">Billing Period From</title>
		<action>
		    <title>...</title>
			<tooltip>Select Value</tooltip>
			    <command type="selectValue"
			    fieldNames="bill_archive.time_period.from"
			    selectFieldNames="energy_time_period.time_period"
			    visibleFieldNames="energy_time_period.time_period"
			    sortFieldNames="energy_time_period.time_period"
			    showIndex="true">
                    <title>Billing Period From</title>
			    </command>
		</action>	    
        </field>
        <field table="bill_archive" name="time_period" alias="bill_archive.time_period.to" showSelectValueAction="true">
            <title translatable="true">Billing Period To</title>
		<action>
		    <title>...</title>
			<tooltip>Select Value</tooltip>
			    <command type="selectValue"
			    fieldNames="bill_archive.time_period.to"
			    selectFieldNames="energy_time_period.time_period"
			    visibleFieldNames="energy_time_period.time_period"
			    sortFieldNames="energy_time_period.time_period"
			    showIndex="true">
                    <title>Billing Period To</title>
			    </command>
		</action>            
        </field>
        <field id="vf_bill_units">
            <title translatable="true">Energy Consumption Units</title>
            <html>
                <select class="inputField_box" name="select_bill_units" id="select_bill_units">
                    <option id="select_bill_units_0" value="MMBTU" selected="true">MMBTU</option>
                </select>
            </html>
        </field>
    </panel>

    <!-- Location tree -->
    <dataSource id="ds_measureVerifyCtry">
        <table name="ctry"/>
        <field name="ctry_id"/>
        <field name="name"/>
        <sortField table="ctry" name="ctry_id" ascending="true"/>
        <restriction type="sql" sql="EXISTS (SELECT bl_id FROM bl WHERE bl.ctry_id = ctry.ctry_id)"/>
    </dataSource>

    <dataSource id="ds_measureVerifyRegn">
        <table name="regn"/>
        <field name="regn_id"/>
        <field name="name"/>
        <sortField table="regn" name="regn_id" ascending="true"/>
        <restriction type="sql" sql="EXISTS (SELECT bl_id FROM bl WHERE bl.regn_id = regn.regn_id)"/>
    </dataSource>
    
    <dataSource id="ds_measureVerifyState">
        <table name="state"/>
        <field name="state_id"/>
        <field name="name"/>
        <sortField table="state" name="state_id" ascending="true"/>
        <restriction type="sql" sql="EXISTS (SELECT bl_id FROM bl WHERE bl.state_id = state.state_id)"/>
    </dataSource>

    <dataSource id="ds_measureVerifyCity">
        <table name="city"/>
        <field name="city_id"/>
        <field name="name"/>
        <sortField table="city" name="city_id" ascending="true"/>
        <restriction type="sql" sql="EXISTS (SELECT bl_id FROM bl WHERE bl.city_id = city.city_id)"/>
    </dataSource>
    
    <dataSource id="ds_measureVerifySite">
        <table name="site"/>
        <field name="site_id"/>
        <field name="name"/>
        <sortField table="site" name="site_id" ascending="true"/>
        <restriction type="sql" sql="EXISTS (SELECT bl_id FROM bl WHERE bl.site_id = site.site_id)"/>
    </dataSource>
    
    <dataSource id="ds_measureVerifyBuilding">
        <table name="bl"/>
        <field name="bl_id"/>
        <field name="name"/>
        <sortField table="bl" name="bl_id" ascending="true"/>
    </dataSource>
    
    <panel type="tree" id="panel_measureVerifyCtry" dataSource="ds_measureVerifyCtry" layout="mainLayout" region="west">
        <title translatable="true">Select Location</title>

        <field table="ctry" name="ctry_id"/>
        <field table="ctry" name="name"/>
        <event type="onClickNode">
            <command type="callFunction" functionName="selectLocation"/>
        </event>

        <panel type="tree" id="panel_measureVerifyRegn" dataSource="ds_measureVerifyRegn">
            <field table="regn" name="regn_id"/>
            <field table="regn" name="name"/>
	        <event type="onClickNode">
	            <command type="callFunction" functionName="selectLocation"/>
	        </event>
        </panel>
        
        <panel type="tree" id="panel_measureVerifyState" dataSource="ds_measureVerifyState">
            <field table="state" name="state_id"/>
            <field table="state" name="name"/>
            <event type="onClickNode">
                <command type="callFunction" functionName="selectLocation"/>
            </event>
        </panel>
        
        <panel type="tree" id="panel_measureVerifyCity" dataSource="ds_measureVerifyCity">
            <field table="city" name="city_id"/>
            <field table="city" name="name"/>
            <event type="onClickNode">
                <command type="callFunction" functionName="selectLocation"/>
            </event>
        </panel>
        
        <panel type="tree" id="panel_measureVerifySite" dataSource="ds_measureVerifySite">
            <field table="site" name="site_id"/>
            <field table="site" name="name"/>
            <event type="onClickNode">
                <command type="callFunction" functionName="selectLocation"/>
            </event>
        </panel>
        
        <panel type="tree" id="panel_measureVerifyBuilding" dataSource="ds_measureVerifyBuilding">
            <field table="bl" name="bl_id"/>
            <field table="bl" name="name"/>
            <event type="onClickNode">
                <command type="callFunction" functionName="selectLocation"/>
            </event>
        </panel>
    </panel>
     
    <!-- Chart data sources --> 
     <dataSource id="ds_totalCostTypeChart" type="grouping" applyVpaRestrictions="false">
        <!-- Define parameters for the custom SQL query -->
        <parameter name="locationField" dataType="verbatim" value="ctry_id"/>
        <parameter name="locationValue" dataType="text" value="USA"/>
        
        <!-- Define a custom SQL query that can be restricted by various location values -->
        <sql dialect="generic">SELECT amount_expense, qty_energy, bill_type_id, time_period 
        			FROM bill_archive 
        			WHERE bill_archive.vn_id IN 
        				(SELECT vn_id FROM vn 
        					WHERE vendor_type = 'Energ')
        			AND ${sql.vpaRestriction} AND bill_archive.bl_id IN 
        				(SELECT bl_id FROM bl 
        					WHERE ${parameters['locationField']} = ${parameters['locationValue']})
        </sql>
        
        <table name="bill_archive" role="main"/>
        <field name="bill_type_id" groupBy="true"/>
        <!--field name="time_period" /-->
        <field name="total_amount_expense" formula="sum" baseField="bill_archive.amount_expense" dataType="number" size="12" decimals="2"/>
        <sortField table="bill_archive" name="bill_type_id" ascending="true"/>
    </dataSource>
    
    <dataSource id="ds_totalCostTypeData" applyVpaRestrictions="false">
        <!-- Define parameters for the custom SQL query -->
        <parameter name="locationField" dataType="verbatim" value="ctry_id"/>
        <parameter name="locationValue" dataType="text" value="USA"/>
        <parameter name="unitsConversionFactor" dataType="verbatim" value=""/>
            
        <!-- Define a custom SQL query that can be restricted by various location values -->
        <sql dialect="generic">SELECT
                    bl.use1,
                    bill_archive.site_id,
                    bill_archive.bl_id,
                    bill_archive.vn_id,
                    bill_archive.bill_id,
                    bill_archive.vn_ac_id,
                    bill_archive.bill_type_id,
                    bill_archive.time_period,
                    bill_archive.date_service_start,
                    bill_archive.date_service_end,
                    bill_archive.amount_expense,
                    bill_archive.amount_income,
                    (bill_archive.qty_energy / ${parameters['unitsConversionFactor']}) ${sql.as} qty_energy,
                    bill_archive.qty_power,
                    bill_archive.qty_volume,
                    bill_archive.qty_kwh,
                    bill_archive.cost_kwh,
                    bill_archive.cost_mmbtu,
                    bill_archive.count_lines,
                    bill_archive.description,
                    bill_archive.doc
        			FROM bill_archive 
        				LEFT OUTER JOIN bl 
        				ON bill_archive.bl_id=bl.bl_id
				WHERE bill_archive.vn_id IN 
        				(SELECT vn_id FROM vn 
        					WHERE vendor_type = 'Energ')
        			AND ${sql.vpaRestriction} AND bill_archive.bl_id IN 
        				(SELECT bl_id FROM bl 
        					WHERE ${parameters['locationField']} = ${parameters['locationValue']})        				
        </sql>    
    
        <table name="bill_archive" role="main" />
        <field table="bill_archive" name="site_id"/>
        <field table="bill_archive" name="bl_id"/>
		<field table="bill_archive" name="use1" dataType="text"/>
        <field table="bill_archive" name="vn_id"/>
        <field table="bill_archive" name="bill_id"/>
        <field table="bill_archive" name="vn_ac_id"/>
        <field table="bill_archive" name="bill_type_id"/>        
		<field table="bill_archive" name="time_period"/>
        <field table="bill_archive" name="date_service_start"/>
        <field table="bill_archive" name="date_service_end"/>	
		<field table="bill_archive" name="amount_expense" showTotals="true"/>
		<field table="bill_archive" name="amount_income" showTotals="true"/>
		<field table="bill_archive" name="qty_energy" showTotals="true"/>
		<field table="bill_archive" name="qty_power" showTotals="true"/>
		<field table="bill_archive" name="qty_volume" showTotals="true"/>
		<field table="bill_archive" name="qty_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_mmbtu" showTotals="true"/>
        <field table="bill_archive" name="count_lines"/>
        <field table="bill_archive" name="description"/>
        <field table="bill_archive" name="doc"/>
    </dataSource>
    
    <panel type="grid" id="panel_totalCostTypeData" dataSource="ds_totalCostTypeData" hidden="true" showOnLoad="false" showCounts="true">
    	<title translatable="true">Archived Bills</title>
    	
	    <action id="exportXLS">
	      <title translatable="true">XLS</title>
	      <command type="exportPanel" outputType="xls" panelId="panel_totalCostTypeData"/>
	    </action>
		
	    <action id="exportDOC">
	      <title translatable="true">DOC</title>
	      <command type="exportPanel" outputType="docx" panelId="panel_totalCostTypeData"/>
	    </action>		
	    
          <field controlType="button" id="viewCostTypeData" enabled="${record['bill_archive.doc'] != ''}">
         	 <title translatable="true">Document</title>
          </field>
        <field controlType="button">
            <command type="openDialog" viewName="ab-energy-archive-bill-line-list.axvw" applySelectionRestriction="true"/>
            <title translatable="true">Lines</title>
        </field>

        <field table="bill_archive" name="site_id"/>
        <field table="bill_archive" name="bl_id"/>
		<field table="bill_archive" name="use1" dataType="text">
			<title translatable="true">Building Use</title>
		</field>
        <field table="bill_archive" name="vn_id"/>
        <field table="bill_archive" name="bill_id"/>
        <field table="bill_archive" name="vn_ac_id"/>
        <field table="bill_archive" name="bill_type_id"/>        
		<field table="bill_archive" name="time_period"/>
        <field table="bill_archive" name="date_service_start"/>
        <field table="bill_archive" name="date_service_end"/>	
		<field table="bill_archive" name="amount_expense" showTotals="true"/>
		<field table="bill_archive" name="amount_income" showTotals="true"/>
		<field table="bill_archive" name="qty_energy" showTotals="true">
            <title>Energy / Consumption (${view.dataSources.get('abEnergyBillCommon_ds').getRecord().getValue('bill_unit.vf_qty_energy_unit')})</title>
        </field>
		<field table="bill_archive" name="qty_power" showTotals="true"/>
		<field table="bill_archive" name="qty_volume" showTotals="true"/>
		<field table="bill_archive" name="qty_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_mmbtu" showTotals="true"/>
        <field table="bill_archive" name="count_lines"/>
        <field table="bill_archive" name="description"/>
        <field table="bill_archive" name="doc"/>
		
    	<sortField table="bill_archive" name="vn_id" ascending="true"/>
    	<sortField table="bill_archive" name="bill_id" ascending="true"/>
    	<indexField table="bill_archive" name="bill_id"/>
    </panel>
    
    <dataSource id="ds_totalCostConsumpChart" type="grouping" applyVpaRestrictions="false">
        <!-- Define parameters for the custom SQL query -->
        <parameter name="locationField" dataType="verbatim" value="ctry_id"/>
        <parameter name="locationValue" dataType="text" value="USA"/>
        <parameter name="unitsConversionFactor" dataType="verbatim" value=""/>
        
        <!-- Define a custom SQL query that can be restricted by various location values -->
        <sql dialect="generic">SELECT
                        amount_expense,
                        (bill_archive.qty_energy / ${parameters['unitsConversionFactor']}) ${sql.as} qty_energy,
                        time_period 
        			FROM bill_archive 
        			WHERE qty_energy > 0
        			AND bill_archive.vn_id IN 
        				(SELECT vn_id FROM vn 
        					WHERE vendor_type = 'Energ')
        			AND ${sql.vpaRestriction} AND bill_archive.bl_id IN 
        				(SELECT bl_id FROM bl 
        					WHERE ${parameters['locationField']} = ${parameters['locationValue']})
        </sql>
        
        <table name="bill_archive"/>
        <field name="time_period" groupBy="true"/>
        <field name="total_amount_expense" formula="sum" baseField="bill_archive.amount_expense" dataType="number" size="12" decimals="2"/>
        <field name="total_qty_energy" formula="sum" baseField="bill_archive.qty_energy" dataType="number" size="16" decimals="6"/>
        <sortField name="time_period" ascending="true"/>
    </dataSource>

    <dataSource id="ds_totalCostConsumpData" applyVpaRestrictions="false">
        <!-- Define parameters for the custom SQL query -->
        <parameter name="locationField" dataType="verbatim" value="ctry_id"/>
        <parameter name="locationValue" dataType="text" value="USA"/>
        <parameter name="unitsConversionFactor" dataType="verbatim" value=""/>
            
        <!-- Define a custom SQL query that can be restricted by various location values -->
        <sql dialect="generic">SELECT
                    bl.use1,
                    bill_archive.site_id,
                    bill_archive.bl_id,
                    bill_archive.vn_id,
                    bill_archive.bill_id,
                    bill_archive.vn_ac_id,
                    bill_archive.bill_type_id,
                    bill_archive.time_period,
                    bill_archive.date_service_start,
                    bill_archive.date_service_end,
                    bill_archive.amount_expense,
                    bill_archive.amount_income,
                    (bill_archive.qty_energy / ${parameters['unitsConversionFactor']}) ${sql.as} qty_energy,
                    bill_archive.qty_power,
                    bill_archive.qty_volume,
                    bill_archive.qty_kwh,
                    bill_archive.cost_kwh,
                    bill_archive.cost_mmbtu,
                    bill_archive.count_lines,
                    bill_archive.description,
                    bill_archive.doc
        			FROM bill_archive 
        				LEFT OUTER JOIN bl 
        				ON bill_archive.bl_id=bl.bl_id
				WHERE qty_energy > 0
        			AND bill_archive.vn_id IN 
        				(SELECT vn_id FROM vn 
        					WHERE vendor_type = 'Energ')
        			AND ${sql.vpaRestriction} AND bill_archive.bl_id IN 
        				(SELECT bl_id FROM bl 
        					WHERE ${parameters['locationField']} = ${parameters['locationValue']})        				
        </sql>    
    
        <table name="bill_archive" role="main" />
        <field table="bill_archive" name="site_id"/>
        <field table="bill_archive" name="bl_id"/>
		<field table="bill_archive" name="use1" dataType="text"/>
        <field table="bill_archive" name="vn_id"/>
        <field table="bill_archive" name="bill_id"/>
        <field table="bill_archive" name="vn_ac_id"/>
        <field table="bill_archive" name="bill_type_id"/>        
		<field table="bill_archive" name="time_period"/>
        <field table="bill_archive" name="date_service_start"/>
        <field table="bill_archive" name="date_service_end"/>	
		<field table="bill_archive" name="amount_expense" showTotals="true"/>
		<field table="bill_archive" name="amount_income" showTotals="true"/>
		<field table="bill_archive" name="qty_energy" showTotals="true"/>
		<field table="bill_archive" name="qty_power" showTotals="true"/>
		<field table="bill_archive" name="qty_volume" showTotals="true"/>
		<field table="bill_archive" name="qty_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_mmbtu" showTotals="true"/>
        <field table="bill_archive" name="count_lines"/>
        <field table="bill_archive" name="description"/>
        <field table="bill_archive" name="doc"/>
    </dataSource>
    
    <panel type="grid" id="panel_totalCostConsumpData" dataSource="ds_totalCostConsumpData" hidden="true" showOnLoad="false" showCounts="true">
    	<title translatable="true">Archived Bills</title>
    	
	    <action id="exportXLS">
	      <title translatable="true">XLS</title>
	      <command type="exportPanel" outputType="xls" panelId="panel_totalCostConsumpData"/>
	    </action>

	    <action id="exportDOC">
	      <title translatable="true">DOC</title>
	      <command type="exportPanel" outputType="docx" panelId="panel_totalCostConsumpData"/>
	    </action>
	    
          <field controlType="button" id="viewCostConsumpData" enabled="${record['bill_archive.doc'] != ''}">
         	 <title translatable="true">Document</title>
          </field>
        <field controlType="button">
            <command type="openDialog" viewName="ab-energy-archive-bill-line-list.axvw" applySelectionRestriction="true"/>
            <title translatable="true">Lines</title>
        </field>
        
		<field table="bill_archive" name="site_id"/>
		<field table="bill_archive" name="bl_id"/>
		<field table="bill_archive" name="use1" dataType="text">
			<title translatable="true">Building Use</title>
		</field>
		<field table="bill_archive" name="vn_id"/>
		<field table="bill_archive" name="bill_id"/>
		<field table="bill_archive" name="vn_ac_id"/>
		<field table="bill_archive" name="bill_type_id"/>
		<field table="bill_archive" name="time_period"/>
		<field table="bill_archive" name="date_service_start"/>
		<field table="bill_archive" name="date_service_end"/>
		<field table="bill_archive" name="amount_expense" showTotals="true"/>
		<field table="bill_archive" name="amount_income" showTotals="true"/>
		<field table="bill_archive" name="qty_energy" showTotals="true">
            <title>Energy / Consumption (${view.dataSources.get('abEnergyBillCommon_ds').getRecord().getValue('bill_unit.vf_qty_energy_unit')})</title>
        </field>
		<field table="bill_archive" name="qty_power" showTotals="true"/>
		<field table="bill_archive" name="qty_volume" showTotals="true"/>
		<field table="bill_archive" name="qty_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_mmbtu" showTotals="true"/>
		<field table="bill_archive" name="count_lines"/>
		<field table="bill_archive" name="description"/>
		<field table="bill_archive" name="doc"/>
		
    	<sortField table="bill_archive" name="vn_id" ascending="true"/>
    	<sortField table="bill_archive" name="bill_id" ascending="true"/>
    	<indexField table="bill_archive" name="bill_id"/>
    </panel> 

    <dataSource id="ds_elecCostRateChart" type="grouping" applyVpaRestrictions="false">
        <!-- Define parameters for the custom SQL query -->
        <parameter name="locationField" dataType="verbatim" value="ctry_id"/>
        <parameter name="locationValue" dataType="text" value="USA"/>
        
        <!-- Define a custom SQL query that can be restricted by various location values -->
        <sql dialect="generic">SELECT amount_expense, cost_kwh, time_period 
        			FROM bill_archive 
        			WHERE bill_archive.bill_type_id='ELECTRIC'
        			AND bill_archive.vn_id IN 
        				(SELECT vn_id FROM vn 
        					WHERE vendor_type = 'Energ') 
        			AND ${sql.vpaRestriction} AND bill_archive.bl_id IN 
        				(SELECT bl_id FROM bl 
        					WHERE ${parameters['locationField']} = ${parameters['locationValue']})
        </sql>
        
        <table name="bill_archive"/>
        <field name="time_period" groupBy="true"/>
        <field name="total_amount_expense" formula="sum" baseField="bill_archive.amount_expense" dataType="number" size="12" decimals="2"/>
        <field name="total_cost_kwh" formula="sum" baseField="bill_archive.cost_kwh" dataType="number" size="12" decimals="4"/>
        <sortField name="time_period" ascending="true"/>
    </dataSource>

    <dataSource id="ds_elecCostRateData" applyVpaRestrictions="false">
        <!-- Define parameters for the custom SQL query -->
        <parameter name="locationField" dataType="verbatim" value="ctry_id"/>
        <parameter name="locationValue" dataType="text" value="USA"/>
        <parameter name="unitsConversionFactor" dataType="verbatim" value=""/>
            
        <!-- Define a custom SQL query that can be restricted by various location values -->
        <sql dialect="generic">SELECT bl.use1,
                    bill_archive.site_id,
                    bill_archive.bl_id,
                    bill_archive.vn_id,
                    bill_archive.bill_id,
                    bill_archive.vn_ac_id,
                    bill_archive.bill_type_id,
                    bill_archive.time_period,
                    bill_archive.date_service_start,
                    bill_archive.date_service_end,
                    bill_archive.amount_expense,
                    bill_archive.amount_income,
                    (bill_archive.qty_energy / ${parameters['unitsConversionFactor']}) ${sql.as} qty_energy,
                    bill_archive.qty_power,
                    bill_archive.qty_volume,
                    bill_archive.qty_kwh,
                    bill_archive.cost_kwh,
                    bill_archive.cost_mmbtu,
                    bill_archive.count_lines,
                    bill_archive.description,
                    bill_archive.doc
        			FROM bill_archive 
        				LEFT OUTER JOIN bl 
        				ON bill_archive.bl_id=bl.bl_id
				WHERE bill_archive.bill_type_id='ELECTRIC'
        			AND bill_archive.vn_id IN 
        				(SELECT vn_id FROM vn 
        					WHERE vendor_type = 'Energ')
        			AND ${sql.vpaRestriction} AND bill_archive.bl_id IN 
        				(SELECT bl_id FROM bl 
        					WHERE ${parameters['locationField']} = ${parameters['locationValue']})        				
        </sql>    
    
        <table name="bill_archive" role="main" />
        <field table="bill_archive" name="site_id"/>
        <field table="bill_archive" name="bl_id"/>
		<field table="bill_archive" name="use1" dataType="text"/>		
        <field table="bill_archive" name="vn_id"/>
        <field table="bill_archive" name="bill_id"/>
        <field table="bill_archive" name="vn_ac_id"/>
        <field table="bill_archive" name="bill_type_id"/>        
		<field table="bill_archive" name="time_period"/>
        <field table="bill_archive" name="date_service_start"/>
        <field table="bill_archive" name="date_service_end"/>	
		<field table="bill_archive" name="amount_expense" showTotals="true"/>
		<field table="bill_archive" name="amount_income" showTotals="true"/>
		<field table="bill_archive" name="qty_energy" showTotals="true"/>
		<field table="bill_archive" name="qty_power" showTotals="true"/>
		<field table="bill_archive" name="qty_volume" showTotals="true"/>
		<field table="bill_archive" name="qty_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_mmbtu" showTotals="true"/>
        <field table="bill_archive" name="count_lines"/>
        <field table="bill_archive" name="description"/>
        <field table="bill_archive" name="doc"/>
    </dataSource>
    
    <panel type="grid" id="panel_elecCostRateData" dataSource="ds_elecCostRateData" hidden="true" showOnLoad="false" showCounts="true">
    	<title translatable="true">Archived Bills</title>
    	
	    <action id="exportXLS">
	      <title translatable="true">XLS</title>
	      <command type="exportPanel" outputType="xls" panelId="panel_elecCostRateData"/>
	    </action>
	    
	    <action id="exportDOC">
	      <title translatable="true">DOC</title>
	      <command type="exportPanel" outputType="docx" panelId="panel_elecCostRateData"/>
	    </action>
		
          <field controlType="button" id="viewElecRateData" enabled="${record['bill_archive.doc'] != ''}">
         	 <title translatable="true">Document</title>
          </field>
        <field controlType="button">
            <command type="openDialog" viewName="ab-energy-archive-bill-line-list.axvw" applySelectionRestriction="true"/>
            <title translatable="true">Lines</title>
        </field>
		<field table="bill_archive" name="site_id"/>
		<field table="bill_archive" name="bl_id"/>
		<field table="bill_archive" name="use1" dataType="text">
			<title translatable="true">Building Use</title>
		</field>
		<field table="bill_archive" name="vn_id"/>
		<field table="bill_archive" name="bill_id"/>
		<field table="bill_archive" name="vn_ac_id"/>
		<field table="bill_archive" name="bill_type_id"/>
		<field table="bill_archive" name="time_period"/>
		<field table="bill_archive" name="date_service_start"/>
		<field table="bill_archive" name="date_service_end"/>
		<field table="bill_archive" name="amount_expense" showTotals="true"/>
		<field table="bill_archive" name="amount_income" showTotals="true"/>
		<field table="bill_archive" name="qty_energy" showTotals="true">
            <title>Energy / Consumption (${view.dataSources.get('abEnergyBillCommon_ds').getRecord().getValue('bill_unit.vf_qty_energy_unit')})</title>
        </field>
		<field table="bill_archive" name="qty_power" showTotals="true"/>
		<field table="bill_archive" name="qty_volume" showTotals="true"/>
		<field table="bill_archive" name="qty_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_mmbtu" showTotals="true"/>
		<field table="bill_archive" name="count_lines"/>
		<field table="bill_archive" name="description"/>
		<field table="bill_archive" name="doc"/>
		
    	<sortField table="bill_archive" name="vn_id" ascending="true"/>
    	<sortField table="bill_archive" name="bill_id" ascending="true"/>
    	<indexField table="bill_archive" name="bill_id"/>
    </panel> 

    <dataSource id="ds_gasCostRateChart" type="grouping" applyVpaRestrictions="false">    
        <!-- Define parameters for the custom SQL query -->
        <parameter name="locationField" dataType="verbatim" value="ctry_id"/>
        <parameter name="locationValue" dataType="text" value="USA"/>
        <parameter name="unitsConversionFactorForCost" dataType="verbatim" value=""/>
        
        <!-- Define a custom SQL query that can be restricted by various location values -->
        <sql dialect="generic">SELECT amount_expense,
                        (cost_mmbtu * ${parameters['unitsConversionFactorForCost']}) ${sql.as} cost_mmbtu,
                        time_period 
        			FROM bill_archive 
        			WHERE bill_archive.vn_id IN 
        				(SELECT vn_id FROM vn 
        					WHERE vendor_type = 'Energ')
        			AND bill_archive.bill_type_id like 'GAS%' 
        			AND ${sql.vpaRestriction} AND bill_archive.bl_id IN 
        				(SELECT bl_id FROM bl 
        					WHERE ${parameters['locationField']} = ${parameters['locationValue']})
        </sql>
        
        <table name="bill_archive"/>
        <field name="time_period" groupBy="true"/>
        <field name="total_amount_expense" formula="sum" baseField="bill_archive.amount_expense" dataType="number" size="12" decimals="2"/>
        <field name="total_cost_mmbtu" formula="sum" baseField="bill_archive.cost_mmbtu" dataType="number" size="12" decimals="4"/>
        <sortField name="time_period" ascending="true"/>
    </dataSource>

    <dataSource id="ds_gasCostRateData" applyVpaRestrictions="false">
        <!-- Define parameters for the custom SQL query -->
        <parameter name="locationField" dataType="verbatim" value="ctry_id"/>
        <parameter name="locationValue" dataType="text" value="USA"/>
        <parameter name="unitsConversionFactor" dataType="verbatim" value=""/>
            
        <!-- Define a custom SQL query that can be restricted by various location values -->
        <sql dialect="generic">SELECT
                    bl.use1,
                    bill_archive.site_id,
                    bill_archive.bl_id,
                    bill_archive.vn_id,
                    bill_archive.bill_id,
                    bill_archive.vn_ac_id,
                    bill_archive.bill_type_id,
                    bill_archive.time_period,
                    bill_archive.date_service_start,
                    bill_archive.date_service_end,
                    bill_archive.amount_expense,
                    bill_archive.amount_income,
                    (bill_archive.qty_energy / ${parameters['unitsConversionFactor']}) ${sql.as} qty_energy,
                    bill_archive.qty_power,
                    bill_archive.qty_volume,
                    bill_archive.qty_kwh,
                    bill_archive.cost_kwh,
                    bill_archive.cost_mmbtu,
                    bill_archive.count_lines,
                    bill_archive.description,
                    bill_archive.doc
        			FROM bill_archive 
        				LEFT OUTER JOIN bl 
        				ON bill_archive.bl_id=bl.bl_id
				WHERE bill_archive.bill_type_id like 'GAS%'
        			AND bill_archive.vn_id IN 
        				(SELECT vn_id FROM vn 
        					WHERE vendor_type = 'Energ')
        			AND ${sql.vpaRestriction} AND bill_archive.bl_id IN 
        				(SELECT bl_id FROM bl 
        					WHERE ${parameters['locationField']} = ${parameters['locationValue']})        				
        </sql>    
    
        <table name="bill_archive" role="main" />
        <field table="bill_archive" name="site_id"/>
        <field table="bill_archive" name="bl_id"/>
		<field table="bill_archive" name="use1" dataType="text"/>		
        <field table="bill_archive" name="vn_id"/>
        <field table="bill_archive" name="bill_id"/>
        <field table="bill_archive" name="vn_ac_id"/>
        <field table="bill_archive" name="bill_type_id"/>        
		<field table="bill_archive" name="time_period"/>
        <field table="bill_archive" name="date_service_start"/>
        <field table="bill_archive" name="date_service_end"/>	
		<field table="bill_archive" name="amount_expense" showTotals="true"/>
		<field table="bill_archive" name="amount_income" showTotals="true"/>
		<field table="bill_archive" name="qty_energy" showTotals="true"/>
		<field table="bill_archive" name="qty_power" showTotals="true"/>
		<field table="bill_archive" name="qty_volume" showTotals="true"/>
		<field table="bill_archive" name="qty_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_mmbtu" showTotals="true"/>
        <field table="bill_archive" name="count_lines"/>
        <field table="bill_archive" name="description"/>
        <field table="bill_archive" name="doc"/>
    </dataSource>
    
    <panel type="grid" id="panel_gasCostRateData" dataSource="ds_gasCostRateData" hidden="true" showOnLoad="false" showCounts="true">
    	<title translatable="true">Archived Bills</title>
    	
	    <action id="exportXLS">
	      <title translatable="true">XLS</title>
	      <command type="exportPanel" outputType="xls" panelId="panel_gasCostRateData"/>
	    </action>
	    
	    <action id="exportDOC">
	      <title translatable="true">DOC</title>
	      <command type="exportPanel" outputType="docx" panelId="panel_gasCostRateData"/>
	    </action>
		
          <field controlType="button" id="viewGasRateData" enabled="${record['bill_archive.doc'] != ''}">
         	 <title translatable="true">Document</title>
          </field>
        <field controlType="button">
            <command type="openDialog" viewName="ab-energy-archive-bill-line-list.axvw" applySelectionRestriction="true"/>
            <title translatable="true">Lines</title>
        </field>
		<field table="bill_archive" name="site_id"/>
		<field table="bill_archive" name="bl_id"/>
		<field table="bill_archive" name="use1" dataType="text">
			<title translatable="true">Building Use</title>
		</field>
		<field table="bill_archive" name="vn_id"/>
		<field table="bill_archive" name="bill_id"/>
		<field table="bill_archive" name="vn_ac_id"/>
		<field table="bill_archive" name="bill_type_id"/>
		<field table="bill_archive" name="time_period"/>
		<field table="bill_archive" name="date_service_start"/>
		<field table="bill_archive" name="date_service_end"/>
		<field table="bill_archive" name="amount_expense" showTotals="true"/>
		<field table="bill_archive" name="amount_income" showTotals="true"/>
		<field table="bill_archive" name="qty_energy" showTotals="true">
            <title>Energy / Consumption (${view.dataSources.get('abEnergyBillCommon_ds').getRecord().getValue('bill_unit.vf_qty_energy_unit')})</title>
        </field>
		<field table="bill_archive" name="qty_power" showTotals="true"/>
		<field table="bill_archive" name="qty_volume" showTotals="true"/>
		<field table="bill_archive" name="qty_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_mmbtu" showTotals="true"/>
		<field table="bill_archive" name="count_lines"/>
		<field table="bill_archive" name="description"/>
		<field table="bill_archive" name="doc"/>
		
    	<sortField table="bill_archive" name="vn_id" ascending="true"/>
    	<sortField table="bill_archive" name="bill_id" ascending="true"/>
    	<indexField table="bill_archive" name="bill_id"/>
    </panel>
    
    <dataSource id="ds_elecLoadFactorChart" type="grouping" applyVpaRestrictions="false">
    	<!-- Define parameters for the custom SQL query -->
    	<parameter name="locationField" dataType="verbatim" value="ctry_id"/>
        <parameter name="locationValue" dataType="text" value="USA"/>
            
        <!-- Define a custom SQL query that can be restricted by various location values -->    
        <sql dialect="generic">SELECT bill_archive.time_period,				
				bill_archive.qty_energy / 0.003412 / ${sql.replaceZero('bill_archive.qty_power')} / ${sql.replaceZero('energy_bl_svc_period.num_days')} / 24 * 100 ${sql.as} el_load_factor
				FROM bill_archive INNER JOIN
					energy_bl_svc_period ON bill_archive.time_period = energy_bl_svc_period.time_period AND bill_archive.bl_id = energy_bl_svc_period.bl_id
				WHERE bill_archive.bill_type_id = 'ELECTRIC' AND energy_bl_svc_period.bill_type_id = 'ELECTRIC'
				AND bill_archive.vn_id IN
					(SELECT vn_id FROM vn 
						WHERE vendor_type = 'Energ')
        			AND ${sql.vpaRestriction} AND bill_archive.bl_id IN 
            				(SELECT bl_id FROM bl 
            					WHERE ${parameters['locationField']} = ${parameters['locationValue']})     					
       	</sql>        
        
        <table name="bill_archive" role="main"/>
        <field name="time_period" table="bill_archive" groupBy="true"/>
        <field name="sum_el_load_factor" formula="avg" baseField="bill_archive.el_load_factor" dataType="number" numericFormat="Default" size="12" decimals="2"/>
        <sortField table="bill_archive" name="time_period" ascending="true"/>
    </dataSource>   
    
    <dataSource id="ds_elecLoadFactorData" applyVpaRestrictions="false">
        <!-- Define parameters for the custom SQL query -->
        <parameter name="locationField" dataType="verbatim" value="ctry_id"/>
        <parameter name="locationValue" dataType="text" value="USA"/>
        <parameter name="unitsConversionFactor" dataType="verbatim" value=""/>
            
        <!-- Define a custom SQL query that can be restricted by various location values -->
        <sql dialect="generic">SELECT
                        bl.use1,
                        bill_archive.site_id,
                        bill_archive.bl_id,
                        bill_archive.vn_id,
                        bill_archive.bill_id,
                        bill_archive.vn_ac_id,
                        bill_archive.bill_type_id,
                        bill_archive.time_period,
                        bill_archive.date_service_start,
                        bill_archive.date_service_end,
                        bill_archive.amount_expense,
                        bill_archive.amount_income,
                        (bill_archive.qty_energy / ${parameters['unitsConversionFactor']}) ${sql.as} qty_energy,
                        bill_archive.qty_power,
                        bill_archive.qty_volume,
                        bill_archive.qty_kwh,
                        bill_archive.cost_kwh,
                        bill_archive.cost_mmbtu,
                        bill_archive.count_lines,
                        bill_archive.description,
                        bill_archive.doc
        			FROM bill_archive 
        				LEFT OUTER JOIN bl 
        				ON bill_archive.bl_id=bl.bl_id
				WHERE bill_archive.bill_type_id = 'ELECTRIC'
				AND bill_archive.vn_id IN
					(SELECT vn_id FROM vn 
						WHERE vendor_type = 'Energ')
        			AND ${sql.vpaRestriction} AND bill_archive.bl_id IN 
            				(SELECT bl_id FROM bl 
            					WHERE ${parameters['locationField']} = ${parameters['locationValue']})        				
        </sql>    
    
        <table name="bill_archive" role="main" />
        <field table="bill_archive" name="site_id"/>
        <field table="bill_archive" name="bl_id"/>
		<field table="bill_archive" name="use1" dataType="text"/>		
        <field table="bill_archive" name="vn_id"/>
        <field table="bill_archive" name="bill_id"/>
        <field table="bill_archive" name="vn_ac_id"/>
        <field table="bill_archive" name="bill_type_id"/>        
		<field table="bill_archive" name="time_period"/>
        <field table="bill_archive" name="date_service_start"/>
        <field table="bill_archive" name="date_service_end"/>	
		<field table="bill_archive" name="amount_expense" showTotals="true"/>
		<field table="bill_archive" name="amount_income" showTotals="true"/>
		<field table="bill_archive" name="qty_energy" showTotals="true"/>
		<field table="bill_archive" name="qty_power" showTotals="true"/>
		<field table="bill_archive" name="qty_volume" showTotals="true"/>
		<field table="bill_archive" name="qty_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_mmbtu" showTotals="true"/>
        <field table="bill_archive" name="count_lines"/>
        <field table="bill_archive" name="description"/>
        <field table="bill_archive" name="doc"/>
    </dataSource>
    
    <panel type="grid" id="panel_elecLoadFactorData" dataSource="ds_elecLoadFactorData" hidden="true" showOnLoad="false" showCounts="true">
    	<title translatable="true">Archived Bills</title>
    	
	    <action id="exportXLS">
	      <title translatable="true">XLS</title>
	      <command type="exportPanel" outputType="xls" panelId="panel_elecLoadFactorData"/>
	    </action>
	    
	    <action id="exportDOC">
	      <title translatable="true">DOC</title>
	      <command type="exportPanel" outputType="docx" panelId="panel_elecLoadFactorData"/>
	    </action>
		
          <field controlType="button" id="viewElecLoadFactor" enabled="${record['bill_archive.doc'] != ''}">
         	 <title translatable="true">Document</title>
          </field>
        <field controlType="button">
            <command type="openDialog" viewName="ab-energy-archive-bill-line-list.axvw" applySelectionRestriction="true"/>
            <title translatable="true">Lines</title>
        </field>
		<field table="bill_archive" name="site_id"/>
		<field table="bill_archive" name="bl_id"/>
		<field table="bill_archive" name="use1" dataType="text">
			<title translatable="true">Building Use</title>
		</field>
		<field table="bill_archive" name="vn_id"/>
		<field table="bill_archive" name="bill_id"/>
		<field table="bill_archive" name="vn_ac_id"/>
		<field table="bill_archive" name="bill_type_id"/>
		<field table="bill_archive" name="time_period"/>
		<field table="bill_archive" name="date_service_start"/>
		<field table="bill_archive" name="date_service_end"/>
		<field table="bill_archive" name="amount_expense" showTotals="true"/>
		<field table="bill_archive" name="amount_income" showTotals="true"/>
		<field table="bill_archive" name="qty_energy" showTotals="true">
            <title>Energy / Consumption (${view.dataSources.get('abEnergyBillCommon_ds').getRecord().getValue('bill_unit.vf_qty_energy_unit')})</title>
        </field>
		<field table="bill_archive" name="qty_power" showTotals="true"/>
		<field table="bill_archive" name="qty_volume" showTotals="true"/>
		<field table="bill_archive" name="qty_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_kwh" showTotals="true"/>
		<field table="bill_archive" name="cost_mmbtu" showTotals="true"/>
		<field table="bill_archive" name="count_lines"/>
		<field table="bill_archive" name="description"/>
		<field table="bill_archive" name="doc"/>
		
    	<sortField table="bill_archive" name="vn_id" ascending="true"/>
    	<sortField table="bill_archive" name="bill_id" ascending="true"/>
    	<indexField table="bill_archive" name="bill_id"/>
    </panel>
    
    <dataSource id="ds_elecWeatherModelChart" type="grouping" applyVpaRestrictions="false">
    	<!-- Define parameters for the custom SQL query -->
    	<parameter name="locationField" dataType="verbatim" value="ctry_id"/>
        <parameter name="locationValue" dataType="text" value="USA"/>
        <parameter name="unitsConversionFactor" dataType="verbatim" value=""/>
            
        <!-- Define a custom SQL query that can be restricted by various location values -->
        <!-- EJM: Bali5 / v23.1 - Added restrictions so the weather model values do not include redundant days totals for bills in a month with no consumption value (e.g., T&D invoices).
                If there are multiple bills of the same utility type for the same building for a given time period and having energy consumption values, then the energy model
                bars in the chart may not always appear as expected.  It is likely, assuming all bills are of overlapping service dates of approximately 1 month, that the weather model value will
                be roughly multiplied by the number of included bills with consumption values.  I see no clear programmatic way around this, as various approaches risk misrepresenting
                the true data.  At least with this case of potentially huge chart values, it should be obvious that something in the underlying source data is not compatible with the 
                presentation.  An alternative approach, should users wish to reconfigure with the understanding that values might be off by one or several days' worth of base load, would
                be, e.g., in the case of baseload, to select the max value for a given building within a time period before multiplying and summing.
                This is the new restriction clause:
                AND energy_chart_point.vn_id ${sql.concat} energy_chart_point.vn_ac_id 
                  IN (SELECT vn_id + vn_ac_id FROM energy_bl_svc_period ebsp WHERE ebsp.vn_id = energy_chart_point.vn_id 
                  AND ebsp.vn_ac_id = energy_chart_point.vn_ac_id AND ebsp.time_period = energy_chart_point.time_period)
                I have also changed the SUM() operator to MAX() for weather model values, because the chart should only show one per month.  On the other hand, I've added SUM() to the 
                utility consumption value, because we do want to show the total consumed for any given month. 
                -->
        <sql dialect="generic">SELECT energy_chart_point.time_period, MAX(energy_chart_point.value * weather_model.coefficient_base_load) ${sql.as} baseload, 0.00 ${sql.as} cdd, 0.00 ${sql.as} hdd, 
				0.00 ${sql.as} el_actual_consumption, 0.00 ${sql.as} el_actual_demand
				FROM energy_chart_point
					INNER JOIN weather_model
					ON (energy_chart_point.bl_id = weather_model.bl_id AND energy_chart_point.time_period = weather_model.time_period)
				WHERE ${sql.vpaRestriction} AND energy_chart_point.value_name = 'el_num_days' AND weather_model.model_type = 'el_regression' AND energy_chart_point.bl_id IN 
									(SELECT bl_id FROM bl 
										WHERE ${parameters['locationField']} = ${parameters['locationValue']})
                  AND energy_chart_point.vn_id ${sql.concat} energy_chart_point.vn_ac_id 
                  IN (SELECT vn_id ${sql.concat} vn_ac_id FROM energy_bl_svc_period ebsp WHERE ebsp.vn_id = energy_chart_point.vn_id 
                  AND ebsp.vn_ac_id = energy_chart_point.vn_ac_id AND ebsp.time_period = energy_chart_point.time_period)
				GROUP BY energy_chart_point.time_period
				UNION ALL
				SELECT energy_chart_point.time_period, 0.00 ${sql.as} baseload, MAX(energy_chart_point.value * weather_model.coefficient_cdd) ${sql.as} cdd, 0.00 ${sql.as} hdd, 
				0.00 ${sql.as} el_actual_consumption, 0.00 ${sql.as} el_actual_demand
				FROM energy_chart_point
					INNER JOIN weather_model
					ON (energy_chart_point.bl_id = weather_model.bl_id AND energy_chart_point.time_period = weather_model.time_period)
				WHERE ${sql.vpaRestriction} AND energy_chart_point.value_name = 'cdd' AND weather_model.model_type = 'el_regression' AND energy_chart_point.bl_id IN 
									(SELECT bl_id FROM bl 
										WHERE ${parameters['locationField']} = ${parameters['locationValue']})
                  AND energy_chart_point.vn_id ${sql.concat} energy_chart_point.vn_ac_id 
                  IN (SELECT vn_id ${sql.concat} vn_ac_id FROM energy_bl_svc_period ebsp WHERE ebsp.vn_id = energy_chart_point.vn_id 
                  AND ebsp.vn_ac_id = energy_chart_point.vn_ac_id AND ebsp.time_period = energy_chart_point.time_period)
				GROUP BY energy_chart_point.time_period
				UNION ALL
				SELECT energy_chart_point.time_period, 0.00 ${sql.as} baseload, 0.00 ${sql.as} cdd, MAX(energy_chart_point.value * weather_model.coefficient_hdd) ${sql.as} hdd, 
				0.00 ${sql.as} el_actual_consumption, 0.00 ${sql.as} el_actual_demand
				FROM energy_chart_point
					INNER JOIN weather_model
					ON (energy_chart_point.bl_id = weather_model.bl_id AND energy_chart_point.time_period = weather_model.time_period)
				WHERE ${sql.vpaRestriction} AND energy_chart_point.value_name = 'hdd' AND weather_model.model_type = 'el_regression' AND energy_chart_point.bl_id IN 
									(SELECT bl_id FROM bl 
										WHERE ${parameters['locationField']} = ${parameters['locationValue']})
				  AND energy_chart_point.vn_id ${sql.concat} energy_chart_point.vn_ac_id 
                  IN (SELECT vn_id ${sql.concat} vn_ac_id FROM energy_bl_svc_period ebsp WHERE ebsp.vn_id = energy_chart_point.vn_id 
                  AND ebsp.vn_ac_id = energy_chart_point.vn_ac_id AND ebsp.time_period = energy_chart_point.time_period)
                GROUP BY energy_chart_point.time_period
				UNION ALL
				SELECT energy_chart_point.time_period, 0.00 ${sql.as} baseload, 0.00 ${sql.as} cdd, 0.00 ${sql.as} hdd,
				SUM(energy_chart_point.value) ${sql.as} el_actual_consumption,
                0.00 ${sql.as} el_actual_demand
				FROM energy_chart_point
				WHERE ${sql.vpaRestriction} AND energy_chart_point.value_name = 'el_actual_consumption' AND energy_chart_point.bl_id IN 
									(SELECT bl_id FROM bl 
										WHERE ${parameters['locationField']} = ${parameters['locationValue']})
                  AND energy_chart_point.vn_id ${sql.concat} energy_chart_point.vn_ac_id 
                  IN (SELECT vn_id ${sql.concat} vn_ac_id FROM energy_bl_svc_period ebsp WHERE ebsp.vn_id = energy_chart_point.vn_id 
                  AND ebsp.vn_ac_id = energy_chart_point.vn_ac_id AND ebsp.time_period = energy_chart_point.time_period)
				GROUP BY energy_chart_point.time_period
                UNION ALL
				SELECT energy_chart_point.time_period, 0.00 ${sql.as} baseload, 0.00 ${sql.as} cdd, 0.00 ${sql.as} hdd, 
				0.00 ${sql.as} el_actual_consumption, MAX(energy_chart_point.value) ${sql.as} el_actual_demand
				FROM energy_chart_point
				WHERE ${sql.vpaRestriction} AND energy_chart_point.value_name = 'el_actual_demand' AND energy_chart_point.bl_id IN 
									(SELECT bl_id FROM bl 
										WHERE ${parameters['locationField']} = ${parameters['locationValue']})
                  AND energy_chart_point.vn_id ${sql.concat} energy_chart_point.vn_ac_id 
                  IN (SELECT vn_id ${sql.concat} vn_ac_id FROM energy_bl_svc_period ebsp WHERE ebsp.vn_id = energy_chart_point.vn_id 
                  AND ebsp.vn_ac_id = energy_chart_point.vn_ac_id AND ebsp.time_period = energy_chart_point.time_period)
                  GROUP BY energy_chart_point.time_period
        </sql> 
        
        <table name="energy_chart_point" role="main"/>
        <!--field name="bl_id" table="energy_chart_point"/-->
        <field name="time_period" table="energy_chart_point" groupBy="true"/>
		<field name="sum_weather_model_kw" table="energy_chart_point" dataType="number" size="12" decimals="2">
		<sql dialect="generic">SUM(energy_chart_point.baseload+energy_chart_point.cdd+energy_chart_point.hdd)
		</sql>
        </field>
        <field name="sum_weather_model" table="energy_chart_point" dataType="number" size="12" decimals="2">
		<sql dialect="generic">SUM(energy_chart_point.baseload+energy_chart_point.cdd+energy_chart_point.hdd) / ${parameters['unitsConversionFactor']}
		</sql>
        </field>
		<field name="sum_el_actual_consumption" table="energy_chart_point" dataType="number" size="12" decimals="2">
		<sql dialect="generic">SUM(el_actual_consumption) / ${parameters['unitsConversionFactor']}
		</sql>
        </field>
		<field name="sum_el_actual_demand" table="energy_chart_point" dataType="number" size="12" decimals="2">
		<sql dialect="generic">SUM(el_actual_demand)
		</sql>
        </field>        
        <sortField table="energy_chart_point" name="time_period" ascending="true"/>
    </dataSource>
    
    <panel type="grid" id="panel_elecConsumWeatherModelData" dataSource="ds_elecWeatherModelChart" hidden="true" showOnLoad="false" showCounts="true">
    	<title translatable="true">Electric Consumption with Model</title>
    	
	    <action id="exportXLS">
	      <title>XLS</title>
	      <command type="exportPanel" outputType="xls" panelId="panel_elecConsumWeatherModelData"/>
	    </action>
		
	    <action id="exportDOC">
	      <title translatable="true">DOC</title>
	      <command type="exportPanel" outputType="docx" panelId="panel_elecConsumWeatherModelData"/>
	    </action>		
	    
        <field name="time_period" table="energy_chart_point"/>
		<field name="sum_weather_model" table="energy_chart_point">
		<title translatable="true">Weather Model</title>
        </field>
		<field name="sum_el_actual_consumption" table="energy_chart_point">
            <title>Consumption (${view.dataSources.get('abEnergyBillCommon_ds').getRecord().getValue('bill_unit.vf_qty_energy_unit')})</title>
        </field>       
        <sortField table="energy_chart_point" name="time_period" ascending="true"/>   
        <indexField table="energy_chart_point" name="time_period"/>
    </panel>
    
    <panel type="grid" id="panel_elecDemandWeatherModelData" dataSource="ds_elecWeatherModelChart" hidden="true" showOnLoad="false" showCounts="true">
    	<title translatable="true">Electric Demand with Model</title>
    	
	    <action id="exportXLS">
	      <title translatable="true">XLS</title>
	      <command type="exportPanel" outputType="xls" panelId="panel_elecDemandWeatherModelData"/>
	    </action>

	    <action id="exportDOC">
	      <title translatable="true">DOC</title>
	      <command type="exportPanel" outputType="docx" panelId="panel_elecDemandWeatherModelData"/>
	    </action>		
	    
        <field name="time_period" table="energy_chart_point"/>
		<field name="sum_weather_model_kw" table="energy_chart_point">
		<title translatable="true">Weather Model</title>
        </field>
		<field name="sum_el_actual_demand" table="energy_chart_point">
		<title translatable="true">Demand (kW)</title>
        </field>        
        <sortField table="energy_chart_point" name="time_period" ascending="true"/>   
        <indexField table="energy_chart_point" name="time_period"/>
    </panel>     
    
    <dataSource id="ds_gasWeatherModelChart" type="grouping" applyVpaRestrictions="false">
    	<!-- Define parameters for the custom SQL query -->
    	<parameter name="locationField" dataType="verbatim" value="ctry_id"/>
        <parameter name="locationValue" dataType="text" value="USA"/>
        <parameter name="unitsConversionFactor" dataType="verbatim" value=""/>
            
        <!-- Define a custom SQL query that can be restricted by various location values -->
        <sql dialect="generic">SELECT energy_chart_point.time_period, MAX(energy_chart_point.value * weather_model.coefficient_base_load) ${sql.as} baseload, 0.00 ${sql.as} cdd, 0.00 ${sql.as} hdd, 
        			0.00 ${sql.as} gas_actual_consumption
				FROM energy_chart_point
					INNER JOIN weather_model
					ON (energy_chart_point.bl_id = weather_model.bl_id AND energy_chart_point.time_period = weather_model.time_period)
				WHERE ${sql.vpaRestriction} AND energy_chart_point.value_name = 'gas_num_days' AND weather_model.model_type = 'gas_natural_regression' AND energy_chart_point.bl_id IN 
					(SELECT bl_id FROM bl 
						WHERE ${parameters['locationField']} = ${parameters['locationValue']})
                   AND energy_chart_point.vn_id ${sql.concat} energy_chart_point.vn_ac_id 
                  IN (SELECT vn_id ${sql.concat} vn_ac_id FROM energy_bl_svc_period ebsp WHERE ebsp.vn_id = energy_chart_point.vn_id 
                  AND ebsp.vn_ac_id = energy_chart_point.vn_ac_id AND ebsp.time_period = energy_chart_point.time_period)
				GROUP BY energy_chart_point.time_period
				UNION ALL
				SELECT energy_chart_point.time_period, 0.00 ${sql.as} baseload, MAX(energy_chart_point.value * weather_model.coefficient_cdd) ${sql.as} cdd, 0.00 ${sql.as} hdd, 
				0.00 ${sql.as} gas_actual_consumption
				FROM energy_chart_point
					INNER JOIN weather_model
					ON (energy_chart_point.bl_id = weather_model.bl_id AND energy_chart_point.time_period = weather_model.time_period)
				WHERE ${sql.vpaRestriction} AND energy_chart_point.value_name = 'cdd' AND weather_model.model_type = 'gas_natural_regression' AND energy_chart_point.bl_id IN 
					(SELECT bl_id FROM bl 
						WHERE ${parameters['locationField']} = ${parameters['locationValue']})
				  AND energy_chart_point.vn_id ${sql.concat} energy_chart_point.vn_ac_id 
                  IN (SELECT vn_id ${sql.concat} vn_ac_id FROM energy_bl_svc_period ebsp WHERE ebsp.vn_id = energy_chart_point.vn_id 
                  AND ebsp.vn_ac_id = energy_chart_point.vn_ac_id AND ebsp.time_period = energy_chart_point.time_period)
                GROUP BY energy_chart_point.time_period
				UNION ALL
				SELECT energy_chart_point.time_period, 0.00 ${sql.as} baseload, 0.00 ${sql.as} cdd, MAX(energy_chart_point.value * weather_model.coefficient_hdd) ${sql.as} hdd, 
				0.00 ${sql.as} gas_actual_consumption
				FROM energy_chart_point
					INNER JOIN weather_model
					ON (energy_chart_point.bl_id = weather_model.bl_id AND energy_chart_point.time_period = weather_model.time_period)
				WHERE ${sql.vpaRestriction} AND energy_chart_point.value_name = 'hdd' AND weather_model.model_type = 'gas_natural_regression' AND energy_chart_point.bl_id IN 
					(SELECT bl_id FROM bl 
						WHERE ${parameters['locationField']} = ${parameters['locationValue']})
				   AND energy_chart_point.vn_id ${sql.concat} energy_chart_point.vn_ac_id 
                  IN (SELECT vn_id ${sql.concat} vn_ac_id FROM energy_bl_svc_period ebsp WHERE ebsp.vn_id = energy_chart_point.vn_id 
                  AND ebsp.vn_ac_id = energy_chart_point.vn_ac_id AND ebsp.time_period = energy_chart_point.time_period)
                GROUP BY energy_chart_point.time_period
				UNION ALL
				SELECT energy_chart_point.time_period, 0.00 ${sql.as} baseload, 0.00 ${sql.as} cdd, 0.00 ${sql.as} hdd, 
				SUM(energy_chart_point.value) ${sql.as} gas_actual_consumption
				FROM energy_chart_point
				WHERE ${sql.vpaRestriction} AND energy_chart_point.value_name = 'gas_actual_consumption' AND energy_chart_point.bl_id IN 
									(SELECT bl_id FROM bl 
										WHERE ${parameters['locationField']} = ${parameters['locationValue']})
                  AND energy_chart_point.vn_id ${sql.concat} energy_chart_point.vn_ac_id 
                  IN (SELECT vn_id ${sql.concat} vn_ac_id FROM energy_bl_svc_period ebsp WHERE ebsp.vn_id = energy_chart_point.vn_id 
                  AND ebsp.vn_ac_id = energy_chart_point.vn_ac_id AND ebsp.time_period = energy_chart_point.time_period)
                  GROUP BY energy_chart_point.time_period
        </sql> 
        
        <table name="energy_chart_point" role="main"/>
        <field name="time_period" table="energy_chart_point" groupBy="true"/>
		<field name="sum_weather_model" table="energy_chart_point" dataType="number" size="12" decimals="2">
		<sql dialect="generic">
			CASE WHEN SUM(energy_chart_point.baseload+energy_chart_point.cdd+energy_chart_point.hdd) &lt; 0 THEN 0
			ELSE SUM(energy_chart_point.baseload+energy_chart_point.cdd+energy_chart_point.hdd) / ${parameters['unitsConversionFactor']} END
		</sql>
        </field>
		<field name="sum_gas_actual_consumption" table="energy_chart_point" dataType="number" size="12" decimals="2">
		<sql dialect="generic">
			CASE WHEN SUM(gas_actual_consumption) &lt; 0 THEN 0
			ELSE SUM(gas_actual_consumption)  / ${parameters['unitsConversionFactor']} END
		</sql>
        </field>        
        <sortField table="energy_chart_point" name="time_period" ascending="true"/>
    </dataSource>    
    
    <panel type="grid" id="panel_gasWeatherModelData" dataSource="ds_gasWeatherModelChart" hidden="true" showOnLoad="false" showCounts="true">
	<title translatable="true">Gas Consumption with Model</title>
    	
	    <action id="exportXLS">
	      <title translatable="true">XLS</title>
	      <command type="exportPanel" outputType="xls" panelId="panel_gasWeatherModelData"/>
	    </action>
		
	    <action id="exportDOC">
	      <title translatable="true">DOC</title>
	      <command type="exportPanel" outputType="docx" panelId="panel_gasWeatherModelData"/>
	    </action>			
	    
        <field name="time_period" table="energy_chart_point"/>
		<field name="sum_weather_model" table="energy_chart_point">
		<title translatable="true">Weather Model</title>
        </field>
		<field name="sum_gas_actual_consumption" table="energy_chart_point">
		<title translatable="true">Consumption (${view.dataSources.get('abEnergyBillCommon_ds').getRecord().getValue('bill_unit.vf_qty_energy_unit')})</title>
        </field>
        <sortField table="energy_chart_point" name="time_period" ascending="true"/>   
        <indexField table="energy_chart_point" name="time_period"/>
    </panel>
    
    <!-- Chart tabs -->
	<tabs workflow="free" id="tabs" layout="nestedLayout" region="center" tabRefreshPolicy="never">
		<tab name="totalCostTypeChart" selected="true" useFrame="false"> 
			<title translatable="true">Utility Cost by Type</title>
			    <panel id="panel_totalCostTypeChart" type="chart" controlType="pieChart" dataSource="ds_totalCostTypeChart" showLegendAsPopUp="false">
				<title translatable="true">Utility Cost by Type</title>
				<action id="data">
				    <title translatable="true">Data</title>
				    <command type="openDialog" panelId="panel_totalCostTypeData"/>
				</action>				
				<action id="exportDOC">
				    <title translatable="true">DOC</title>
				    <command type="exportPanel" outputType="docx" panelId="panel_totalCostTypeChart"/>
    			</action>
    			<action id="panel_totalCostTypeChart_refresh">
				    <title translatable="true">Refresh</title>
				    <command type="showPanel" panelId="panel_totalCostTypeChart"/>
				</action>
				
				 <event type="onClickItem">
				    <command type="openDialog" panelId="panel_totalCostTypeData"/>
				 </event>
				 
				<groupingAxis table="bill_archive" field="bill_type_id" showLabel="true"> 
				    <title translatable="true"></title> 
				</groupingAxis>
				<dataAxis table="bill_archive" field="total_amount_expense" displayAxis="true" showLabel="true" labelPosition="callout"> 
				    <title translatable="true"></title> 
				</dataAxis>
			    </panel>
		</tab>	
		<tab name="totalCostConsumpChart" selected="false" useFrame="false"> 
			<title translatable="true">Utility Cost with Consumption</title>
			    <panel id="panel_totalCostConsumpChart" type="chart" controlType="columnChart" dataSource="ds_totalCostConsumpChart" showLegendAsPopUp="false">
				<title translatable="true">Utility Cost with Consumption</title>
				<action id="data">
				    <title translatable="true">Data</title>
				    <command type="openDialog" panelId="panel_totalCostConsumpData"/>
				</action>				
				<action id="exportDOC">
				    <title translatable="true">DOC</title>
				    <command type="exportPanel" outputType="docx" panelId="panel_totalCostConsumpChart"/>
    			</action>				
				<action id="panel_totalCostConsumpChart_refresh">
				    <title translatable="true">Refresh</title>
				    <command type="showPanel" panelId="panel_totalCostConsumpChart"/>
				</action>

				 <event type="onClickItem">
				    <command type="openDialog" panelId="panel_totalCostConsumpData"/>
				 </event>
				
				<groupingAxis table="bill_archive" field="time_period" labelRotation="45">
				    <title translatable="true">Billing Period</title>
				</groupingAxis>
				<dataAxis  table="bill_archive" field="total_amount_expense" displayAxis="true" showLabel="true" labelPosition="inside">
				    <title translatable="true">Cost (Sum)</title>
				</dataAxis>
				<dataAxis  table="bill_archive" field="total_qty_energy" displayAxis="true" showLabel="true" labelPosition="inside">
                    <title>Consumption (${view.dataSources.get('abEnergyBillCommon_ds').getRecord().getValue('bill_unit.vf_qty_energy_unit')}) (SUM)</title>
				</dataAxis>				
			    </panel>
		</tab>
		<tab name="elecCostRateChart" selected="false" useFrame="false"> 
			<title translatable="true">Electric Cost with Rate</title>
			    <panel id="panel_elecCostRateChart" type="chart" controlType="columnChart" dataSource="ds_elecCostRateChart" showLegendAsPopUp="false">
				<title translatable="true">Electric Cost with Rate</title>
				<action id="data">
				    <title translatable="true">Data</title>
				    <command type="openDialog" panelId="panel_elecCostRateData"/>
				</action>				
				<action id="exportDOC">
				    <title translatable="true">DOC</title>
				    <command type="exportPanel" outputType="docx" panelId="panel_elecCostRateChart"/>
    			</action>				
				<action id="panel_elecCostRateChart_refresh">
				    <title translatable="true">Refresh</title>
				    <command type="showPanel" panelId="panel_elecCostRateChart"/>
				</action>

				 <event type="onClickItem">
				    <command type="openDialog" panelId="panel_elecCostRateData"/>
				 </event>
				 
				<groupingAxis table="bill_archive" field="time_period" labelRotation="45">
				    <title translatable="true">Billing Period</title>
				</groupingAxis>
				<dataAxis  table="bill_archive" field="total_amount_expense" displayAxis="true" showLabel="true" labelPosition="inside">
				    <title translatable="true">Cost (Sum)</title>
				</dataAxis>
				<dataAxis  table="bill_archive" field="total_cost_kwh" displayAxis="true" showLabel="true" labelPosition="inside">
				   <title translatable="true">Rate (Cost/kWh) (Sum)</title>
				</dataAxis>				
			    </panel>
		</tab>	    
		<tab name="gasCostRateChart" selected="false" useFrame="false"> 
			<title translatable="true">Gas Cost with Rate</title>
			    <panel id="panel_gasCostRateChart" type="chart" controlType="columnChart" dataSource="ds_gasCostRateChart" showLegendAsPopUp="false">
				<title translatable="true">Gas Cost with Rate</title>
				<action id="data">
				    <title translatable="true">Data</title>
				    <command type="openDialog" panelId="panel_gasCostRateData"/>
				</action>				
				<action id="exportDOC">
				    <title translatable="true">DOC</title>
				    <command type="exportPanel" outputType="docx" panelId="panel_gasCostRateChart"/>
    			</action>				
				<action id="panel_gasCostRateChart_refresh">
				    <title translatable="true">Refresh</title>
				    <command type="showPanel" panelId="panel_gasCostRateChart"/>
				</action>
				
				 <event type="onClickItem">
				    <command type="openDialog" panelId="panel_gasCostRateData"/>
				 </event>
				 
				<groupingAxis table="bill_archive" field="time_period" labelRotation="45">
				    <title translatable="true">Billing Period</title>
				</groupingAxis>
				<dataAxis  table="bill_archive" field="total_amount_expense" displayAxis="true" showLabel="true" labelPosition="inside">
				    <title translatable="true">Cost (Sum)</title>
				</dataAxis>
				<dataAxis  table="bill_archive" field="total_cost_mmbtu" displayAxis="true" showLabel="true" labelPosition="inside">
				   <title translatable="true">Rate (Cost/${view.dataSources.get('abEnergyBillCommon_ds').getRecord().getValue('bill_unit.vf_qty_energy_unit')}) (Sum)</title>
				</dataAxis>				
			    </panel>
		</tab>
		<tab name="elecLoadFactorChart" selected="false" useFrame="false"> 
			<title translatable="true">Electric Load Factor</title>
			    <panel type="chart" id="panel_elecLoadFactorChart" controlType="columnChart" dataSource="ds_elecLoadFactorChart" showLegendAsPopUp="false">
				<title translatable="true">Electric Load Factor</title>			
				<action id="data">
				    <title translatable="true">Data</title>
				    <command type="openDialog" panelId="panel_elecLoadFactorData"/>
				</action>				
				<action id="exportDOC">
				    <title translatable="true">DOC</title>
				    <command type="exportPanel" outputType="docx" panelId="panel_elecLoadFactorChart"/>
    			</action>				
				<action id="panel_elecLoadFactorChart_refresh">
				    <title translatable="true">Refresh</title>
				    <command type="showPanel" panelId="panel_elecLoadFactorChart"/>
				</action>
				
				<event type="onClickItem">
				    <command type="openDialog" panelId="panel_elecLoadFactorData"/>
				</event>
				
				<groupingAxis table="bill_archive" field="time_period" labelRotation="45"> 
				    <title translatable="true">Billing Period</title> 
				</groupingAxis>
				<dataAxis table="bill_archive" field="sum_el_load_factor" displayAxis="true" showLabel="true" labelPosition="inside"> 
				    <title translatable="true">Load Factor % (avg demand / peak demand)</title> 
				</dataAxis>
			    </panel>
		</tab>
		<tab name="elecConsumWeatherModelChart" selected="false" useFrame="false"> 
			<title translatable="true">Electric Consumption with Model</title>
			    <panel type="chart" id="panel_elecConsumWeatherModelChart" controlType="columnChart" dataSource="ds_elecWeatherModelChart" showLegendAsPopUp="false">
				<title translatable="true">Electric Consumption with Model</title>
				<action id="data">
				    <title translatable="true">Data</title>
				    <command type="openDialog" panelId="panel_elecConsumWeatherModelData" width="600" height="400"/>
				</action>				
				<action id="exportDOC">
				    <title translatable="true">DOC</title>
				    <command type="exportPanel" outputType="docx" panelId="panel_elecConsumWeatherModelChart"/>
    			</action>				
				<action id="panel_elecConsumWeatherModelChart_refresh">
				    <title translatable="true">Refresh</title>
				    <command type="showPanel" panelId="panel_elecConsumWeatherModelChart"/>
				</action>
				
				<event type="onClickItem">
				    <command type="openDialog" panelId="panel_elecConsumWeatherModelData" width="600" height="400"/>
				</event>
				
				<groupingAxis table="energy_chart_point" field="time_period" showLabel="true" labelRotation="45">
					<title translatable="true">Billing Period</title>
				</groupingAxis>

				<dataAxis table="energy_chart_point" field="sum_weather_model" showLabel="true" labelPosition="inside" >
					<title translatable="true">Weather Model (Sum)</title>
				</dataAxis> 
				<dataAxis table="energy_chart_point" field="sum_el_actual_consumption" showLabel="true" labelPosition="inside" >
					<title translatable="true">Consumption (${view.dataSources.get('abEnergyBillCommon_ds').getRecord().getValue('bill_unit.vf_qty_energy_unit')}) (Sum)</title>
				</dataAxis>		
			    </panel>
		</tab>
		<tab name="elecDemandWeatherModelChart" selected="false" useFrame="false"> 
			<title translatable="true">Electric Demand with Model</title>
			    <panel type="chart" id="panel_elecDemandWeatherModelChart" controlType="columnChart" dataSource="ds_elecWeatherModelChart" showLegendAsPopUp="false">
				<title translatable="true">Electric Demand with Model</title>
				<action id="data">
				    <title translatable="true">Data</title>
				    <command type="openDialog" panelId="panel_elecDemandWeatherModelData" width="600" height="400"/>
				</action>				
				<action id="exportDOC">
				    <title translatable="true">DOC</title>
				    <command type="exportPanel" outputType="docx" panelId="panel_elecDemandWeatherModelChart"/>
    			</action>				
				<action id="panel_elecDemandWeatherModelChart_refresh">
				    <title translatable="true">Refresh</title>
				    <command type="showPanel" panelId="panel_elecDemandWeatherModelChart"/>
				</action>
				
				<event type="onClickItem">
				    <command type="openDialog" panelId="panel_elecDemandWeatherModelData" width="600" height="400"/>
				</event>
				
				<groupingAxis table="energy_chart_point" field="time_period" showLabel="true" labelRotation="45">
					<title translatable="true">Billing Period</title>
				</groupingAxis>
				<dataAxis table="energy_chart_point" field="sum_weather_model_kw" showLabel="true" labelPosition="inside" >
					<title translatable="true">Weather Model (Sum)</title>
				</dataAxis> 
				<dataAxis table="energy_chart_point" field="sum_el_actual_demand" showLabel="true" labelPosition="inside" >
					<title translatable="true">Demand (kW) (Sum)</title>
				</dataAxis>				
			    </panel>
		</tab>		
		<tab name="gasWeatherModelChart" selected="false" useFrame="false"> 
			<title translatable="true">Gas Consumption with Model</title>
			    <panel type="chart" id="panel_gasWeatherModelChart" controlType="columnChart" dataSource="ds_gasWeatherModelChart" showLegendAsPopUp="false">
				<title translatable="true">Gas Consumption with Model</title>
				<action id="data">
				    <title translatable="true">Data</title>
				    <command type="openDialog" panelId="panel_gasWeatherModelData" width="600" height="400"/>
				</action>				
				<action id="exportDOC">
				    <title  translatable="true">DOC</title>
				    <command type="exportPanel" outputType="docx" panelId="panel_gasWeatherModelChart"/>
    			</action>				
				<action id="panel_gasWeatherModelChart_refresh">
				    <title translatable="true">Refresh</title>
				    <command type="showPanel" panelId="panel_gasWeatherModelChart"/>
				</action>
				
				<event type="onClickItem">
				    <command type="openDialog" panelId="panel_gasWeatherModelData" width="600" height="400"/>
				</event>
				
				<groupingAxis table="energy_chart_point" field="time_period" showLabel="true" labelRotation="45">
					<title translatable="true">Billing Period</title>
				</groupingAxis>
				<dataAxis table="energy_chart_point" field="sum_weather_model" showLabel="true" labelPosition="inside">
					<title translatable="true">Weather Model (Sum)</title>
				</dataAxis>
				<dataAxis table="energy_chart_point" field="sum_gas_actual_consumption" showLabel="true" labelPosition="inside">
					<title translatable="true">Consumption (${view.dataSources.get('abEnergyBillCommon_ds').getRecord().getValue('bill_unit.vf_qty_energy_unit')}) (Sum)</title>
				</dataAxis>				
			    </panel>
		</tab>		
	</tabs>
    
</view>
