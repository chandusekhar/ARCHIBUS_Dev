<view version="2.0">
	<js file="ab-helpdesk-request-close-select-closed.js" />
        <js file="ab-helpdesk-request-shared-para.js" />
	
	<message name="error_date_range" translatable="true">Given dates are invalid.</message>
	<message name="selectTitle" translatable="true">-select-</message>
	<message name="requestType" translatable="true">Service Desk Request Type</message>

	<!-- 
		@summary
		Assignee - Close request - Closed requests<br>
		This view allows the user to:
		<ul>
		<li>View a list of requests closed by himself</li>
		<li>Filter the list on request type and date completed</li>
		<li>Select a request to view details and archive it</li>
		</ul>
		
		@console
		Console restriction on :
		<ul>
		<li>activity_type : request type</li>
		<li>date_completed : start and end of the date the request was closed</li>
		</ul>
	-->

	<dataSource id="consoleDS">
		<table name="activity_log" role="main" />

		<field table="activity_log" name="activity_log_id" />
		<field table="activity_log" name="date_closed" />
		<field table="activity_log" name="activity_type"
			required="false" />

		<sortField table="activity_log" name="date_completed"
			ascending="false" />
	</dataSource>

	<panel type="console" columns="3" labelsPosition="top"
		id="requestConsole" dataSource="consoleDS">
		<title translatable="true">Filter</title>
		<action id="filter">
			<title translatable="true">Show</title>
		</action>

		<action id="clear">
			<title translatable="true">Clear</title>
		</action>

		<field table="activity_log" name="activity_type" value=""
			required="false">
			<title translatable="true">Request Type</title>
			<action>
				<title>...</title>
				<command type="callFunction"
					functionName="onSelectActivityType('activity_log','requestConsole')" />
			</action>
		</field>
		
		
		<field table="activity_log" name="date_closed"
			alias="activity_log.date_closed.from">
			<title translatable="true">Date Closed From</title>
		</field>
		<field table="activity_log" name="date_closed"
			alias="activity_log.date_closed.to">
			<title translatable="true">Date Closed To</title>
		</field>
	</panel>

	<dataSource id="reportGridDS">
		<table name="activity_log" role="main" />

		<field table="activity_log" name="activity_log_id" />
		<field table="activity_log" name="requestor" />
		<field table="activity_log" name="date_closed" />
		<field table="activity_log" name="activity_type" />
		<field table="activity_log" name="created_by" />
		<field table="activity_log" name="status" />
        <parameter name="emWorkflowSubstitutes" dataType="verbatim" value="''"/>
		<restriction type="sql"
			sql="activity_type LIKE 'SERVICE DESK%' AND activity_type != 'SERVICE DESK - MAINTENANCE' 
					AND status IN ('CLOSED','REJECTED','CANCELLED') 
                    AND (manager = ${sql.literal(user.employee.id)}
                       OR manager${sql.concat}'manager' IN (${parameters['emWorkflowSubstitutes']}))" />
	</dataSource>

	<panel type="grid" id="requestReportGrid" controlType="reportGrid"
		multipleSelectionEnabled="true" useParentRestriction="false"
		dataSource="reportGridDS">
		<title translatable="true">
			Closed and Cancelled Requests
		</title>
			<sortField table="activity_log" name="date_closed"
			ascending="false" />
		<action id="archive">
			<title translatable="true">Archive Selected</title>
		</action>
		<field controlType="button">
			<title translatable="true">Select</title>
			<command type="selectTabPage" tabPageName="details" />
		</field>
		<field table="activity_log" name="activity_log_id">
			<title translatable="true">Service Request ID</title>
		</field>
		<field table="activity_log" name="requestor" />
		<field table="activity_log" name="created_by" />
		<field table="activity_log" name="activity_type">
			<title translatable="true">Request Type</title>
		</field>
		<field table="activity_log" name="status" />
		<field table="activity_log" name="date_closed" />
	</panel>

</view>